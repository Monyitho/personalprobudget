<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-title" content="Budget Pro">
<meta name="theme-color" content="#2c3e50">
<meta name="description" content="Gestisci il tuo budget personale in modo semplice ed efficace">
<title>Budget Manager Pro v2.2 - Optimized</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#f5f6fa;
  --card:#fff;
  --text:#2c3e50;
  --header:#2c3e50;
  --border:#ddd;
  --success:#27ae60;
  --danger:#e74c3c;
  --warning:#f39c12;
  --expense:#e67e22;
  --income:#27ae60;
}
body.dark{
  --bg:#1a1a2e;
  --card:#16213e;
  --text:#eee;
  --header:#0f3460;
  --border:#2d4059;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding-bottom:calc(75px + env(safe-area-inset-bottom));
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
  min-height:100vh;
  touch-action:pan-y;
}
.header{
  background:var(--header);
  color:#fff;
  padding:max(env(safe-area-inset-top),20px) 15px 15px 15px;
  position:sticky;
  top:0;
  z-index:100;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.header h1{font-size:1.4em;margin-bottom:12px;font-weight:700}
.hdr-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.theme-btn{
  background:rgba(255,255,255,0.2);
  border:none;
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
  font-size:1.3em;
  cursor:pointer;
  transition:all 0.3s;
}
.theme-btn:active{transform:scale(0.95);background:rgba(255,255,255,0.3)}
.controls{display:flex;gap:10px;align-items:center}
.period-selector{
  background:rgba(255,255,255,0.2);
  border:none;
  color:#fff;
  padding:10px 16px;
  border-radius:10px;
  font-size:1em;
  cursor:pointer;
  font-weight:600;
  white-space:nowrap;
  transition:all 0.3s
}
.period-selector:hover{
  background:rgba(255,255,255,0.3);
  transform:translateY(-2px)
}
.month-btn{
  background:var(--bg);
  border:2px solid var(--border);
  color:var(--text);
  padding:12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  font-size:0.9em;
  transition:all 0.3s
}
.month-btn:hover{
  background:var(--income);
  color:#fff;
  border-color:var(--income);
  transform:scale(1.05)
}
.month-btn.selected{
  background:var(--income);
  color:#fff;
  border-color:var(--income);
  box-shadow:0 4px 12px rgba(39,174,96,0.3)
}
.controls select{
  padding:12px;
  border-radius:10px;
  flex:1;
  font-size:1em;
  background:var(--card);
  color:var(--text);
  border:2px solid var(--border);
  font-weight:600;
  -webkit-appearance:none;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 10px center;
  padding-right:35px;
}
.container{
  padding-left:max(env(safe-area-inset-left),15px);
  padding-right:max(env(safe-area-inset-right),15px);
  padding-top:15px;
  padding-bottom:calc(80px + max(env(safe-area-inset-bottom),20px));
  overflow-x:hidden;
  min-height:100vh;
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  margin-bottom:15px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
.patrimonio{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:#fff;
  text-align:center;
  padding:30px 20px;
}
.big{font-size:2.8em;font-weight:800;margin:12px 0;letter-spacing:-1px}
.patrimonio-label{font-size:0.95em;opacity:0.9;font-weight:500}
.metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:15px}
.metric{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  text-align:center;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
}
.metric h4{font-size:0.8em;margin-bottom:10px;opacity:0.7;font-weight:600}
.metric .val{font-size:1.6em;font-weight:700}
.metric-full{grid-column:1 / -1}
.top-expense{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
  border-left:5px solid var(--expense);
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.top-expense .info{flex:1;padding-right:10px}
.top-expense .name{font-weight:700;font-size:1.05em;margin-bottom:6px}
.top-expense .amount{font-size:1.4em;font-weight:800;color:var(--expense);white-space:nowrap}
.top-expense .percent{font-size:0.85em;color:#7f8c8d;margin-top:4px}
.progress-bar{
  background:#ecf0f1;
  height:10px;
  border-radius:5px;
  overflow:hidden;
  margin-top:10px;
}
.progress-fill{
  background:var(--expense);
  height:100%;
  transition:width 0.5s ease;
}
.alert-badge{
  background:var(--danger);
  color:#fff;
  padding:5px 10px;
  border-radius:15px;
  font-size:0.75em;
  font-weight:700;
  margin-left:8px;
}
.btn{
  border:none;
  padding:16px 20px;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  font-weight:700;
  width:100%;
  background:var(--success);
  color:#fff;
  margin-bottom:12px;
  transition:all 0.2s;
  box-shadow:0 4px 12px rgba(39,174,96,0.3);
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
  min-height:48px;
}
.btn:active{transform:translateY(2px);box-shadow:0 2px 6px rgba(39,174,96,0.3)}
.btn-danger{background:var(--danger);padding:12px;font-size:0.95em;box-shadow:0 4px 12px rgba(231,76,60,0.3)}
.btn-edit{background:#3498db;padding:12px;font-size:0.95em;box-shadow:0 4px 12px rgba(52,152,219,0.3)}
.btn-warning{background:var(--warning);box-shadow:0 4px 12px rgba(243,156,18,0.3)}
.section{
  display:none;
  animation:slideIn 0.3s ease-out;
  padding-bottom:30px;
}
.section.active{display:block}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.info-box{
  background:linear-gradient(135deg,#e8f4f8,#d4e9f2);
  border-left:5px solid #3498db;
  padding:14px;
  border-radius:12px;
  margin-bottom:15px;
  font-size:0.95em;
  box-shadow:0 2px 6px rgba(52,152,219,0.15);
}
body.dark .info-box{background:linear-gradient(135deg,#1e3a5f,#2c5282);color:#a8d8ea}
.filters{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  margin-bottom:15px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
}
.filter-row{display:flex;gap:10px;margin-bottom:10px}
.filter-row input,.filter-row select{
  flex:1;
  padding:12px;
  border:2px solid var(--border);
  border-radius:10px;
  background:var(--bg);
  color:var(--text);
  font-size:1em;
}

/* FILTRI MODERNI */
.filter-section-modern{
  background:linear-gradient(135deg, rgba(102,126,234,0.06), rgba(118,75,162,0.06));
  padding:16px;
  border-radius:12px;
  margin-bottom:12px;
  border:2px solid rgba(102,126,234,0.12);
}
body.dark .filter-section-modern{
  background:linear-gradient(135deg, rgba(102,126,234,0.12), rgba(118,75,162,0.12));
  border-color:rgba(102,126,234,0.2);
}
.filter-label-modern{
  display:block;
  font-weight:700;
  font-size:0.9em;
  color:var(--text);
  margin-bottom:12px;
  opacity:0.9;
}
.filter-row-modern{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.select-modern{
  padding:12px 14px;
  border:2px solid var(--border);
  border-radius:10px;
  background:var(--card);
  color:var(--text);
  font-size:0.95em;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%23667eea' d='M7 10L2 5h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 10px center;
  padding-right:35px;
}
.select-modern:focus{
  outline:none;
  border-color:#667eea;
  box-shadow:0 0 0 3px rgba(102,126,234,0.15);
  transform:translateY(-1px);
}

/* Ottimizzazioni iPhone */
@media(max-width:400px){
  .filter-row-modern{
    gap:8px;
  }
  .select-modern{
    font-size:0.85em;
    padding:10px 12px;
    padding-right:30px;
  }
  .filter-label-modern{
    font-size:0.85em;
  }
  .checkbox-text-modern{
    font-size:0.85em;
  }
}
@media(max-width:380px){
  .select-modern{
    font-size:0.8em;
    padding:9px 10px;
    padding-right:28px;
  }
}

/* CHECKBOX MODERNO */
.checkbox-modern{
  position:relative;
}
.checkbox-input-modern{
  position:absolute;
  opacity:0;
  cursor:pointer;
}
.checkbox-label-modern{
  display:flex;
  align-items:center;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
}
.checkbox-box-modern{
  position:relative;
  width:22px;
  height:22px;
  border:2px solid var(--border);
  border-radius:6px;
  background:var(--card);
  margin-right:12px;
  transition:all 0.3s;
  flex-shrink:0;
}
.checkbox-box-modern::after{
  content:'‚úì';
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%) scale(0);
  color:#fff;
  font-weight:900;
  font-size:14px;
  transition:transform 0.2s ease;
}
.checkbox-input-modern:checked + .checkbox-label-modern .checkbox-box-modern{
  background:linear-gradient(135deg, #667eea, #764ba2);
  border-color:#667eea;
}
.checkbox-input-modern:checked + .checkbox-label-modern .checkbox-box-modern::after{
  transform:translate(-50%, -50%) scale(1);
}
.checkbox-label-modern:hover .checkbox-box-modern{
  border-color:#667eea;
  transform:scale(1.05);
}
.checkbox-text-modern{
  font-weight:600;
  font-size:0.95em;
  color:var(--text);
  line-height:1.4;
}
.checkbox-text-short{
  display:none;
}

/* Responsive filtri per iPhone */
@media(max-width:400px){
  .filter-row-modern{
    gap:8px;
  }
  .select-modern{
    font-size:0.85em;
    padding:10px 12px;
    padding-right:30px;
  }
  .filter-label-modern{
    font-size:0.85em;
  }
  .checkbox-text-modern{
    font-size:0.85em;
  }
  .checkbox-text-full{
    display:none;
  }
  .checkbox-text-short{
    display:inline;
  }
}
@media(max-width:380px){
  .select-modern{
    font-size:0.8em;
    padding:9px 10px;
    padding-right:28px;
  }
  .checkbox-box-modern{
    width:20px;
    height:20px;
  }
  .filter-section-modern{
    padding:14px;
  }
}

.trans-item{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  margin-bottom:14px;
  border-left:5px solid var(--expense);
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  position:relative;
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
  touch-action:pan-y;
}
.trans-item.swiping{
  transform:translateX(var(--swipe-offset));
  transition:none;
}
.trans-item.swipe-delete{
  transform:translateX(-100%);
  opacity:0;
}
.trans-item::after{
  content:'üóëÔ∏è Elimina';
  position:absolute;
  right:0;
  top:0;
  bottom:0;
  background:linear-gradient(90deg,transparent,#e74c3c);
  color:#fff;
  display:flex;
  align-items:center;
  padding:0 20px;
  font-weight:700;
  opacity:0;
  transition:opacity 0.2s;
  pointer-events:none;
  z-index:-1;
  border-radius:0 12px 12px 0;
}
.trans-item.show-delete::after{
  opacity:1;
}
.trans-item.income{border-left-color:var(--income)}
.trans-header{display:flex;justify-content:space-between;margin-bottom:12px;align-items:center}
.trans-amount{font-size:1.4em;font-weight:800;white-space:nowrap}
.trans-details{font-size:0.9em;color:#7f8c8d;margin-bottom:12px;line-height:1.5}
.trans-actions{display:flex;gap:8px}
.trans-actions button{
  flex:1;
  padding:12px;
  border-radius:10px;
  border:none;
  font-weight:700;
  cursor:pointer;
  font-size:0.95em;
  transition:all 0.3s;
}
.trans-actions button:active{transform:scale(0.95)}
.analysis-card{
  background:var(--card);
  border-radius:12px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
  border-left:5px solid var(--expense);
}
.analysis-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.analysis-header h4{font-size:1.05em;font-weight:700}
.analysis-value{font-size:2em;font-weight:800;color:var(--expense);margin-bottom:8px}
.comparison{font-size:0.9em;color:#7f8c8d;margin-top:6px;line-height:1.4}
.cat-item{
  background:var(--card);
  padding:14px;
  border-radius:10px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.cat-item.income{background:#d5f4e6;border-left:5px solid var(--income)}
.cat-item.expense{background:#fadbd8;border-left:5px solid var(--danger)}
body.dark .cat-item.income{background:#1a4d2e}
body.dark .cat-item.expense{background:#5c2e2e}
.cat-actions{display:flex;gap:6px}
.nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--header);
  display:flex;
  justify-content:flex-start;
  padding:10px 16px max(env(safe-area-inset-bottom, 10px), 10px) 16px;
  z-index:100;
  box-shadow:0 -2px 15px rgba(0,0,0,0.15);
  overflow-x:auto;
  overflow-y:hidden;
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
  gap:8px;
  scrollbar-width:none;
}
.nav::-webkit-scrollbar{height:0;display:none}
.nav-item{
  color:#fff;
  text-align:center;
  padding:10px 12px;
  cursor:pointer;
  transition:all 0.2s;
  border-radius:12px;
  font-size:0.75em;
  font-weight:600;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-width:70px;
  flex-shrink:0;
  white-space:nowrap;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.nav-item.active{background:var(--warning);transform:translateY(-2px);box-shadow:0 2px 8px rgba(243,156,18,0.4)}
.nav-icon{font-size:2em;line-height:1;margin-bottom:4px}
.modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.85);
  z-index:1000;
  padding:15px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  backdrop-filter:blur(5px);
}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{
  background:var(--card);
  border-radius:20px;
  padding:20px;
  width:100%;
  max-width:500px;
  max-height:90vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  animation:modalSlideUp 0.3s ease-out;
}
@keyframes modalSlideUp{
  from{transform:translateY(30px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.modal-header{display:flex;justify-content:space-between;margin-bottom:20px;align-items:center}
.modal-header h3{font-size:1.3em;font-weight:700}

/* MODAL CONFERMA PERSONALIZZATO */
.confirm-modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.9);
  z-index:10000;
  padding:15px;
  overflow-y:auto;
  backdrop-filter:blur(8px);
  animation:fadeIn 0.2s ease-out;
}
.confirm-modal.active{display:flex;align-items:center;justify-content:center}
.confirm-content{
  background:var(--card);
  border-radius:20px;
  padding:30px 25px;
  width:100%;
  max-width:420px;
  box-shadow:0 20px 60px rgba(0,0,0,0.4);
  animation:confirmPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  text-align:center;
}
@keyframes confirmPop{
  from{transform:scale(0.8);opacity:0}
  to{transform:scale(1);opacity:1}
}
@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}
.confirm-icon{
  font-size:4em;
  margin-bottom:15px;
  animation:iconBounce 0.6s ease-out;
}
@keyframes iconBounce{
  0%{transform:scale(0)}
  50%{transform:scale(1.2)}
  100%{transform:scale(1)}
}
.confirm-title{
  font-size:1.4em;
  font-weight:800;
  margin-bottom:12px;
  color:var(--text);
}
.confirm-message{
  font-size:1em;
  color:#7f8c8d;
  margin-bottom:25px;
  line-height:1.5;
}
.confirm-buttons{
  display:flex;
  gap:12px;
  margin-top:20px;
}
.confirm-btn{
  flex:1;
  padding:16px 20px;
  border:none;
  border-radius:12px;
  font-size:1em;
  font-weight:700;
  cursor:pointer;
  transition:all 0.2s;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
}
.confirm-btn-cancel{
  background:var(--bg);
  color:var(--text);
  border:2px solid var(--border);
}
.confirm-btn-cancel:active{transform:scale(0.95)}
.confirm-btn-confirm{
  background:var(--danger);
  color:#fff;
  box-shadow:0 4px 12px rgba(231,76,60,0.3);
}
.confirm-btn-confirm:active{transform:scale(0.95);box-shadow:0 2px 6px rgba(231,76,60,0.3)}
.confirm-btn-primary{
  background:var(--success);
  color:#fff;
  box-shadow:0 4px 12px rgba(39,174,96,0.3);
}
.confirm-btn-primary:active{transform:scale(0.95);box-shadow:0 2px 6px rgba(39,174,96,0.3)}

.close-btn{
  background:none;
  border:none;
  font-size:2em;
  cursor:pointer;
  color:#999;
  padding:0;
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.form-group{margin-bottom:16px}
.form-group label{
  display:block;
  margin-bottom:8px;
  font-weight:700;
  font-size:0.95em;
  color:var(--text);
}
.form-group input,.form-group select,.form-group textarea{
  width:100%;
  padding:14px;
  border:2px solid var(--border);
  border-radius:10px;
  font-size:16px;
  background:var(--bg);
  color:var(--text);
  font-family:inherit;
  -webkit-appearance:none;
  appearance:none;
  touch-action:manipulation;
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  outline:none;
  border-color:#3498db;
}
.empty{
  text-align:center;
  padding:50px 20px;
  color:#95a5a6;
  font-size:1.1em;
}
canvas{max-width:100%;height:auto!important}
table{width:100%;border-collapse:collapse;font-size:0.75em}
th{
  background:#3498db;
  color:#fff;
  padding:10px 6px;
  text-align:center;
  font-weight:700;
  position:sticky;
  top:0;
  z-index:10;
}
th.expense{background:var(--expense)}
td{padding:10px 6px;text-align:center;border-bottom:1px solid var(--border)}
td:first-child{text-align:left;font-weight:600}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.stats{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
  font-size:0.95em;
}
.stats div{
  background:var(--bg);
  padding:12px;
  border-radius:10px;
  text-align:center;
}
.stats .label{opacity:0.7;font-size:0.85em;margin-bottom:6px}
.stats .value{font-size:1.3em;font-weight:800}

/* CALENDAR HEATMAP COMPATTO - DESIGN CHIARO E FUNZIONALE */
.heatmap-compact {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  justify-content: center;
  padding: 10px 0;
  max-width: 100%;
}
.heatmap-compact-day {
  width: 38px;
  height: 38px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8em;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  border: 2px solid transparent;
}

/* GIORNI SENZA SPESE - Grigio chiaro con bordo tratteggiato */
.heatmap-compact-day.no-expense {
  background: var(--bg);
  border: 2px dashed #ddd;
  color: #bbb;
  opacity: 0.6;
}
.heatmap-compact-day.no-expense:hover {
  opacity: 1;
  border-color: #999;
}

/* GIORNI CON SPESE - Scala da verde a rosso */
.heatmap-compact-day.has-expense {
  color: #fff;
  font-weight: 800;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

/* Livelli di spesa - molto pi√π chiari */
.heatmap-compact-day.level-1 {
  background: linear-gradient(135deg, #52c41a, #73d13d);
  border-color: #389e0d;
}
.heatmap-compact-day.level-2 {
  background: linear-gradient(135deg, #fadb14, #ffc53d);
  border-color: #d4b106;
  color: #333;
}
.heatmap-compact-day.level-3 {
  background: linear-gradient(135deg, #fa8c16, #ff9c6e);
  border-color: #d46b08;
}
.heatmap-compact-day.level-4 {
  background: linear-gradient(135deg, #f5222d, #ff4d4f);
  border-color: #cf1322;
}
.heatmap-compact-day.level-5 {
  background: linear-gradient(135deg, #a8071a, #cf1322);
  border-color: #820014;
  box-shadow: 0 0 12px rgba(168,7,26,0.5);
}

/* Hover effect */
.heatmap-compact-day:hover {
  transform: scale(1.25);
  z-index: 10;
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}

/* Oggi - bordo speciale */
.heatmap-compact-day.today {
  border: 3px solid #1890ff;
  box-shadow: 0 0 0 3px rgba(24,144,255,0.2);
}
.heatmap-compact-day.today.no-expense {
  background: #e6f7ff;
  border-color: #1890ff;
  color: #1890ff;
  opacity: 1;
}

/* Tooltip migliorato */
.heatmap-compact-day::after {
  content: attr(data-amount);
  position: absolute;
  bottom: -24px;
  left: 50%;
  transform: translateX(-50%) scale(0);
  background: rgba(0,0,0,0.9);
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7em;
  white-space: nowrap;
  pointer-events: none;
  transition: transform 0.2s;
  z-index: 100;
}
.heatmap-compact-day:hover::after {
  transform: translateX(-50%) scale(1);
}

/* Legenda migliorata */
.heatmap-compact-legend {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-top: 15px;
  font-size: 0.75em;
  color: #7f8c8d;
  flex-wrap: wrap;
  padding: 10px;
  background: var(--bg);
  border-radius: 8px;
}
.heatmap-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}
.heatmap-compact-legend-box {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

/* Stats grid */
.heatmap-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-top: 15px;
}
.heatmap-stat {
  text-align: center;
  padding: 12px 8px;
  background: var(--bg);
  border-radius: 10px;
  border: 1px solid var(--border);
}
.heatmap-stat-label {
  font-size: 0.7em;
  color: #7f8c8d;
  margin-bottom: 6px;
  font-weight: 600;
}
.heatmap-stat-value {
  font-size: 1.2em;
  font-weight: 800;
  color: var(--expense);
}

/* Dark mode */
body.dark .heatmap-compact-day.no-expense {
  background: var(--header);
  border-color: #444;
  color: #666;
}
body.dark .heatmap-compact-day.today.no-expense {
  background: #0a2540;
  border-color: #1890ff;
  color: #1890ff;
}

/* Responsive */
@media (max-width: 400px) {
  .heatmap-compact-day {
    width: 32px;
    height: 32px;
    font-size: 0.7em;
  }
  .heatmap-stats {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ========== LOADING STATES ========== */
.loading-overlay{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
  backdrop-filter:blur(4px);
}
.spinner{
  width:50px;
  height:50px;
  border:4px solid rgba(255,255,255,0.3);
  border-top-color:#fff;
  border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
.skeleton{
  background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);
  background-size:200% 100%;
  animation:skeleton-loading 1.5s ease-in-out infinite;
  border-radius:8px;
}
@keyframes skeleton-loading{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

/* ========== TOAST NOTIFICATIONS ========== */
.toast-container{
  position:fixed;
  top:80px;
  right:20px;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.toast{
  background:#fff;
  color:#2c3e50;
  padding:16px 20px;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,0.2);
  display:flex;
  align-items:center;
  gap:12px;
  min-width:300px;
  max-width:400px;
  animation:slideInRight 0.3s ease-out,fadeOut 0.3s ease-in 2.7s forwards;
  transform-origin:right center;
}
.toast.success{border-left:4px solid #27ae60}
.toast.error{border-left:4px solid #e74c3c}
.toast.warning{border-left:4px solid #f39c12}
.toast.info{border-left:4px solid #3498db}
.toast-icon{font-size:1.5em}
.toast-message{flex:1;font-weight:600;font-size:0.95em}
@keyframes slideInRight{
  from{transform:translateX(400px);opacity:0}
  to{transform:translateX(0);opacity:1}
}
@keyframes fadeOut{
  to{opacity:0;transform:translateX(400px)}
}

/* ========== ANIMATIONS ========== */
@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}
@keyframes slideUp{
  from{transform:translateY(20px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
@keyframes scaleIn{
  from{transform:scale(0.9);opacity:0}
  to{transform:scale(1);opacity:1}
}
@keyframes shake{
  0%,100%{transform:translateX(0)}
  10%,30%,50%,70%,90%{transform:translateX(-5px)}
  20%,40%,60%,80%{transform:translateX(5px)}
}
@keyframes pulse{
  0%,100%{transform:scale(1)}
  50%{transform:scale(1.05)}
}
@keyframes checkmark{
  0%{stroke-dashoffset:100}
  100%{stroke-dashoffset:0}
}

/* Button animations */
.btn{
  transition:all 0.2s cubic-bezier(0.4,0,0.2,1);
  position:relative;
  overflow:hidden;
}
.btn:active{
  transform:scale(0.96);
}
.btn::after{
  content:'';
  position:absolute;
  top:50%;left:50%;
  width:0;height:0;
  border-radius:50%;
  background:rgba(255,255,255,0.3);
  transform:translate(-50%,-50%);
  transition:width 0.6s,height 0.6s;
}
.btn:active::after{
  width:300px;
  height:300px;
}

/* Smooth scroll */
html{
  scroll-behavior:smooth;
}

/* Card animations */
.card{
  animation:fadeIn 0.3s ease-out;
}

/* Success checkmark */
.success-checkmark{
  width:80px;
  height:80px;
  margin:20px auto;
}
.success-checkmark .check-icon{
  width:80px;
  height:80px;
  position:relative;
  border-radius:50%;
  box-sizing:content-box;
  border:4px solid #27ae60;
}
.success-checkmark .check-icon::before{
  top:3px;
  left:-2px;
  width:30px;
  transform-origin:100% 50%;
  border-radius:100px 0 0 100px;
}
.success-checkmark .check-icon::after{
  top:0;
  left:30px;
  width:60px;
  transform-origin:0 50%;
  border-radius:0 100px 100px 0;
  animation:rotate-circle 4.25s ease-in;
}
.success-checkmark .check-icon::before,
.success-checkmark .check-icon::after{
  content:'';
  height:100px;
  position:absolute;
  background:#fff;
  transform:rotate(-45deg);
}
.success-checkmark .icon-line{
  height:5px;
  background-color:#27ae60;
  display:block;
  border-radius:2px;
  position:absolute;
  z-index:10;
}
.success-checkmark .icon-line.line-tip{
  top:46px;
  left:14px;
  width:25px;
  transform:rotate(45deg);
  animation:icon-line-tip 0.75s;
}
.success-checkmark .icon-line.line-long{
  top:38px;
  right:8px;
  width:47px;
  transform:rotate(-45deg);
  animation:icon-line-long 0.75s;
}
@keyframes icon-line-tip{
  0%{width:0;left:1px;top:19px}
  54%{width:0;left:1px;top:19px}
  70%{width:50px;left:-8px;top:37px}
  84%{width:17px;left:21px;top:48px}
  100%{width:25px;left:14px;top:46px}
}
@keyframes icon-line-long{
  0%{width:0;right:46px;top:54px}
  65%{width:0;right:46px;top:54px}
  84%{width:55px;right:0;top:35px}
  100%{width:47px;right:8px;top:38px}
}

/* Empty states */
.empty-state{
  text-align:center;
  padding:60px 20px;
  color:var(--text);
  opacity:0.7;
}
.empty-state-icon{
  font-size:4em;
  margin-bottom:20px;
  opacity:0.5;
}
.empty-state-title{
  font-size:1.3em;
  font-weight:700;
  margin-bottom:10px;
}
.empty-state-description{
  font-size:0.95em;
  opacity:0.8;
}

.chart-container{
  position:relative;
  height:280px;
  margin:15px 0;
}
.spending-summary{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-bottom:15px;
}
.summary-box{
  background:linear-gradient(135deg,var(--expense),#d35400);
  color:#fff;
  padding:16px;
  border-radius:12px;
  text-align:center;
  box-shadow:0 4px 12px rgba(230,126,34,0.3);
}
.summary-box.income-box{
  background:linear-gradient(135deg,var(--income),#1e8449);
  box-shadow:0 4px 12px rgba(39,174,96,0.3);
}
.summary-label{font-size:0.85em;opacity:0.9;margin-bottom:8px;font-weight:600}
.summary-value{font-size:1.8em;font-weight:800;margin-bottom:4px}
.summary-detail{font-size:0.8em;opacity:0.85}
.monthly-detail{
  background:var(--card);
  padding:14px;
  border-radius:10px;
  margin-bottom:10px;
  border-left:4px solid #3498db;
}
.monthly-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.monthly-name{font-weight:700;font-size:1em}
.monthly-amount{font-size:1.3em;font-weight:800;color:#3498db}
.monthly-bar{
  background:#ecf0f1;
  height:8px;
  border-radius:4px;
  overflow:hidden;
}
.monthly-fill{
  background:#3498db;
  height:100%;
  transition:width 0.5s ease;
}
.toast{
  position:fixed;
  top:80px;
  left:50%;
  transform:translateX(-50%);
  background:#27ae60;
  color:#fff;
  padding:14px 24px;
  border-radius:12px;
  z-index:10000;
  font-weight:700;
  box-shadow:0 4px 16px rgba(0,0,0,0.3);
  animation:toastIn 0.3s ease-out;
}
@keyframes toastIn{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translateX(-50%)}}
@media(max-width:380px){
  .big{font-size:2.4em}
  .metric .val{font-size:1.4em}
  .nav-item{font-size:0.7em}
}

/* WIDGET RIASSUNTIVO */
.widget-float{
  position:fixed;
  bottom:90px;
  right:max(env(safe-area-inset-right),15px);
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  padding:12px 16px;
  border-radius:20px;
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
  z-index:99;
  cursor:pointer;
  transition:all 0.3s;
  font-weight:700;
  font-size:0.85em;
  min-width:120px;
}
.widget-float:active{transform:scale(0.95)}
.widget-label{font-size:0.75em;opacity:0.9;margin-bottom:4px}
.widget-value{font-size:1.4em;font-weight:800}

/* CALENDARIO - Lista Mobile Friendly */
.calendar-day-item{
  background:var(--card);
  border-radius:12px;
  padding:15px;
  margin-bottom:10px;
  border-left:4px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.calendar-day-item:active{transform:scale(0.98)}
.calendar-day-item.today{
  border-left-color:#3498db;
  background:linear-gradient(135deg,rgba(52,152,219,0.1),rgba(52,152,219,0.05));
  font-weight:700;
}
.calendar-day-item.has-expense{border-left-color:#e74c3c}
.calendar-day-item.has-income{border-left-color:#27ae60}
.calendar-day-item.has-both{border-left-color:#f39c12}
.calendar-day-left{flex:1}
.calendar-day-date{
  font-size:1.1em;
  font-weight:700;
  margin-bottom:4px;
}
.calendar-day-weekday{
  font-size:0.85em;
  opacity:0.7;
}
.calendar-day-right{
  text-align:right;
}
.calendar-day-amount{
  font-size:1.1em;
  font-weight:700;
  margin-bottom:4px;
}
.calendar-day-count{
  font-size:0.8em;
  opacity:0.7;
}
.calendar-empty{
  text-align:center;
  padding:40px 20px;
  opacity:0.6;
  font-size:0.95em;
}

/* RICERCA AVANZATA - DESIGN COMPLETAMENTE RINNOVATO */
.advanced-search{
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding:24px;
  border-radius:20px;
  margin-bottom:20px;
  box-shadow:0 8px 24px rgba(102,126,234,0.35);
  border:none;
  animation:slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position:relative;
  overflow:hidden;
}
.advanced-search::before{
  content:'';
  position:absolute;
  top:-50%;
  right:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation:pulse 3s ease-in-out infinite;
}
@keyframes pulse{
  0%, 100%{transform:scale(1);opacity:0.5}
  50%{transform:scale(1.1);opacity:0.8}
}
body.dark .advanced-search{
  background:linear-gradient(135deg, #4a5f9f 0%, #5a3d73 100%);
  box-shadow:0 8px 24px rgba(74,95,159,0.4);
}
@keyframes slideDown{
  from{opacity:0;transform:translateY(-20px) scale(0.95);max-height:0}
  to{opacity:1;transform:translateY(0) scale(1);max-height:800px}
}
.advanced-search h4{
  color:#fff;
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:20px;
  font-size:1.2em;
  text-shadow:0 2px 4px rgba(0,0,0,0.2);
  position:relative;
  z-index:1;
}
.search-section{
  background:rgba(255,255,255,0.95);
  border-radius:16px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  position:relative;
  z-index:1;
}
body.dark .search-section{
  background:rgba(30,30,50,0.95);
}
.search-section-title{
  font-size:0.9em;
  font-weight:700;
  color:#667eea;
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:6px;
}
body.dark .search-section-title{
  color:#9fb4ff;
}
.search-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.search-grid input{
  padding:14px 12px;
  border:2px solid #e0e0e0;
  border-radius:12px;
  background:#fff;
  color:var(--text);
  font-size:0.95em;
  font-weight:600;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
}
body.dark .search-grid input{
  background:#1a1a2e;
  border-color:#2d4059;
  color:#eee;
}
.search-grid input:focus{
  outline:none;
  border-color:#667eea;
  box-shadow:0 0 0 4px rgba(102,126,234,0.2), 0 4px 12px rgba(102,126,234,0.15);
  transform:translateY(-2px);
}
.search-grid input::placeholder{
  color:#999;
  font-weight:500;
}
/* Label e select per ordinamento */
.search-section label{
  color:var(--text);
  font-weight:700;
  font-size:0.9em;
  display:block;
  margin-bottom:8px;
}
.search-section select{
  width:100%;
  padding:14px 12px;
  border:2px solid #e0e0e0;
  border-radius:12px;
  background:#fff;
  color:var(--text);
  font-size:0.95em;
  font-weight:600;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
  cursor:pointer;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23667eea' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  padding-right:40px;
}
body.dark .search-section select{
  background-color:#1a1a2e;
  border-color:#2d4059;
  color:#eee;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%239fb4ff' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
}
.search-section select:focus{
  outline:none;
  border-color:#667eea;
  box-shadow:0 0 0 4px rgba(102,126,234,0.2), 0 4px 12px rgba(102,126,234,0.15);
  transform:translateY(-1px);
}
.advanced-search button{
  margin-top:0;
  padding:14px;
  font-size:1em;
  font-weight:700;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background:#fff;
  color:#e74c3c;
  border:none;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(231,76,60,0.2);
  cursor:pointer;
  position:relative;
  z-index:1;
  width:100%;
}
.advanced-search button:hover{
  transform:translateY(-3px);
  box-shadow:0 8px 20px rgba(231,76,60,0.35);
  background:#fff;
}
.advanced-search button:active{
  transform:translateY(-1px);
}

/* TABELLE RIEPILOGO MENSILE - VERSIONE COMPATTA */
.table-container-compact{
  background:var(--card);
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
  overflow:hidden;
}
.collapsible-header{
  user-select:none;
  -webkit-user-select:none;
}
.collapsible-header:hover{
  transform:translateY(-3px);
  box-shadow:0 8px 24px rgba(102,126,234,0.4) !important;
}
.collapsible-header:active{
  transform:translateY(-1px);
  box-shadow:0 4px 16px rgba(102,126,234,0.3) !important;
}
#tabelleContent{
  animation:slideDownTable 0.4s ease-out;
  overflow:hidden;
}
@keyframes slideDownTable{
  from{opacity:0;max-height:0}
  to{opacity:1;max-height:3000px}
}
.table-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
  padding-bottom:12px;
  border-bottom:2px solid var(--border);
}
.table-title{
  font-size:1.1em;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:8px;
}
.table-title.income{color:var(--income)}
.table-title.expense{color:var(--expense)}
.table-title.savings{color:#667eea}
.year-selector{
  display:flex;
  gap:8px;
  align-items:center;
}
.year-btn{
  background:var(--bg);
  border:2px solid var(--border);
  color:var(--text);
  padding:8px 16px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  font-size:0.9em;
  transition:all 0.2s;
}
.year-btn:hover{
  background:var(--income);
  color:#fff;
  border-color:var(--income);
  transform:scale(1.05);
}
.year-display{
  font-size:1.1em;
  font-weight:700;
  min-width:60px;
  text-align:center;
}
.monthly-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  overflow:hidden;
  border-radius:12px;
}
.monthly-table thead{
  background:linear-gradient(135deg, #667eea, #764ba2);
  color:#fff;
}
.monthly-table thead th{
  padding:10px 10px;
  font-weight:700;
  font-size:0.9em;
  text-align:left;
  border:none;
}
.monthly-table thead th:first-child{
  border-radius:12px 0 0 0;
}
.monthly-table thead th:last-child{
  border-radius:0 12px 0 0;
  text-align:right;
}
.monthly-table tbody tr{
  transition:all 0.2s;
  background:var(--card);
}
.monthly-table tbody tr:hover{
  background:var(--bg);
  transform:scale(1.01);
}
.monthly-table tbody tr.current-month{
  background:linear-gradient(90deg, rgba(102,126,234,0.15), rgba(102,126,234,0.05));
  font-weight:700;
}
.monthly-table tbody tr.current-month td{
  border-top:2px solid #667eea;
  border-bottom:2px solid #667eea;
}
.monthly-table tbody tr.current-month td:first-child{
  border-left:2px solid #667eea;
}
.monthly-table tbody tr.current-month td:last-child{
  border-right:2px solid #667eea;
}
.monthly-table tbody td{
  padding:8px 10px;
  border-bottom:1px solid var(--border);
  font-size:0.9em;
}
.monthly-table tbody td:last-child{
  text-align:right;
  font-weight:700;
  font-size:0.95em;
}
.monthly-table tbody tr:last-child td{
  border-bottom:none;
}
.monthly-table tbody tr:last-child td:first-child{
  border-radius:0 0 0 12px;
}
.monthly-table tbody tr:last-child td:last-child{
  border-radius:0 0 12px 0;
}
.month-name{
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px;
}
.month-icon{
  font-size:1.2em;
}
.amount-positive{
  color:var(--income);
}
.amount-negative{
  color:var(--expense);
}
.amount-neutral{
  color:#667eea;
}
.table-footer{
  margin-top:15px;
  padding-top:15px;
  border-top:3px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:1.1em;
}
.table-footer-label{
  font-weight:700;
  color:var(--text);
}
.table-footer-value{
  font-size:1.3em;
  font-weight:800;
}
.table-footer-value.income{color:var(--income)}
.table-footer-value.expense{color:var(--expense)}
.table-footer-value.savings{color:#667eea}

/* Responsive per tabelle */
@media(max-width:600px){
  .monthly-table{font-size:0.85em}
  .monthly-table thead th{padding:10px 8px}
  .monthly-table tbody td{padding:10px 8px}
  .table-title{font-size:1.1em}
  .year-btn{padding:6px 12px;font-size:0.85em}
}

/* PREVISIONI */
.prediction-card{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  padding:20px;
  border-radius:12px;
  margin-bottom:15px;
}
.prediction-value{
  font-size:1.8em;
  font-weight:800;
  margin:10px 0;
  word-break:break-word;
  line-height:1.2;
}
@media (min-width:768px) {
  .prediction-value{font-size:2.2em}
}
.prediction-detail{
  font-size:0.85em;
  opacity:0.9;
  line-height:1.4;
  word-break:break-word;
}


/* REPORT MODAL */
.report-preview{
  background:#fff;
  padding:20px;
  border-radius:10px;
  margin:15px 0;
}
.report-header{
  text-align:center;
  padding-bottom:15px;
  border-bottom:2px solid #3498db;
  margin-bottom:15px;
}
.report-section{
  margin-bottom:15px;
  padding:10px;
  background:#f8f9fa;
  border-radius:8px;
}

/* Calendario iPhone fix */
#calendario .card{
  margin-bottom:30px;
  padding-bottom:30px;
}
#calendario{
  padding-bottom:40px;
}

/* Media query per schermi piccoli */
@media (max-width: 400px) {
  .card{
    padding:15px;
  }
  .calendar-day-item{
    padding:12px;
  }
  .calendar-day-date{
    font-size:1em;
  }
  .calendar-day-amount{
    font-size:1em;
  }
}


/* SPESE CONDIVISE */
.trans-item.condiviso {
  border-left-color: #e74c3c !important;
  background: linear-gradient(90deg, rgba(231,76,60,0.08) 0%, var(--card) 15%);
  position: relative;
}
.trans-item.condiviso::after {
  content: '';
  position: absolute;
  top: 15px;
  right: 15px;
  font-size: 0em;
  opacity: 0;
}
.condiviso-badge {
  display: inline-block;
  background: #e74c3c;
  color: #fff;
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 0.75em;
  font-weight: 700;
  margin-left: 8px;
  vertical-align: middle;
}
.condiviso-badge::before {
  content: 'üíë ';
  margin-right: 3px;
}

/* OTTIMIZZAZIONI MOBILE - SAFE AREA */
@supports (padding: max(0px)) {
  body {
    padding-left: max(env(safe-area-inset-left), 0px);
    padding-right: max(env(safe-area-inset-right), 0px);
  }
  
  .header {
    padding-left: max(env(safe-area-inset-left), 15px);
    padding-right: max(env(safe-area-inset-right), 15px);
  }
  
  .content {
    padding-left: max(env(safe-area-inset-left), 15px);
    padding-right: max(env(safe-area-inset-right), 15px);
  }
  
  .nav {
    padding-left: max(env(safe-area-inset-left), 8px);
    padding-right: max(env(safe-area-inset-right), 8px);
  }
}

/* CORREZIONE OVERFLOW BARRA NAVIGAZIONE */
.nav {
  width: 100%;
  max-width: 100vw;
  box-sizing: border-box;
}

.nav-item {
  flex-shrink: 0;
  min-width: 70px;
}

/* ASSICURA CHE TUTTO SIA CONTENUTO */
* {
  max-width: 100%;
  box-sizing: border-box;
}

html, body {
  overflow-x: hidden;
  width: 100%;
  position: relative;
}

/* ENTRATE CONDIVISE (quando lei paga) */
.trans-item.income.condiviso {
  border-left-color: #27ae60 !important;
  background: linear-gradient(90deg, rgba(39,174,96,0.08) 0%, var(--card) 15%);
}

/* TRANSAZIONI "SPESA DI LEI" */
.trans-item.partner {
  border-left-color: #9b59b6 !important;
  background: linear-gradient(90deg, rgba(155,89,182,0.08) 0%, var(--card) 15%);
}
.trans-item.partner .trans-amount {
  color: #9b59b6 !important;
}

/* TRANSAZIONI "SPESA DI LEI" */
.trans-item.partner_payment {
  border-left-color: #9b59b6 !important;
  background: linear-gradient(90deg, rgba(155,89,182,0.08) 0%, var(--card) 15%);
}

/* SISTEMA RISPARMIO 15/25/65 */
.savings-container{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:#fff;
  border-radius:16px;
  padding:20px;
  margin-bottom:15px;
  box-shadow:0 4px 12px rgba(102,126,234,0.3);
}
.savings-title{
  font-size:1.4em;
  font-weight:800;
  margin-bottom:8px;
  text-align:center;
}
.savings-subtitle{
  text-align:center;
  opacity:0.9;
  font-size:0.9em;
  margin-bottom:20px;
}
.savings-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-bottom:20px;
}
.savings-bucket{
  background:rgba(255,255,255,0.15);
  backdrop-filter:blur(10px);
  border-radius:12px;
  padding:15px 10px;
  text-align:center;
  transition:all 0.3s;
}
.savings-bucket:active{
  transform:scale(0.95);
}
.savings-bucket-icon{
  font-size:2em;
  margin-bottom:8px;
}
.savings-bucket-label{
  font-size:0.75em;
  opacity:0.9;
  margin-bottom:4px;
  font-weight:600;
}
.savings-bucket-percent{
  font-size:1.8em;
  font-weight:800;
  margin-bottom:4px;
}
.savings-bucket-amount{
  font-size:1.1em;
  font-weight:700;
  opacity:0.95;
}
.savings-total{
  background:rgba(255,255,255,0.2);
  backdrop-filter:blur(10px);
  border-radius:12px;
  padding:15px;
  text-align:center;
  margin-bottom:15px;
}
.savings-total-label{
  font-size:0.85em;
  opacity:0.9;
  margin-bottom:4px;
}
.savings-total-value{
  font-size:2em;
  font-weight:800;
}
.savings-progress{
  background:rgba(255,255,255,0.2);
  border-radius:12px;
  padding:12px;
  margin-bottom:15px;
}
.savings-progress-label{
  font-size:0.85em;
  opacity:0.9;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
}
.savings-progress-bar{
  background:rgba(255,255,255,0.3);
  height:12px;
  border-radius:6px;
  overflow:hidden;
}
.savings-progress-fill{
  background:linear-gradient(90deg,#27ae60,#2ecc71);
  height:100%;
  transition:width 0.5s ease;
  border-radius:6px;
}
.savings-actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.savings-btn{
  background:rgba(255,255,255,0.25);
  border:2px solid rgba(255,255,255,0.4);
  color:#fff;
  padding:12px;
  border-radius:10px;
  font-weight:700;
  font-size:0.9em;
  cursor:pointer;
  transition:all 0.3s;
}
.savings-btn:active{
  transform:scale(0.95);
  background:rgba(255,255,255,0.35);
}
</style>
</head>
<body>

<!-- SCHERMATA LOGIN BELLA -->
<div id="loginScreen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);z-index:99999;display:flex;align-items:center;justify-content:center;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif">
<div style="background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:24px;padding:50px 40px;max-width:400px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:fadeIn 0.5s ease-out">
<div style="font-size:5em;margin-bottom:20px;animation:bounce 1s ease-in-out">üîê</div>
<h1 style="color:#2c3e50;margin:0 0 10px 0;font-size:2em;font-weight:800">Budget Manager Pro</h1>
<p style="color:#7f8c8d;margin:0 0 35px 0;font-size:1em">Inserisci la password per accedere</p>

<form onsubmit="return handleLogin(event)" style="width:100%">
<input type="password" id="loginPassword" placeholder="Password" required autofocus style="width:100%;padding:16px;border:3px solid #e0e0e0;border-radius:12px;font-size:1.1em;margin-bottom:15px;text-align:center;box-sizing:border-box;transition:all 0.3s;outline:none" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">

<label style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:20px;cursor:pointer;user-select:none">
<input type="checkbox" id="rememberDevice" style="width:18px;height:18px;cursor:pointer">
<span style="color:#667eea;font-size:0.95em;font-weight:600">üîê Ricorda password su questo dispositivo</span>
</label>

<button type="submit" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:16px;border-radius:12px;font-size:1.1em;font-weight:700;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(102,126,234,0.4)" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(102,126,234,0.6)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(102,126,234,0.4)'">
‚ú® Accedi
</button>
</form>

<div id="loginError" style="margin-top:20px;padding:12px;background:#fee;border-radius:8px;color:#c00;font-weight:600;display:none">
‚ùå <span id="errorMsg">Password errata</span>
</div>

<div style="margin-top:30px;padding-top:20px;border-top:1px solid #e0e0e0">
<p style="color:#95a5a6;font-size:0.85em;margin:0">üîí I tuoi dati sono protetti e privati</p>
</div>
</div>
</div>

<style>
@keyframes fadeIn {
  from { opacity:0; transform:translateY(-20px); }
  to { opacity:1; transform:translateY(0); }
}
@keyframes bounce {
  0%, 100% { transform:translateY(0); }
  50% { transform:translateY(-10px); }
}
</style>

<script>

// ========== DIALOG HELPERS (senza async) ==========

function mostraDialogInput(titolo, placeholder, callback) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)';
  
  var dialog = document.createElement('div');
  dialog.style.cssText = 'background:var(--card);border-radius:20px;padding:30px;max-width:450px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:slideIn 0.3s ease';
  
  dialog.innerHTML = '<h3 style="margin-bottom:20px;color:var(--text);font-size:1.3em;text-align:center">' + titolo + '</h3>' +
    '<input type="text" id="dialogInput" style="width:100%;padding:16px;border:2px solid var(--border);border-radius:12px;font-size:1.1em;margin-bottom:20px;background:var(--bg);color:var(--text);font-family:inherit" placeholder="' + placeholder + '">' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
    '<button id="btnAnn" style="padding:14px;border:2px solid var(--border);background:transparent;color:var(--text);border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s">Annulla</button>' +
    '<button id="btnOk" style="padding:14px;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(102,126,234,0.4);transition:all 0.3s">Conferma</button>' +
    '</div>';
  
  modal.appendChild(dialog);
  document.body.appendChild(modal);
  
  var input = document.getElementById('dialogInput');
  input.focus();
  
  var btnOk = document.getElementById('btnOk');
  var btnAnn = document.getElementById('btnAnn');
  
  btnOk.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
  btnOk.onmouseout = function() { this.style.transform = 'scale(1)'; };
  btnAnn.onmouseover = function() { this.style.background = 'var(--border)'; };
  btnAnn.onmouseout = function() { this.style.background = 'transparent'; };
  
  btnOk.onclick = function() {
    var val = input.value;
    document.body.removeChild(modal);
    callback(val);
  };
  
  btnAnn.onclick = function() {
    document.body.removeChild(modal);
    callback(null);
  };
  
  input.onkeypress = function(e) {
    if (e.key === 'Enter') {
      var val = input.value;
      document.body.removeChild(modal);
      callback(val);
    }
  };
}
// Helper per conferma eliminazione (rosso)
function mostraDialogConfermaElimina(messaggio, callback) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)';
  
  var dialog = document.createElement('div');
  dialog.style.cssText = 'background:var(--card);border-radius:20px;padding:30px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4)';
  
  dialog.innerHTML = '<h3 style="margin-bottom:15px;color:var(--danger);font-size:1.4em;text-align:center">‚ö†Ô∏è Conferma Eliminazione</h3>' +
    '<p style="margin-bottom:25px;color:var(--text);text-align:center;line-height:1.6">' + messaggio + '</p>' +
    '<p style="margin-bottom:25px;color:#7f8c8d;text-align:center;font-size:0.9em">Questa azione non pu√≤ essere annullata</p>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
    '<button id="btnAnnElim" style="padding:14px;border:2px solid var(--border);background:var(--bg);color:var(--text);border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s">‚úñÔ∏è Annulla</button>' +
    '<button id="btnConfElim" style="padding:14px;border:none;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(231,76,60,0.4);transition:all 0.3s">üóëÔ∏è Elimina</button>' +
    '</div>';
  
  modal.appendChild(dialog);
  document.body.appendChild(modal);
  
  var btnConf = document.getElementById('btnConfElim');
  var btnAnn = document.getElementById('btnAnnElim');
  
  btnConf.onmouseover = function() { this.style.transform = 'scale(1.05)'; this.style.boxShadow = '0 6px 20px rgba(231,76,60,0.6)'; };
  btnConf.onmouseout = function() { this.style.transform = 'scale(1)'; this.style.boxShadow = '0 4px 15px rgba(231,76,60,0.4)'; };
  btnAnn.onmouseover = function() { this.style.background = 'var(--border)'; };
  btnAnn.onmouseout = function() { this.style.background = 'var(--bg)'; };
  
  btnConf.onclick = function() {
    document.body.removeChild(modal);
    callback(true);
  };
  
  btnAnn.onclick = function() {
    document.body.removeChild(modal);
    callback(false);
  };
}

// Helper per conferma generica (blu)
function mostraDialogConferma(messaggio, callback) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)';
  
  var dialog = document.createElement('div');
  dialog.style.cssText = 'background:var(--card);border-radius:20px;padding:30px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4)';
  
  dialog.innerHTML = '<h3 style="margin-bottom:20px;color:var(--text);font-size:1.3em;text-align:center">‚ùì Conferma</h3>' +
    '<p style="margin-bottom:25px;color:var(--text);text-align:center;line-height:1.6">' + messaggio + '</p>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
    '<button id="btnNo" style="padding:14px;border:2px solid var(--border);background:transparent;color:var(--text);border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s">No</button>' +
    '<button id="btnYes" style="padding:14px;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(102,126,234,0.4);transition:all 0.3s">S√¨</button>' +
    '</div>';
  
  modal.appendChild(dialog);
  document.body.appendChild(modal);
  
  var btnYes = document.getElementById('btnYes');
  var btnNo = document.getElementById('btnNo');
  
  btnYes.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
  btnYes.onmouseout = function() { this.style.transform = 'scale(1)'; };
  btnNo.onmouseover = function() { this.style.background = 'var(--border)'; };
  btnNo.onmouseout = function() { this.style.background = 'transparent'; };
  
  btnYes.onclick = function() {
    document.body.removeChild(modal);
    callback(true);
  };
  
  btnNo.onclick = function() {
    document.body.removeChild(modal);
    callback(false);
  };
}



// PASSWORD - FUNZIONA PERFETTAMENTE
var PASSWORD = 'Ciasteczkka24?';
var attempts = 0;
var maxAttempts = 3;

// Verifica se gi√† loggato o password ricordata
if (sessionStorage.getItem('budgetAuth') === 'true' || localStorage.getItem('deviceKey') === 'authorized') {
  document.getElementById('loginScreen').style.display = 'none';
  sessionStorage.setItem('budgetAuth', 'true');
}

function handleLogin(event) {
  event.preventDefault();
  
  var input = document.getElementById('loginPassword');
  var errorDiv = document.getElementById('loginError');
  var errorMsg = document.getElementById('errorMsg');
  var pwd = input.value;
  
  if (pwd === PASSWORD) {
    // Password corretta!
    sessionStorage.setItem('budgetAuth', 'true');
    
    // Salva password se richiesto
    var rememberCheckbox = document.getElementById('rememberDevice');
    if (rememberCheckbox && rememberCheckbox.checked) {
      localStorage.setItem('deviceKey', 'authorized');
    }
    
    // Animazione di successo
    document.getElementById('loginScreen').style.animation = 'fadeOut 0.5s ease-out';
    
    setTimeout(function() {
      document.getElementById('loginScreen').style.display = 'none';
    }, 500);
    
  } else {
    attempts++;
    
    if (attempts >= maxAttempts) {
      errorMsg.textContent = 'Troppi tentativi! Ricarica la pagina.';
      input.disabled = true;
      document.querySelector('button[type="submit"]').disabled = true;
    } else {
      errorMsg.textContent = 'Password errata! Tentativo ' + attempts + ' di ' + maxAttempts;
    }
    
    errorDiv.style.display = 'block';
    input.value = '';
    input.focus();
    
    input.style.animation = 'shake 0.5s';
    setTimeout(function() {
      input.style.animation = '';
    }, 500);
    
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100]);
    }
  }
  
  return false;
}
</script>

<style>
@keyframes fadeOut {
  to { opacity:0; transform:scale(0.9); }
}
@keyframes shake {
  0%, 100% { transform:translateX(0); }
  25% { transform:translateX(-10px); }
  75% { transform:translateX(10px); }
}
</style>

<div class="header">
<div class="hdr-row">
<h1>üí∞ Budget Manager Pro</h1>
<button class="theme-btn" onclick="toggleTheme()">üåô</button>
</div>
<div class="controls">
<select id="year" onchange="aggiorna()"></select>
<select id="month" onchange="aggiorna()">
<option value="0">Gennaio</option>
<option value="1">Febbraio</option>
<option value="2">Marzo</option>
<option value="3">Aprile</option>
<option value="4">Maggio</option>
<option value="5">Giugno</option>
<option value="6">Luglio</option>
<option value="7">Agosto</option>
<option value="8">Settembre</option>
<option value="9">Ottobre</option>
<option value="10">Novembre</option>
<option value="11">Dicembre</option>
</select>
<button onclick="vaiOggi()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-size:1em;cursor:pointer;font-weight:600;white-space:nowrap">üìÖ Oggi</button>
</div>
</div>

<div class="content">
<div id="dash" class="section active">

<div class="card patrimonio">
<div class="patrimonio-label">üíé Patrimonio Totale</div>
<div class="big" id="pat">‚Ç¨0</div>
</div>

<!-- Bottoni Navigazione Mese -->
<div style="display:flex;justify-content:center;gap:10px;margin-bottom:15px">
<button onclick="cambiaPatrimonioMese(-1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">‚óÄ Mese Prec</button>
<button id="oggiDashboard" onclick="vaiOggi()" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">üìÖ Oggi</button>
<button onclick="cambiaPatrimonioMese(1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">Mese Succ ‚ñ∂</button>
</div>

<!-- Alert Dashboard -->
<div id="dashboardAlerts"></div>

<div class="metrics">
<div class="metric">
<h4 style="color:var(--income)">üìà Entrate</h4>
<div class="val" style="color:var(--income)" id="ent">‚Ç¨0</div>
</div>
<div class="metric">
<h4 style="color:var(--expense)">üìâ Uscite</h4>
<div class="val" style="color:var(--expense)" id="usc">‚Ç¨0</div>
</div>
<div class="metric metric-full">
<h4 style="color:#3b82f6">üí∞ Saldo Mensile</h4>
<div class="val" style="color:#3b82f6" id="saldo">‚Ç¨0</div>
</div>
</div>

<!-- SPESE CONDIVISE DETTAGLIATE (COLLAPSIBLE) -->
<div class="card" style="background:linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);border:2px solid #667eea;padding:0;overflow:hidden">
<div onclick="toggleCondiviso()" style="padding:20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none">
<h3 style="margin:0;font-size:1.2em;color:#667eea">üë• Spese Condivise - <span id="sharedMonth"></span></h3>
<span id="condivisoToggleIcon" style="font-size:1.5em;color:#667eea;transition:transform 0.3s;transform:rotate(-90deg)">‚ñº</span>
</div>

<div id="condivisoContent" style="max-height:0;overflow:hidden;transition:max-height 0.3s ease-out">
<div style="padding:0 20px 20px 20px">
<!-- Metriche Mensili -->
<div style="background:rgba(255,255,255,0.9);padding:15px;border-radius:12px;margin-bottom:15px">
<h4 style="font-size:0.95em;color:#666;margin-bottom:12px;font-weight:600">üìÖ Questo Mese</h4>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px">
<div style="text-align:center;padding:12px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:10px;border:2px solid #2196f3">
<div style="font-size:0.75em;color:#1976d2;font-weight:600;margin-bottom:4px">üí≥ Tue Condivise</div>
<div style="font-size:1.3em;font-weight:800;color:#1565c0" id="tueSpeseCondiviseMese">‚Ç¨0</div>
<div style="font-size:0.7em;color:#1976d2;margin-top:2px" id="tueSpeseCondiviseCount">0 transazioni</div>
</div>
<div style="text-align:center;padding:12px;background:linear-gradient(135deg,#f3e5f5,#e1bee7);border-radius:10px;border:2px solid #9c27b0">
<div style="font-size:0.75em;color:#7b1fa2;font-weight:600;margin-bottom:4px">üë§ Sue Condivise</div>
<div style="font-size:1.3em;font-weight:800;color:#6a1b9a" id="sueSpeseCondiviseMese">‚Ç¨0</div>
<div style="font-size:0.7em;color:#7b1fa2;margin-top:2px" id="sueSpeseCondiviseCount">0 transazioni</div>
</div>
</div>
<div style="text-align:center;padding:12px;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border-radius:10px;border:2px solid #ff9800;margin-bottom:8px">
<div style="font-size:0.75em;color:#e65100;font-weight:600;margin-bottom:4px">üè† Totale Speso Insieme</div>
<div style="font-size:1.5em;font-weight:800;color:#e65100" id="totaleCondivisoMese">‚Ç¨0</div>
</div>
<div style="text-align:center;padding:12px;background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border-radius:10px;border:2px solid #4caf50" id="daRecuperareMeseCard">
<div style="font-size:0.75em;font-weight:600;margin-bottom:4px" id="daRecuperareMeseLabel">üí∞ Da Recuperare Mese</div>
<div style="font-size:1.5em;font-weight:800" id="daRecuperareMese">‚Ç¨0</div>
<div style="font-size:0.7em;margin-top:4px;opacity:0.8" id="daRecuperareMeseExpl"></div>
</div>
</div>

<!-- Separatore -->
<div style="height:2px;background:linear-gradient(90deg,transparent,#667eea,transparent);margin:15px 0"></div>

<!-- Bilancio Cumulativo -->
<div style="background:rgba(255,255,255,0.9);padding:15px;border-radius:12px">
<h4 style="font-size:0.95em;color:#666;margin-bottom:12px;font-weight:600">üìä Bilancio Cumulativo</h4>
<div style="text-align:center;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;box-shadow:0 6px 20px rgba(102,126,234,0.4)">
<div style="font-size:0.8em;color:#fff;opacity:0.9;margin-bottom:6px">üí∞ Da Recuperare TOTALE</div>
<div style="font-size:2em;font-weight:800;color:#fff;margin-bottom:4px" id="daRecuperare">‚Ç¨0</div>
<div style="font-size:0.75em;color:#fff;opacity:0.8" id="daRecuperarePeriodo">Dall'inizio tracking</div>
</div>
<button onclick="vai('condiviso', event.target)" class="btn" style="margin-top:12px;width:100%;background:linear-gradient(135deg,#f093fb,#f5576c);box-shadow:0 4px 12px rgba(245,87,108,0.3)">
üìÖ Vedi Storico Completo & Grafici
</button>
</div>
</div>
</div>
</div>

<!-- Rimuovo metriche vecchie -->
<div class="metrics" style="display:none">
<div class="metric">
<h4 style="color:#9b59b6">üë• Spesa Partner</h4>
<div class="val" style="color:#9b59b6" id="leiHaPagato">‚Ç¨0</div>
</div>
<div class="metric">
<h4 style="color:#e74c3c">üíë Totale Condiviso</h4>
<div class="val" style="color:#e74c3c" id="speseCondivise">‚Ç¨0</div>
</div>
<div class="metric metric-full">
<h4 id="daRecuperareLabel" style="color:#f39c12">üí∞ Da Recuperare</h4>
<div class="val" style="color:#f39c12" id="daRecuperareOld">‚Ç¨0</div>
</div>
</div>

<!-- CALENDAR HEATMAP SPESE GIORNALIERE -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üóìÔ∏è Mappa Spese Giornaliere</h3>
<p style="font-size:0.85em;color:#7f8c8d;margin-bottom:12px">Panoramica visiva delle tue spese quotidiane del mese</p>
<div id="calendarHeatmap" style="overflow-x:auto"></div>
</div>

<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Tutte le Spese del Mese</h3>
<div id="topExpenses"></div>
</div>

<!-- GRAFICO SPESE VS ENTRATE ULTIMI 6 MESI -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Confronto Spese Mensili</h3>
<p style="font-size:0.9em;color:#7f8c8d;margin-bottom:15px">Andamento entrate, uscite e saldo degli ultimi 6 mesi</p>
<div style="position:relative;height:350px;width:100%;margin-bottom:10px">
<canvas id="compareChart"></canvas>
</div>
</div>
</div>

<div id="condiviso" class="section">
<div class="info-box"><strong>üë• Analisi Spese Condivise</strong><br>Storico completo, grafici e statistiche delle spese condivise con la tua ragazza</div>

<!-- SELECTOR RAPIDO MESE/ANNO -->
<div style="display:flex;justify-content:center;gap:10px;margin-bottom:15px;flex-wrap:wrap">
<button onclick="cambiaCondivisoMese(-1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.95em;flex:1;max-width:130px;white-space:nowrap">‚óÄ Mese Prec</button>
<button id="oggiCondiviso" onclick="vaiOggiCondiviso()" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.95em;flex:1;max-width:130px">üìÖ Oggi</button>
<button onclick="cambiaCondivisoMese(1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.95em;flex:1;max-width:130px;white-space:nowrap">Mese Succ ‚ñ∂</button>
</div>
<div style="text-align:center;font-weight:700;font-size:1.1em;color:var(--text);margin-bottom:15px" id="condivisoMeseDisplay"></div>

<!-- TAB TEMPORALE -->
<div style="display:flex;gap:10px;margin-bottom:20px;justify-content:center">
<button id="tabMensile" class="btn" onclick="mostraTabCondiviso('mensile')" style="flex:1;max-width:200px;background:linear-gradient(135deg,#667eea,#764ba2);padding:12px">üìÖ Mensile</button>
<button id="tabAnnuale" class="btn" onclick="mostraTabCondiviso('annuale')" style="flex:1;max-width:200px;background:linear-gradient(135deg,#f093fb,#f5576c);padding:12px;opacity:0.6">üìÜ Annuale</button>
<button id="tabTotale" class="btn" onclick="mostraTabCondiviso('totale')" style="flex:1;max-width:200px;background:linear-gradient(135deg,#4facfe,#00f2fe);padding:12px;opacity:0.6">üèÜ Dall'Inizio</button>
</div>

<!-- VISTA MENSILE -->
<div id="condivisoMensile" style="display:block">

<!-- Riepilogo Mese -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Riepilogo <span id="condivisoMeseCorrente"></span></h3>

<div style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:15px">
<div style="text-align:center;padding:18px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:12px;border:2px solid #2196f3">
<div style="font-size:0.75em;color:#1976d2;font-weight:600;margin-bottom:6px">üí≥ Tue Spese Condivise</div>
<div style="font-size:1.8em;font-weight:800;color:#1565c0;word-break:break-word;line-height:1.2" id="condivisoTueMese">‚Ç¨0</div>
<div style="font-size:0.7em;color:#1976d2;margin-top:4px" id="condivisoTueTransMese">0 transazioni</div>
</div>
<div style="text-align:center;padding:18px;background:linear-gradient(135deg,#f3e5f5,#e1bee7);border-radius:12px;border:2px solid #9c27b0">
<div style="font-size:0.75em;color:#7b1fa2;font-weight:600;margin-bottom:6px">üë§ Sue Spese Condivise</div>
<div style="font-size:1.8em;font-weight:800;color:#6a1b9a;word-break:break-word;line-height:1.2" id="condivisoSueMese">‚Ç¨0</div>
<div style="font-size:0.7em;color:#7b1fa2;margin-top:4px" id="condivisoSueTransMese">0 transazioni</div>
</div>
</div>

<div style="text-align:center;padding:18px;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border-radius:12px;border:2px solid #ff9800;margin-bottom:12px">
<div style="font-size:0.75em;color:#e65100;font-weight:600;margin-bottom:6px">üè† Totale Speso Insieme</div>
<div style="font-size:1.9em;font-weight:800;color:#e65100;word-break:break-word;line-height:1.2" id="condivisoTotaleMese">‚Ç¨0</div>
<div style="font-size:0.7em;color:#e65100;margin-top:4px">Quota per persona: <span id="condivisoQuotaMese">‚Ç¨0</span></div>
</div>

<div style="text-align:center;padding:18px;border-radius:12px;border:2px solid #4caf50" id="condivisoDaRecMeseCard">
<div style="font-size:0.75em;font-weight:600;margin-bottom:6px" id="condivisoDaRecLabel">üí∞ Da Recuperare</div>
<div style="font-size:2.2em;font-weight:800;word-break:break-word;line-height:1.2" id="condivisoDaRecMese">‚Ç¨0</div>
<div style="font-size:0.75em;margin-top:6px;opacity:0.9;word-break:break-word" id="condivisoDaRecExpl">Spiegazione del calcolo</div>
</div>
</div>

<!-- Top Categorie Condivise Mese -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üèÜ Top Categorie Condivise</h3>
<div id="condivisoTopCategorieMese"></div>
</div>

</div>

<!-- VISTA ANNUALE -->
<div id="condivisoAnnuale" style="display:none">

<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Anno <span id="condivisoAnnoCorrente"></span></h3>

<div style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:15px">
<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:12px">
<div style="font-size:0.75em;color:#1976d2;font-weight:600;margin-bottom:6px">üí≥ Tue Condivise Anno</div>
<div style="font-size:1.8em;font-weight:800;color:#1565c0;word-break:break-word;line-height:1.2" id="condivisoTueAnno">‚Ç¨0</div>
<div style="font-size:0.7em;color:#1976d2;margin-top:4px">Media: <span id="condivisoTueMediaAnno">‚Ç¨0</span>/mese</div>
</div>
<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#f3e5f5,#e1bee7);border-radius:12px">
<div style="font-size:0.75em;color:#7b1fa2;font-weight:600;margin-bottom:6px">üë§ Sue Condivise Anno</div>
<div style="font-size:1.8em;font-weight:800;color:#6a1b9a;word-break:break-word;line-height:1.2" id="condivisoSueAnno">‚Ç¨0</div>
<div style="font-size:0.7em;color:#7b1fa2;margin-top:4px">Media: <span id="condivisoSueMediaAnno">‚Ç¨0</span>/mese</div>
</div>
</div>

<div style="text-align:center;padding:18px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;margin-bottom:15px">
<div style="font-size:0.75em;opacity:0.9;margin-bottom:6px">üí∞ Da Recuperare Anno</div>
<div style="font-size:2em;font-weight:800;word-break:break-word;line-height:1.2" id="condivisoDaRecAnno">‚Ç¨0</div>
</div>
</div>

<!-- Grafico Trend Annuale -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìà Trend Mensile</h3>
<div class="chart-container" style="height:300px">
<canvas id="condivisoTrendChart"></canvas>
</div>
</div>

<!-- Storico Mensile Anno -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìÖ Storico Mese per Mese</h3>
<div id="condivisoStoricoAnno"></div>
</div>

</div>

<!-- VISTA TOTALE -->
<div id="condivisoTotale" style="display:none">

<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üèÜ Dall'Inizio Tracking <span id="condivisoPeriodoTotale"></span></h3>

<div style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:15px">
<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:12px">
<div style="font-size:0.75em;color:#1976d2;font-weight:600;margin-bottom:6px">üí≥ Hai Pagato</div>
<div style="font-size:2em;font-weight:800;color:#1565c0;word-break:break-word;line-height:1.2" id="condivisoTueTotale">‚Ç¨0</div>
</div>
<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#f3e5f5,#e1bee7);border-radius:12px">
<div style="font-size:0.75em;color:#7b1fa2;font-weight:600;margin-bottom:6px">üë§ Partner Ha Pagato</div>
<div style="font-size:2em;font-weight:800;color:#6a1b9a;word-break:break-word;line-height:1.2" id="condivisoSueTotale">‚Ç¨0</div>
</div>
</div>

<div style="text-align:center;padding:18px;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border-radius:12px;margin-bottom:15px">
<div style="font-size:0.75em;color:#e65100;font-weight:600;margin-bottom:6px">üè† Totale Speso Insieme</div>
<div style="font-size:2em;font-weight:800;color:#e65100;word-break:break-word;line-height:1.2" id="condivisoTotaleTotale">‚Ç¨0</div>
<div style="font-size:0.7em;color:#e65100;margin-top:4px">Quota per persona: <span id="condivisoQuotaTotale">‚Ç¨0</span></div>
</div>

<div style="text-align:center;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(102,126,234,0.4)">
<div style="font-size:0.85em;opacity:0.9;margin-bottom:8px">üí∞ BILANCIO FINALE</div>
<div style="font-size:2.2em;font-weight:800;word-break:break-word;line-height:1.2" id="condivisoDaRecTotale">‚Ç¨0</div>
<div style="font-size:0.8em;opacity:0.9;margin-top:6px;word-break:break-word" id="condivisoDaRecTotaleExpl">Chi deve a chi</div>
</div>
</div>

<!-- Grafico Trend Totale -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìà Evoluzione "Da Recuperare" nel Tempo</h3>
<p style="font-size:0.85em;color:#7f8c8d;margin-bottom:12px">Andamento cumulativo dal primo mese di tracking</p>
<div class="chart-container" style="height:350px">
<canvas id="condivisoEvoluzioneChart"></canvas>
</div>
</div>

<!-- Top Categorie Totale -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üèÜ Top Categorie Condivise (Totale)</h3>
<p style="font-size:0.85em;color:#7f8c8d;margin-bottom:12px">Le categorie su cui avete speso di pi√π insieme dall'inizio</p>
<div class="chart-container" style="height:400px">
<canvas id="condivisoTopCategorieChart"></canvas>
</div>
</div>

<!-- Storico Completo -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìÖ Storico Completo</h3>
<p style="font-size:0.85em;color:#7f8c8d;margin-bottom:15px">Dettaglio mese per mese con delta e cumulativo</p>
<div id="condivisoStoricoCompleto" style="overflow-x:auto"></div>
</div>

</div>

</div>

<div id="finanze" class="section">
<div class="info-box"><strong>üí∞ Finanze & Analisi</strong><br>Sistema risparmio 15/20/65, previsioni e statistiche dettagliate</div>

<!-- SELECTOR RAPIDO MESE -->
<div style="display:flex;justify-content:center;gap:10px;margin-bottom:15px">
<button onclick="cambiaFinanzeMese(-1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">‚óÄ Mese Prec</button>
<button id="oggiFinanze" onclick="vaiOggi()" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">üìÖ Oggi</button>
<button onclick="cambiaFinanzeMese(1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">Mese Succ ‚ñ∂</button>
</div>

<!-- SISTEMA RISPARMIO 15/20/65 -->
<div class="savings-container">
<div class="savings-title">üí∞ Sistema 15/20/65</div>
<div class="savings-subtitle">Dividi le tue entrate in modo equilibrato</div>

<div class="savings-total">
<div class="savings-total-label">Entrate Mese Corrente</div>
<div class="savings-total-value" id="savingsIncome">‚Ç¨0,00</div>
</div>

<div class="savings-grid">
<div class="savings-bucket">
<div class="savings-bucket-icon">üéØ</div>
<div class="savings-bucket-label">Necessit√†</div>
<div class="savings-bucket-percent">65%</div>
<div class="savings-bucket-amount" id="savingsNeeds">‚Ç¨0,00</div>
</div>
<div class="savings-bucket">
<div class="savings-bucket-icon">üíé</div>
<div class="savings-bucket-label">Desideri</div>
<div class="savings-bucket-percent">20%</div>
<div class="savings-bucket-amount" id="savingsWants">‚Ç¨0,00</div>
</div>
<div class="savings-bucket">
<div class="savings-bucket-icon">üè¶</div>
<div class="savings-bucket-label">Risparmi</div>
<div class="savings-bucket-percent">15%</div>
<div class="savings-bucket-amount" id="savingsSavings">‚Ç¨0,00</div>
</div>
</div>

<div class="savings-progress">
<div class="savings-progress-label">
<span>Progresso Risparmi</span>
<span id="savingsProgress">0%</span>
</div>
<div class="savings-progress-bar">
<div class="savings-progress-fill" id="savingsProgressBar" style="width:0%"></div>
</div>
</div>
</div>

<!-- ANALISI RISPARMIO MENSILE -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Analisi Risparmio Mese</h3>
<div id="savingsAnalysis"></div>
</div>

<!-- PREVISIONI -->
<div class="prediction-card">
<h3 style="margin-bottom:10px;font-size:1.1em">üîÆ Previsione Prossimo Mese</h3>
<div style="display:flex;justify-content:space-around;text-align:center;gap:10px;flex-wrap:wrap">
<div style="flex:1;min-width:140px">
<div style="font-size:0.85em;opacity:0.9">Spese Previste</div>
<div class="prediction-value" id="predictedExpense">‚Ç¨0</div>
<div class="prediction-detail" id="predictionTrend"></div>
</div>
<div style="flex:1;min-width:140px">
<div style="font-size:0.85em;opacity:0.9">Saldo Previsto</div>
<div class="prediction-value" id="predictedBalance">‚Ç¨0</div>
<div class="prediction-detail" id="predictionNote"></div>
</div>
</div>
</div>
<!-- TABELLE DETTAGLIATE MENSILI (COLLASSABILI) -->
<div class="card">
<div class="collapsible-header" onclick="toggleTabelle()" style="cursor:pointer;padding:24px 20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:16px;margin-bottom:20px;transition:all 0.3s;box-shadow:0 4px 16px rgba(102,126,234,0.3)">
<div style="display:flex;align-items:center;justify-content:space-between">
<div style="display:flex;align-items:center;gap:15px;flex:1">
<div style="width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
<span id="tabelleIcon" style="font-size:1.8em;transition:transform 0.3s;color:#fff;font-weight:700">‚ñ∂</span>
</div>
<div style="flex:1">
<h3 style="margin:0;font-size:1.3em;font-weight:800;color:#fff;margin-bottom:4px">üìä Tabelle Dettagliate</h3>
<span style="font-size:0.9em;color:rgba(255,255,255,0.85);font-weight:500">Visualizza tutti i mesi dell'anno</span>
</div>
</div>
</div>
</div>

<div id="tabelleContent" style="display:none">
<!-- TABELLE RIEPILOGO ANNUALE -->
<div class="table-container-compact">
<div class="table-header">
<div class="table-title income">üìà Entrate Mensili</div>
<div class="year-selector">
<button class="year-btn" onclick="cambiaAnnoTabelle(-1)">‚óÄ</button>
<div class="year-display" id="tableYear">2025</div>
<button class="year-btn" onclick="cambiaAnnoTabelle(1)">‚ñ∂</button>
</div>
</div>
<table class="monthly-table">
<thead>
<tr>
<th>Mese</th>
<th>Importo</th>
</tr>
</thead>
<tbody id="incomeTableBody">
<!-- Popolato da JS -->
</tbody>
</table>
<div class="table-footer">
<div class="table-footer-label">Totale Anno</div>
<div class="table-footer-value income" id="incomeTotalYear">‚Ç¨0,00</div>
</div>
</div>

<div class="table-container-compact">
<div class="table-header">
<div class="table-title expense">üìâ Uscite Mensili</div>
<div class="year-selector">
<button class="year-btn" onclick="cambiaAnnoTabelle(-1)">‚óÄ</button>
<div class="year-display" id="tableYear2">2025</div>
<button class="year-btn" onclick="cambiaAnnoTabelle(1)">‚ñ∂</button>
</div>
</div>
<table class="monthly-table">
<thead>
<tr>
<th>Mese</th>
<th>Importo</th>
</tr>
</thead>
<tbody id="expenseTableBody">
<!-- Popolato da JS -->
</tbody>
</table>
<div class="table-footer">
<div class="table-footer-label">Totale Anno</div>
<div class="table-footer-value expense" id="expenseTotalYear">‚Ç¨0,00</div>
</div>
</div>

<div class="table-container-compact">
<div class="table-header">
<div class="table-title savings">üí∞ Risparmi Mensili</div>
<div class="year-selector">
<button class="year-btn" onclick="cambiaAnnoTabelle(-1)">‚óÄ</button>
<div class="year-display" id="tableYear3">2025</div>
<button class="year-btn" onclick="cambiaAnnoTabelle(1)">‚ñ∂</button>
</div>
</div>
<table class="monthly-table">
<thead>
<tr>
<th>Mese</th>
<th>Saldo</th>
</tr>
</thead>
<tbody id="savingsTableBody">
<!-- Popolato da JS -->
</tbody>
</table>
<div class="table-footer">
<div class="table-footer-label">Totale Anno</div>
<div class="table-footer-value savings" id="savingsTotalYear">‚Ç¨0,00</div>
</div>
</div>
</div>
</div>


<!-- RIEPILOGO MESE -->
<div class="card">
<h3 style="margin-bottom:15px;color:#3498db;font-size:1.2em">üìÖ Riepilogo Mese <span id="analysisMese"></span></h3>
<div class="spending-summary">
<div class="summary-box">
<div class="summary-label">Spese Mese</div>
<div class="summary-value" id="currentMonthExpense">‚Ç¨0</div>
</div>
<div class="summary-box income-box">
<div class="summary-label">Entrate Mese</div>
<div class="summary-value" id="currentMonthIncome">‚Ç¨0</div>
</div>
</div>
</div>

<!-- RIEPILOGO ANNO -->
<div class="card">
<h3 style="margin-bottom:15px;color:var(--expense);font-size:1.2em">üìÖ Riepilogo Anno <span id="spendingYear"></span></h3>
<div class="spending-summary">
<div class="summary-box">
<div class="summary-label">Spese Totali</div>
<div class="summary-value" id="totalYearExpense">‚Ç¨0</div>
<div class="summary-detail" id="avgMonthExpense">Media: ‚Ç¨0/mese</div>
</div>
<div class="summary-box income-box">
<div class="summary-label">Entrate Totali</div>
<div class="summary-value" id="totalYearIncome">‚Ç¨0</div>
<div class="summary-detail" id="avgMonthIncome">Media: ‚Ç¨0/mese</div>
</div>
</div>
</div>

<!-- COMPARAZIONI PERIODI CON SELEZIONE -->
<div class="card">
<h3 style="margin-bottom:12px;font-size:1.2em">üìä Confronto Periodi Personalizzato</h3>
<p style="font-size:0.85em;color:var(--text);opacity:0.8;margin-bottom:15px">Seleziona due periodi da confrontare</p>

<!-- Tab Mesi / Anni -->
<div style="display:flex;gap:10px;margin-bottom:20px">
<button id="tabMesi" class="btn" onclick="mostraTabConfronto('mesi')" style="flex:1;background:linear-gradient(135deg,#3498db,#2980b9);padding:14px;font-size:0.95em">üìÖ Mesi</button>
<button id="tabAnni" class="btn" onclick="mostraTabConfronto('anni')" style="flex:1;background:linear-gradient(135deg,#9b59b6,#8e44ad);padding:14px;font-size:0.95em;opacity:0.6">üìÜ Anni</button>
</div>

<!-- Selettori Mesi -->
<div id="confrontoMesiUI" style="display:block">
<div style="background:var(--bg);padding:15px;border-radius:12px;margin-bottom:15px">

<!-- Primo Mese -->
<div style="margin-bottom:15px;padding:12px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:10px;border:2px solid #3498db">
<label style="display:block;margin-bottom:8px;font-weight:700;font-size:0.9em;color:#2980b9">üîµ Primo Periodo</label>
<div style="display:grid;grid-template-columns:2fr 1fr;gap:8px">
<select id="confrontoMese1" class="controls" style="width:100%;padding:10px;font-size:0.95em">
<option value="0">Gennaio</option>
<option value="1">Febbraio</option>
<option value="2">Marzo</option>
<option value="3">Aprile</option>
<option value="4">Maggio</option>
<option value="5">Giugno</option>
<option value="6">Luglio</option>
<option value="7">Agosto</option>
<option value="8">Settembre</option>
<option value="9">Ottobre</option>
<option value="10">Novembre</option>
<option value="11">Dicembre</option>
</select>
<select id="confrontoAnno1" class="controls" style="width:100%;padding:10px;font-size:0.95em"></select>
</div>
</div>

<!-- VS Divider -->
<div style="text-align:center;font-weight:800;font-size:1.2em;color:var(--text);margin:10px 0">‚ö° VS ‚ö°</div>

<!-- Secondo Mese -->
<div style="margin-bottom:15px;padding:12px;background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border-radius:10px;border:2px solid #27ae60">
<label style="display:block;margin-bottom:8px;font-weight:700;font-size:0.9em;color:#27ae60">üü¢ Secondo Periodo</label>
<div style="display:grid;grid-template-columns:2fr 1fr;gap:8px">
<select id="confrontoMese2" class="controls" style="width:100%;padding:10px;font-size:0.95em">
<option value="0">Gennaio</option>
<option value="1">Febbraio</option>
<option value="2">Marzo</option>
<option value="3">Aprile</option>
<option value="4">Maggio</option>
<option value="5">Giugno</option>
<option value="6">Luglio</option>
<option value="7">Agosto</option>
<option value="8">Settembre</option>
<option value="9">Ottobre</option>
<option value="10">Novembre</option>
<option value="11">Dicembre</option>
</select>
<select id="confrontoAnno2" class="controls" style="width:100%;padding:10px;font-size:0.95em"></select>
</div>
</div>

<button class="btn" onclick="confrontaMesiPersonalizzato()" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);box-shadow:0 4px 12px rgba(102,126,234,0.3);padding:14px;font-weight:700">
üîç Confronta Periodi
</button>
</div>
</div>

<!-- Selettori Anni -->
<div id="confrontoAnniUI" style="display:none">
<div style="background:var(--bg);padding:15px;border-radius:12px;margin-bottom:15px">

<!-- Primo Anno -->
<div style="margin-bottom:15px;padding:12px;background:linear-gradient(135deg,#f3e5f5,#e1bee7);border-radius:10px;border:2px solid #9b59b6">
<label style="display:block;margin-bottom:8px;font-weight:700;font-size:0.9em;color:#8e44ad">üîµ Primo Anno</label>
<select id="confrontoAnnoA" class="controls" style="width:100%;padding:10px;font-size:0.95em"></select>
</div>

<!-- VS Divider -->
<div style="text-align:center;font-weight:800;font-size:1.2em;color:var(--text);margin:10px 0">‚ö° VS ‚ö°</div>

<!-- Secondo Anno -->
<div style="margin-bottom:15px;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;border:2px solid #667eea">
<label style="display:block;margin-bottom:8px;font-weight:700;font-size:0.9em;color:#fff">üü¢ Secondo Anno</label>
<select id="confrontoAnnoB" class="controls" style="width:100%;padding:10px;font-size:0.95em"></select>
</div>

<button class="btn" onclick="confrontaAnniPersonalizzato()" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);box-shadow:0 4px 12px rgba(102,126,234,0.3);padding:14px;font-weight:700">
üîç Confronta Anni
</button>
</div>
</div>

<!-- Risultato Confronto -->
<div id="confrontoResult"></div>
</div>


<!-- TENDENZA RISPARMIO MENSILE - CUSTOM DESIGN -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üíπ Tendenza Risparmio Mensile</h3>
<p style="font-size:0.9em;color:#7f8c8d;margin-bottom:15px">Percentuale di risparmio per ogni mese (obiettivo: 15%)</p>
<div id="savingsTrendCustom" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px"></div>
</div>

<!-- GRAFICO CONFRONTO MENSILE -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Confronto Spese Mensili</h3>
<div class="chart-container" style="height:300px">
<canvas id="monthlyExpenseChart"></canvas>
</div>
</div>

<!-- GRAFICO TREND ANNUALE -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìà Trend Annuale Entrate vs Uscite</h3>
<div class="chart-container" style="height:300px">
<canvas id="finanzeLineChart"></canvas>
</div>
</div>

<!-- GRAFICO DISTRIBUZIONE SPESE ANNO (BARRE ORIZZONTALI) -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Distribuzione Spese per Categoria - Anno <span id="distribAnno"></span></h3>
<p style="font-size:0.85em;color:#7f8c8d;margin-bottom:12px">Totale annuale per ogni categoria di spesa (ordinate dalla pi√π alta alla pi√π bassa)</p>
<div class="chart-container" style="height:600px;max-height:80vh">
<canvas id="finanzePieChart"></canvas>
</div>
</div>


</div>

<div id="obiettivi" class="section">
<div class="info-box"><strong>üéØ Obiettivi Budget</strong><br>Imposta budget mensili per le tue categorie di spesa e monitora i progressi</div>

<!-- SELECTOR RAPIDO MESE -->
<div style="display:flex;justify-content:center;gap:10px;margin-bottom:15px">
<button onclick="cambiaObiettiviMese(-1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">‚óÄ Mese Prec</button>
<button id="oggiObiettivi" onclick="vaiOggi()" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">üìÖ Oggi</button>
<button onclick="cambiaObiettiviMese(1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em">Mese Succ ‚ñ∂</button>
</div>

<!-- RIEPILOGO OBIETTIVI -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìä Riepilogo Obiettivi <span id="obiettiviMese"></span></h3>
<div id="obiettiviRiepilogo"></div>
</div>

<!-- OBIETTIVI MENSILI -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üéØ Obiettivi Mensili</h3>
<p style="font-size:0.9em;color:#7f8c8d;margin-bottom:15px">Gestisci i budget mensili per ogni categoria di spesa</p>
<div id="budgetGoals"></div>
<button class="btn" onclick="aggiungiObiettivo()" style="margin-top:15px">+ Aggiungi Obiettivo Mensile</button>
</div>

<!-- OBIETTIVI LONG-TERM -->
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üèÜ Obiettivi Long-Term</h3>
<p style="font-size:0.9em;color:#7f8c8d;margin-bottom:15px">Obiettivi di risparmio e riduzione spesa su pi√π mesi</p>
<div id="longTermGoals"></div>
<button class="btn" onclick="aggiungiObiettivoLongTerm()" style="margin-top:15px">+ Aggiungi Obiettivo Long-Term</button>
</div>
</div>

<div id="trans" class="section">
<div class="info-box"><strong>‚ú® Transazioni</strong><br>Registra e gestisci le tue transazioni</div>

<!-- Quick Switch Mesi -->
<div style="display:flex;justify-content:center;gap:10px;margin:15px 0">
<button onclick="cambiaMovimentiMese(-1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.95em;flex:1;max-width:130px;white-space:nowrap">‚óÄ Mese Prec</button>
<button id="oggiMovimenti" onclick="vaiOggiMovimenti()" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.95em;flex:1;max-width:130px">üìÖ Oggi</button>
<button onclick="cambiaMovimentiMese(1)" style="background:var(--card);border:2px solid #667eea;color:#667eea;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;font-size:0.95em;flex:1;max-width:130px;white-space:nowrap">Mese Succ ‚ñ∂</button>
</div>
<div style="text-align:center;font-weight:700;font-size:1.1em;color:var(--text);margin-bottom:15px" id="movimentiMeseCorrente"></div>

<button class="btn" onclick="nuovaTrans()">+ Nuova Transazione</button>
<div class="filters">
<div class="filter-row">
<input type="text" id="searchTrans" placeholder="üîç Cerca..." onkeyup="ricercaDebounced()">
<button id="advancedSearchBtn" onclick="toggleAdvancedSearch()" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 18px;border-radius:12px;cursor:pointer;font-weight:700;white-space:nowrap;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">üîç Avanzata</button>
</div>

<div id="advancedSearchPanel" class="advanced-search" style="display:none">
<div style="max-width:600px;margin:0 auto;padding:0 15px">
<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:18px;border-radius:16px;margin:0 0 20px 0;text-align:center">
<h4 style="margin:0;color:#fff;font-size:1.15em;display:inline-flex;align-items:center;gap:10px;font-weight:700">üîç Ricerca Avanzata</h4>
</div>

<div class="search-section" style="margin-bottom:15px;background:var(--card);padding:12px 12px 12px 4px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
<div class="search-section-title" style="font-weight:700;margin-bottom:10px;color:var(--text);font-size:1em;display:flex;align-items:center;gap:8px;justify-content:center;padding-left:8px">üìÖ Filtra per Data e Importo</div>

<!-- Date - VERTICALI con margini ottimizzati -->
<div style="margin-bottom:10px;padding:0 20px 0 12px">
<label style="display:block;font-size:0.8em;color:#7f8c8d;margin-bottom:4px;font-weight:600;text-align:center;padding-left:8px">Data inizio</label>
<input type="date" id="searchDateFrom" onchange="mostraTrans()" style="width:100%;padding:9px;border:2px solid var(--border);border-radius:8px;font-size:0.9em;background:var(--bg);color:var(--text);box-sizing:border-box">
</div>

<div style="margin-bottom:10px;padding:0 20px 0 12px">
<label style="display:block;font-size:0.8em;color:#7f8c8d;margin-bottom:4px;font-weight:600;text-align:center;padding-left:8px">Data fine</label>
<input type="date" id="searchDateTo" onchange="mostraTrans()" style="width:100%;padding:9px;border:2px solid var(--border);border-radius:8px;font-size:0.9em;background:var(--bg);color:var(--text);box-sizing:border-box">
</div>

<!-- Importo - 2 colonne con margini ottimizzati -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 16px 0 16px">
<div style="padding:0 8px 0 8px">
<label style="display:block;font-size:0.8em;color:#7f8c8d;margin-bottom:4px;font-weight:600;text-align:center">‚Ç¨ Min</label>
<input type="number" id="searchAmountMin" placeholder="0" step="0.01" onchange="mostraTrans()" style="width:100%;padding:9px;border:2px solid var(--border);border-radius:8px;font-size:0.9em;background:var(--bg);color:var(--text);box-sizing:border-box">
</div>
<div style="padding:0 8px 0 8px">
<label style="display:block;font-size:0.8em;color:#7f8c8d;margin-bottom:4px;font-weight:600;text-align:center">‚Ç¨ Max</label>
<input type="number" id="searchAmountMax" placeholder="999999" step="0.01" onchange="mostraTrans()" style="width:100%;padding:9px;border:2px solid var(--border);border-radius:8px;font-size:0.9em;background:var(--bg);color:var(--text);box-sizing:border-box">
</div>
</div>
</div>

<div class="search-section" style="margin-bottom:15px;background:var(--card);padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
<div class="search-section-title" style="font-weight:700;margin-bottom:12px;color:var(--text);font-size:1em;display:flex;align-items:center;gap:8px">üîÑ Ordinamento Risultati</div>
<select id="sortOrder" onchange="cambiaOrdinamento()" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:8px;font-size:0.95em;background:var(--bg);color:var(--text);font-weight:600">
<option value="recenti">üìÖ Pi√π recenti (per data)</option>
<option value="ultime-inserite">üÜï Ultime inserite (ordine inserimento)</option>
<option value="vecchie">üìÖ Pi√π vecchie (per data)</option>
<option value="a-z">üî§ A ‚Üí Z (Descrizione)</option>
<option value="z-a">üî§ Z ‚Üí A (Descrizione)</option>
<option value="importo-alto">üí∞ Importo (alto ‚Üí basso)</option>
<option value="importo-basso">üí∞ Importo (basso ‚Üí alto)</option>
</select>
</div>

<button onclick="resetAdvancedSearch()" style="width:100%;padding:14px;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;border:none;border-radius:12px;font-weight:700;font-size:1em;cursor:pointer;box-shadow:0 4px 12px rgba(231,76,60,0.3);margin-bottom:0;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(231,76,60,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(231,76,60,0.3)'">üóëÔ∏è Reset Tutti i Filtri</button>
</div>
</div>


<div class="filter-section-modern">
<label class="filter-label-modern">üìã Visualizzazione</label>
<div class="checkbox-modern">
<input type="checkbox" id="showAllTransactions" onchange="toggleMostraTutte()" class="checkbox-input-modern">
<label for="showAllTransactions" class="checkbox-label-modern">
<span class="checkbox-box-modern"></span>
<span class="checkbox-text-modern">
<span class="checkbox-text-full">Mostra tutte le transazioni (altrimenti solo mensili)</span>
<span class="checkbox-text-short">Mostra tutte (altrimenti mensili)</span>
</span>
</label>
</div>
</div>

<div class="filter-section-modern">
<label class="filter-label-modern">üîç Filtri Rapidi</label>
<div class="filter-row-modern">
<select id="filterType" onchange="aggFilterCats(); mostraTrans()" class="select-modern">
<option value="all">Tutti i tipi</option>
<option value="income">üìà Entrate</option>
<option value="expense">üìâ Uscite</option>
<option value="partner_payment">üë• Spesa Partner</option>
</select>
<select id="filterCat" onchange="mostraTrans()" class="select-modern">
<option value="all">Tutte</option>
</select>
</div>
</div>

<div class="stats">
<div><div class="label">Transazioni</div><div class="value" id="statsCount">0</div></div>
<div><div class="label">Totale</div><div class="value" id="statsTotal">‚Ç¨0</div></div>
</div>
</div>
<div id="transList"></div>
</div>

<div id="cats" class="section">
<div class="info-box"><strong>‚öôÔ∏è Gestisci Categorie</strong><br>Personalizza le tue categorie e la loro classificazione</div>

<div class="card">
<h3 style="color:var(--income);margin-bottom:15px;font-size:1.2em">üìà Categorie Entrate</h3>
<div id="catIn"></div>
<button class="btn" onclick="aggCat('income')">+ Aggiungi Entrata</button>
</div>

<div class="card">
<h3 style="color:var(--expense);margin-bottom:15px;font-size:1.2em">üìâ Categorie Uscite</h3>
<p style="font-size:0.9em;color:#7f8c8d;margin-bottom:15px">Gestisci le tue categorie di uscita e classificale come Necessit√† (65%) o Desideri (20%)</p>

<div style="margin-bottom:20px">
<h4 style="color:#e67e22;margin-bottom:12px;font-size:1em">üéØ Necessit√† (65%)</h4>
<div id="catNecessita"></div>
</div>

<div style="margin-bottom:20px">
<h4 style="color:#9b59b6;margin-bottom:12px;font-size:1em">üíé Desideri (20%)</h4>
<div id="catDesideri"></div>
</div>

<button class="btn" onclick="aggCatConClassificazione()">+ Aggiungi Uscita</button>
</div>
</div>

<div id="settings" class="section">
<div class="info-box"><strong>üîß Impostazioni</strong><br>Gestisci tema, backup e dati</div>

<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üìÖ Data Inizio Tracking</h3>
<div style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:20px;border-radius:12px;margin-bottom:15px;text-align:center">
<div style="font-size:0.9em;opacity:0.9;margin-bottom:8px">Stai tracciando dal</div>
<div style="font-size:2em;font-weight:800;margin-bottom:8px" id="trackingDateDisplay">Non impostata</div>
<div style="font-size:0.85em;opacity:0.9" id="trackingDays">Imposta una data per iniziare</div>
</div>
<div class="form-group">
<label>Seleziona data di inizio</label>
<input type="date" id="trackingDateInput" style="width:100%;padding:14px;border-radius:10px;border:2px solid var(--border);background:var(--bg);color:var(--text);font-size:1em">
</div>
<button class="btn" onclick="salvaDataTracking()">üíæ Salva Data Inizio</button>
<button class="btn btn-edit" onclick="resetDataTracking()">üîÑ Reimposta Data</button>
</div>

<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üé® Tema Interfaccia</h3>
<select id="themeSelect" onchange="cambiaTema()" style="width:100%;padding:14px;border-radius:10px;border:2px solid var(--border);background:var(--bg);color:var(--text);font-size:1em;font-weight:600">
<option value="light">‚òÄÔ∏è Chiaro</option>
<option value="dark">üåô Scuro</option>
<option value="auto">üîÑ Automatico</option>
</select>
</div>
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üíæ Gestione Dati</h3>
<button class="btn" onclick="condividiReport()">üì§ Condividi Report Mensile</button>
<button class="btn" onclick="esporta()">üì• Esporta Backup JSON</button>
<button class="btn btn-warning" onclick="mostraCSV()">üìä Visualizza Dati CSV</button>
<button class="btn btn-edit" onclick="document.getElementById('impFile').click()">üì§ Importa Backup</button>
<input type="file" id="impFile" accept=".json" style="display:none" onchange="importa(event)">
<button class="btn btn-danger" onclick="reset()">üóëÔ∏è Cancella Tutti i Dati</button>
</div>
<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üîä Suoni Feedback</h3>
<div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bg);border-radius:10px">
<span style="font-weight:600">Attiva suoni</span>
<label style="position:relative;display:inline-block;width:60px;height:34px">
<input type="checkbox" id="soundToggle" onchange="toggleSound()" style="opacity:0;width:0;height:0">
<span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:0.4s;border-radius:34px"></span>
<span id="soundSlider" style="position:absolute;content:'';height:26px;width:26px;left:4px;bottom:4px;background:#fff;transition:0.4s;border-radius:50%"></span>
</label>
</div>
</div>

<div class="card">
<h3 style="margin-bottom:15px;font-size:1.2em">üîê Sicurezza & PIN</h3>
<div style="display:flex;align-items:center;justify-content:space-between;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;margin-bottom:15px;color:#fff">
<div style="flex:1">
<div style="font-size:1em;font-weight:700;margin-bottom:4px">üîí Blocco con PIN</div>
<div style="font-size:0.85em;opacity:0.9">Proteggi i tuoi dati finanziari</div>
</div>
<label style="position:relative;display:inline-block;width:60px;height:34px">
<input type="checkbox" id="biometricToggle" onchange="toggleBiometric()" style="opacity:0;width:0;height:0">
<span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.3);transition:0.4s;border-radius:34px"></span>
<span id="biometricSlider" style="position:absolute;content:'';height:26px;width:26px;left:4px;bottom:4px;background:#fff;transition:0.4s;border-radius:50%"></span>
</label>
</div>
<button class="btn" onclick="cambiaPassword()" style="background:#3498db">üîë Cambia PIN di Sicurezza</button>
<button class="btn btn-edit" onclick="testaBiometric()">üß™ Testa Blocco PIN</button>
<p style="font-size:0.85em;color:#7f8c8d;margin-top:10px;line-height:1.4">
Quando attivo, l'app richieder√† un PIN a 6 cifre ogni volta che la apri. PIN predefinito: <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-weight:700">123456</code>
</p>
</div>
</div>

<div id="widgetFloat" class="widget-float" onclick="vai('dash', document.querySelectorAll('.nav-item')[0])" style="display:none">
<div class="widget-label">Saldo Mese</div>
<div class="widget-value" id="widgetValue">‚Ç¨0</div>
</div>

<div class="nav">
<div class="nav-item active" onclick="vai('dash', this)"><div class="nav-icon">üìä</div>Dashboard</div>
<div class="nav-item" onclick="vai('finanze', this)"><div class="nav-icon">üí∞</div>Finanze</div>
<div class="nav-item" onclick="vai('condiviso', this)"><div class="nav-icon">üë•</div>Condiviso</div>
<div class="nav-item" onclick="vai('trans', this)"><div class="nav-icon">üí≥</div>Movimenti</div>
<div class="nav-item" onclick="vai('obiettivi', this)"><div class="nav-icon">üéØ</div>Obiettivi</div>
<div class="nav-item" onclick="vai('cats', this)"><div class="nav-icon">‚öôÔ∏è</div>Categorie</div>
<div class="nav-item" onclick="vai('settings', this)"><div class="nav-icon">üîß</div>Impostazioni</div>
</div>

<div id="modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>Nuova Transazione</h3>
<button class="close-btn" onclick="chiudiModal()">&times;</button>
</div>
<form onsubmit="salva(event)">
<input type="hidden" id="tid">
<div class="form-group">
<label>Data *</label>
<input type="date" id="tdata" required>

</div>
<div class="form-group">
<label>Orario *</label>
<input type="time" id="tora" required>
</div>
<div class="form-group">
<label>Tipo *</label>
<select id="ttipo" onchange="aggCatSel()" required>
<option value="income">üìà Entrata</option>
<option value="expense">üìâ Uscita</option>
<option value="partner_payment">üë• Spesa Partner</option>
</select>
</div>
<div class="form-group">
<label>Categoria *</label>
<select id="tcat" required></select>
</div>
<div class="form-group">
<label>Importo (‚Ç¨) *</label>
<input type="number" id="timp" step="0.01" min="0.01" required>
</div>
<div class="form-group">
<div onclick="toggleCondivisoCustom()" style="display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none;padding:12px;background:var(--bg);border-radius:10px;border:2px solid var(--border);transition:all 0.3s">
<div id="customCheckbox" style="width:24px;height:24px;border:2px solid var(--income);border-radius:6px;display:flex;align-items:center;justify-content:center;background:#fff;flex-shrink:0;transition:all 0.3s">
<span id="checkIcon" style="display:none;font-size:16px;color:var(--income);font-weight:900">‚úì</span>
</div>
<input type="checkbox" id="tcondiviso" style="display:none">
<div style="flex:1">
<div style="font-size:1em;font-weight:600;color:var(--text)">üíë Spesa condivisa 50/50</div>
<div style="font-size:0.8em;color:#7f8c8d;margin-top:4px">Se attivato, la spesa sar√† considerata condivisa. Vedrai quanto recuperare nel dashboard.</div>
</div>
</div>
</div>
<div class="form-group">
<div onclick="toggleRecuperoVirtuale()" style="display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none;padding:12px;background:var(--bg);border-radius:10px;border:2px solid var(--border);transition:all 0.3s">
<div id="virtualCheckbox" style="width:24px;height:24px;border:2px solid #9b59b6;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#fff;flex-shrink:0;transition:all 0.3s">
<span id="virtualCheckIcon" style="display:none;font-size:16px;color:#9b59b6;font-weight:900">‚úì</span>
</div>
<input type="checkbox" id="tvirtual" style="display:none">
<div style="flex:1">
<div style="font-size:1em;font-weight:600;color:var(--text)">üíù Recupero Virtuale</div>
<div style="font-size:0.8em;color:#7f8c8d;margin-top:4px">Traccia la spesa ma usala come pagamento virtuale per ridurre il debito condiviso (non intacca il patrimonio personale)</div>
</div>
</div>
</div>
<div class="form-group">
<label>Note</label>
<textarea id="tnote" rows="3" placeholder="Descrizione opzionale..."></textarea>
</div>
<button type="submit" class="btn">üíæ Salva Transazione</button>
<button type="button" class="btn btn-danger" onclick="chiudiModal()">‚ùå Annulla</button>
</form>
</div>
</div>

<!-- MODAL CONFERMA PERSONALIZZATO -->
<div id="confirmModal" class="confirm-modal">
<div class="confirm-content">
<div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
<div class="confirm-title" id="confirmTitle">Conferma azione</div>
<div class="confirm-message" id="confirmMessage">Sei sicuro di voler procedere?</div>
<div class="confirm-buttons">
<button type="button" class="confirm-btn confirm-btn-cancel" onclick="chiudiConferma(false)">‚úï Annulla</button>
<button type="button" class="confirm-btn confirm-btn-confirm" id="confirmButton" onclick="chiudiConferma(true)">‚úì Conferma</button>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
var DB = {
  categorie: {
    income: ['Stipendio', 'Buoni Pasto', 'Altro'],
    expense: [
      'Affitto',
      'Altro',
      'Amazon',
      'Apple',
      'Autostrada',
      'Benzina',
      'Bombola',
      'Cofidis',
      'Farmacia',
      'Findomestic',
      'Fastweb Internet',
      'Shopping',
      'Assicurazioni Auto',
      'Luce',
      'Palestra',
      'Parrucchiere',
      'PayPal',
      'Prelievo',
      'Prozis',
      'Regali',
      'Spesa Supermercato',
      'Spesa Casa',
      'Spesa Altro',
      'Telefono',
      'Trasporti',
      'Uscite Locali',
      'Uscite Ristoranti',
      'Uscite Altro'
    ]
  },
  categorieClassificazione: {
    // Necessit√† (65%)
    'Affitto': 'necessita',
    'Luce': 'necessita',
    'Fastweb Internet': 'necessita',
    'Telefono': 'necessita',
    'Spesa Supermercato': 'necessita',
    'Spesa Casa': 'necessita',
    'Spesa Altro': 'necessita',
    'Benzina': 'necessita',
    'Autostrada': 'necessita',
    'Trasporti': 'necessita',
    'Assicurazioni Auto': 'necessita',
    'Bombola': 'necessita',
    'Cofidis': 'necessita',
    'Findomestic': 'necessita',
    'Farmacia': 'necessita',
    
    // Desideri (20%)
    'Amazon': 'desideri',
    'Apple': 'desideri',
    'Shopping': 'desideri',
    'Palestra': 'desideri',
    'Parrucchiere': 'desideri',
    'PayPal': 'desideri',
    'Prozis': 'desideri',
    'Regali': 'desideri',
    'Uscite Locali': 'desideri',
    'Uscite Ristoranti': 'desideri',
    'Uscite Altro': 'desideri',
    'Prelievo': 'desideri',
    'Altro': 'desideri'
  },
  transazioni: [],
  theme: 'auto',
  dataInizioTracking: null,
  speseCondivise: [], // Array per tracciare spese condivise
  budgetGoals: {}, // Obiettivi personalizzati: { categoria: budgetMensile }
  longTermGoals: [] // Obiettivi long-term multi-mese
};

var anno = new Date().getFullYear();
var mese = new Date().getMonth();
var lineChart, monthlyExpenseChart, balanceChart, compareChart;
var finanzePieChart, finanzeLineChart, savingsTrendChart; // Nuovi grafici per sezione finanze
var currentSection = 'dash';
var sections = ['dash', 'trans', 'finanze', 'obiettivi', 'calendario', 'cats', 'settings'];
var calendarYear = new Date().getFullYear();
var calendarMonth = new Date().getMonth();
var soundsEnabled = localStorage.getItem('soundsEnabled') === 'true';
var biometricEnabled = localStorage.getItem('biometricEnabled') === 'true';
var isAuthenticated = false;
var pinValue = '';
var mostraTutteTransazioni = false; // Mostra tutte o solo mensili
var ordinamentoTransazioni = 'recenti'; // recenti, vecchie, a-z, z-a, importo-alto, importo-basso
var annoTabelle = new Date().getFullYear(); // Anno per le tabelle riepilogo

// ========== SCHERMATA BLOCCO PIN (6 CIFRE) ==========
function mostraSchermataBlocco() {
  var overlay = document.createElement('div');
  overlay.id = 'biometricOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#667eea,#764ba2);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;padding:20px';
  
  overlay.innerHTML = `
    <div style="text-align:center;max-width:400px;width:100%">
      <div style="font-size:4em;margin-bottom:20px">üîí</div>
      <h2 style="font-size:1.8em;margin-bottom:10px;font-weight:800">Budget Manager Pro</h2>
      <p style="font-size:0.95em;opacity:0.9;margin-bottom:35px">Inserisci il tuo PIN</p>
      
      <!-- Display PIN dots (6 cifre) -->
      <div id="pinDisplay" style="display:flex;justify-content:center;gap:12px;margin-bottom:40px">
        <div class="pin-dot"></div>
        <div class="pin-dot"></div>
        <div class="pin-dot"></div>
        <div class="pin-dot"></div>
        <div class="pin-dot"></div>
        <div class="pin-dot"></div>
      </div>
      
      <!-- Numeric keypad -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:18px;max-width:300px;margin:0 auto">
        <button class="pin-btn" onmousedown="handlePinClick(event, '1')" ontouchstart="handlePinClick(event, '1')">1</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '2')" ontouchstart="handlePinClick(event, '2')">2</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '3')" ontouchstart="handlePinClick(event, '3')">3</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '4')" ontouchstart="handlePinClick(event, '4')">4</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '5')" ontouchstart="handlePinClick(event, '5')">5</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '6')" ontouchstart="handlePinClick(event, '6')">6</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '7')" ontouchstart="handlePinClick(event, '7')">7</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '8')" ontouchstart="handlePinClick(event, '8')">8</button>
        <button class="pin-btn" onmousedown="handlePinClick(event, '9')" ontouchstart="handlePinClick(event, '9')">9</button>
        <div style="width:75px;height:75px"></div>
        <button class="pin-btn" onmousedown="handlePinClick(event, '0')" ontouchstart="handlePinClick(event, '0')">0</button>
        <button class="pin-btn pin-delete" onmousedown="handlePinClick(event, 'delete')" ontouchstart="handlePinClick(event, 'delete')">‚å´</button>
      </div>
    </div>
  `;
  
  // Aggiungi stili per i pulsanti PIN
  var style = document.createElement('style');
  style.textContent = `
    .pin-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: transparent;
      transition: all 0.15s ease-out;
    }
    .pin-dot.filled {
      background: #fff;
      border-color: #fff;
      box-shadow: 0 0 20px rgba(255,255,255,0.7);
      transform: scale(1.15);
    }
    .pin-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      font-size: 1.9em;
      font-weight: 600;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.08s ease-out, background 0.08s ease-out;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      width: 75px;
      height: 75px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position: relative;
    }
    .pin-btn:active {
      transform: scale(0.85);
      background: rgba(255,255,255,0.45);
    }
    .pin-btn.pressed {
      transform: scale(0.85);
      background: rgba(255,255,255,0.45);
    }
    .pin-delete {
      background: rgba(255,255,255,0.15);
      font-size: 1.6em;
    }
    @media (max-width: 400px) {
      .pin-btn {
        width: 65px;
        height: 65px;
        font-size: 1.6em;
      }
      .pin-delete {
        font-size: 1.4em;
      }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(overlay);
  pinValue = '';
}

// Gestione click/touch ottimizzata
var lastPinAction = 0;

function handlePinClick(event, value) {
  // Previeni doppia esecuzione (touch genera anche mouse event)
  var now = Date.now();
  if (now - lastPinAction < 200) {
    event.preventDefault();
    return;
  }
  lastPinAction = now;
  
  event.preventDefault();
  event.stopPropagation();
  
  var btn = event.currentTarget;
  
  // Feedback visivo immediato
  btn.classList.add('pressed');
  
  // Vibrazione tattile su iPhone (se supportato)
  if (navigator.vibrate) {
    navigator.vibrate(5);
  }
  
  // Esegui immediatamente l'azione
  if (value === 'delete') {
    cancellaPinDigit();
  } else {
    aggiungiPinDigit(value);
  }
  
  // Rimuovi effetto pressed dopo animazione
  setTimeout(function() {
    btn.classList.remove('pressed');
  }, 100);
}

function aggiungiPinDigit(digit) {
  if (pinValue.length < 6) {
    pinValue += digit;
    aggiornaPinDisplay();
    playSound('click');
    
    // Verifica automaticamente quando raggiunge 6 cifre
    if (pinValue.length === 6) {
      setTimeout(verificaPin, 300);
    }
  }
}

function cancellaPinDigit() {
  if (pinValue.length > 0) {
    pinValue = pinValue.slice(0, -1);
    aggiornaPinDisplay();
    playSound('click');
  }
}

function aggiornaPinDisplay() {
  var dots = document.querySelectorAll('.pin-dot');
  dots.forEach(function(dot, index) {
    if (index < pinValue.length) {
      dot.classList.add('filled');
    } else {
      dot.classList.remove('filled');
    }
  });
}

function verificaPin() {
  var savedPin = localStorage.getItem('appPin') || '123456';
  
  if (pinValue === savedPin) {
    isAuthenticated = true;
    rimuoviSchermataBlocco();
    mostraToast('‚úÖ Autenticazione riuscita!', 'success');
    playSound('success');
  } else {
    // PIN errato - shake animation
    var display = document.getElementById('pinDisplay');
    if (display) {
      display.style.animation = 'shake 0.5s';
      setTimeout(function() {
        display.style.animation = '';
      }, 500);
    }
    mostraToast('‚ùå PIN errato!', 'danger');
    playSound('error');
    pinValue = '';
    aggiornaPinDisplay();
  }
}

// Aggiungi animazione shake
var shakeStyle = document.createElement('style');
shakeStyle.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
  }
`;
document.head.appendChild(shakeStyle);

function rimuoviSchermataBlocco() {
  var overlay = document.getElementById('biometricOverlay');
  if (overlay) {
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 0.5s';
    setTimeout(function() {
      overlay.remove();
    }, 500);
  }
}


// ========== SUONI FEEDBACK ==========
function playSound(type) {
  if (!soundsEnabled) return;
  
  var freq = {success: 800, error: 300, click: 600};
  var audioContext = new (window.AudioContext || window.webkitAudioContext)();
  var oscillator = audioContext.createOscillator();
  var gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = freq[type] || 600;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.1);
}

function toggleSound() {
  soundsEnabled = document.getElementById('soundToggle').checked;
  localStorage.setItem('soundsEnabled', soundsEnabled);
  playSound('click');
  
  var slider = document.getElementById('soundSlider');
  if (soundsEnabled) {
    slider.style.transform = 'translateX(26px)';
    slider.parentElement.style.background = '#27ae60';
  } else {
    slider.style.transform = 'translateX(0)';
    slider.parentElement.style.background = '#ccc';
  }
}

function aggiornaToggleSound() {
  document.getElementById('soundToggle').checked = soundsEnabled;
  var slider = document.getElementById('soundSlider');
  if (soundsEnabled) {
    slider.style.transform = 'translateX(26px)';
    slider.parentElement.style.background = '#27ae60';
  } else {
    slider.style.transform = 'translateX(0)';
    slider.parentElement.style.background = '#ccc';
  }
}

function toggleBiometric() {
  biometricEnabled = document.getElementById('biometricToggle').checked;
  localStorage.setItem('biometricEnabled', biometricEnabled);
  
  var slider = document.getElementById('biometricSlider');
  if (biometricEnabled) {
    slider.style.transform = 'translateX(26px)';
    slider.parentElement.style.background = '#27ae60';
    mostraToast('üîê Blocco PIN attivato!', 'success');
    playSound('success');
  } else {
    slider.style.transform = 'translateX(0)';
    slider.parentElement.style.background = 'rgba(255,255,255,0.3)';
    isAuthenticated = false;
    mostraToast('üîì Blocco PIN disattivato', 'warning');
  }
}

function aggiornaToggleBiometric() {
  var toggle = document.getElementById('biometricToggle');
  var slider = document.getElementById('biometricSlider');
  if (!toggle || !slider) return;
  
  toggle.checked = biometricEnabled;
  if (biometricEnabled) {
    slider.style.transform = 'translateX(26px)';
    slider.parentElement.style.background = '#27ae60';
  } else {
    slider.style.transform = 'translateX(0)';
    slider.parentElement.style.background = 'rgba(255,255,255,0.3)';
  }
}

function cambiaPassword() {
  var vecchioPin = localStorage.getItem('appPin') || '123456';
  var input = prompt('üîë Inserisci il PIN attuale (6 cifre):\n\n(PIN predefinito: 123456)');
  
  if (input !== vecchioPin) {
    mostraToast('‚ùå PIN errato!', 'danger');
    return;
  }
  
  var nuovoPin = prompt('üîê Inserisci il NUOVO PIN (6 cifre):');
  
  if (!nuovoPin || nuovoPin.length !== 6 || !/^\d{6}$/.test(nuovoPin)) {
    mostraToast('‚ö†Ô∏è Il PIN deve essere di 6 cifre!', 'warning');
    return;
  }
  
  var conferma = prompt('üîê Conferma il NUOVO PIN (6 cifre):');
  
  if (nuovoPin !== conferma) {
    mostraToast('‚ùå I PIN non coincidono!', 'danger');
    return;
  }
  
  localStorage.setItem('appPin', nuovoPin);
  mostraToast('‚úÖ PIN cambiato con successo!', 'success');
  playSound('success');
}

function testaBiometric() {
  isAuthenticated = false;
  mostraSchermataBlocco();
}

// ========== FUNZIONE ARROTONDAMENTO SPLITWISE ==========
function splitAmount(amount) {
  // Divide per 2 e arrotonda come Splitwise (0.5 va verso l'alto)
  return Math.round((amount / 2) * 100) / 100;
}

// ========== CARICAMENTO E SALVATAGGIO ==========
function carica() {
  try {
    var s = localStorage.getItem('budgetDBPro');
    if (s) {
      DB = JSON.parse(s);
      if (!DB.theme) DB.theme = 'auto';
      if (!DB.categorie) DB.categorie = { income: ['Stipendio'], expense: ['Spesa'] };
      if (!DB.transazioni) DB.transazioni = [];
      if (!DB.dataInizioTracking) DB.dataInizioTracking = null;
      if (!DB.budgetGoals) DB.budgetGoals = {};
      if (!DB.longTermGoals) DB.longTermGoals = [];
      if (!DB.categorieClassificazione) {
        // Inizializza classificazione per utenti esistenti
        DB.categorieClassificazione = {
          'Affitto': 'necessita',
          'Luce': 'necessita',
          'Fastweb Internet': 'necessita',
          'Telefono': 'necessita',
          'Spesa Supermercato': 'necessita',
          'Spesa Casa': 'necessita',
          'Spesa Altro': 'necessita',
          'Benzina': 'necessita',
          'Autostrada': 'necessita',
          'Trasporti': 'necessita',
          'Assicurazioni Auto': 'necessita',
          'Bombola': 'necessita',
          'Cofidis': 'necessita',
          'Findomestic': 'necessita',
          'Farmacia': 'necessita',
          'Amazon': 'desideri',
          'Apple': 'desideri',
          'Shopping': 'desideri',
          'Palestra': 'desideri',
          'Parrucchiere': 'desideri',
          'PayPal': 'desideri',
          'Prozis': 'desideri',
          'Regali': 'desideri',
          'Uscite Locali': 'desideri',
          'Uscite Ristoranti': 'desideri',
          'Uscite Altro': 'desideri',
          'Prelievo': 'desideri',
          'Altro': 'desideri'
        };
      }
    }
  } catch (e) {
    // Errore caricamento dati
  }
}

function salvaDB() {
  try {
    localStorage.setItem('budgetDBPro', JSON.stringify(DB));
    // Clear memo cache quando cambiano i dati
    if (typeof clearMemoCache === 'function') {
      clearMemoCache();
    }
  } catch (e) {
    mostraToast('‚ùå Errore durante il salvataggio', 'danger');
  }
}

// ========== TOAST NOTIFICATIONS ==========
// ========== TOAST NOTIFICATIONS MIGLIORATE ==========
function mostraToast(messaggio, tipo) {
  tipo = tipo || 'success';
  
  // Crea container se non esiste
  var container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  
  var icons = {
    success: '‚úÖ',
    error: '‚ùå',
    danger: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  var toast = document.createElement('div');
  toast.className = 'toast ' + tipo;
  toast.innerHTML = '<div class="toast-icon">' + (icons[tipo] || icons.success) + '</div>' +
                    '<div class="toast-message">' + messaggio + '</div>';
  
  container.appendChild(toast);
  
  // Haptic feedback su iOS
  if (window.navigator && window.navigator.vibrate) {
    window.navigator.vibrate(tipo === 'success' ? 50 : 100);
  }
  
  setTimeout(function() {
    if (toast.parentNode) {
      container.removeChild(toast);
    }
  }, 3000);
}

// ========== LOADING OVERLAY ==========
function mostraLoading() {
  var overlay = document.createElement('div');
  overlay.id = 'loading-overlay';
  overlay.className = 'loading-overlay';
  overlay.innerHTML = '<div class="spinner"></div>';
  document.body.appendChild(overlay);
  return overlay;
}

function nascondiLoading() {
  var overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.style.opacity = '0';
    setTimeout(function() {
      if (overlay.parentNode) {
        document.body.removeChild(overlay);
      }
    }, 300);
  }
}

// ========== SUCCESS ANIMATION ==========
function mostraSuccessAnimation(callback) {
  var modal = document.getElementById('modal');
  if (!modal) return;
  
  modal.classList.add('active');
  var html = '<div class="modal-content" style="text-align:center;padding:40px">';
  html += '<div class="success-checkmark">';
  html += '<div class="check-icon">';
  html += '<span class="icon-line line-tip"></span>';
  html += '<span class="icon-line line-long"></span>';
  html += '</div></div>';
  html += '<h3 style="color:var(--income);margin-top:20px">Salvato con successo!</h3>';
  html += '</div>';
  
  modal.querySelector('.modal-content').innerHTML = html;
  
  setTimeout(function() {
    chiudiModal();
    if (callback) callback();
  }, 1500);
}

// ========== SHAKE ANIMATION FOR ERRORS ==========
function shakeElement(elementId) {
  var el = document.getElementById(elementId);
  if (el) {
    el.style.animation = 'shake 0.5s';
    setTimeout(function() {
      el.style.animation = '';
    }, 500);
  }
}

// ========== GESTIONE TEMA ==========
function applyTheme() {
  var theme = DB.theme;
  if (theme === 'auto') {
    var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    theme = isDark ? 'dark' : 'light';
  }
  document.body.className = theme === 'dark' ? 'dark' : '';
  document.querySelector('.theme-btn').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('themeSelect').value = DB.theme;
  
  if (lineChart || compareChart) {
    setTimeout(function() { aggiorna(); }, 100);
  }
}

function toggleTheme() {
  var cur = document.body.classList.contains('dark') ? 'dark' : 'light';
  DB.theme = cur === 'dark' ? 'light' : 'dark';
  salvaDB();
  applyTheme();
}

function cambiaTema() {
  DB.theme = document.getElementById('themeSelect').value;
  salvaDB();
  applyTheme();
}

// ========== NAVIGAZIONE ==========
function vaiOggi() {
  var oggi = new Date();
  anno = oggi.getFullYear();
  mese = oggi.getMonth();
  
  document.getElementById('year').value = anno;
  document.getElementById('month').value = mese;
  
  aggiorna();
  if (currentSection === 'trans') mostraTrans();
  if (currentSection === 'analysis') mostraAnalisi();
  
  mostraToast('üìÖ Tornato a oggi!', 'info');
}

// Funzione per aggiornare lo stile dei bottoni "Oggi"
function aggiornaBottoniOggi() {
  var oggi = new Date();
  var meseCurrent = oggi.getMonth();
  var annoCurrent = oggi.getFullYear();
  var isOggi = (anno === annoCurrent && mese === meseCurrent);
  
  var bottoni = ['oggiDashboard', 'oggiFinanze', 'oggiObiettivi', 'oggiCondiviso', 'oggiMovimenti'];
  
  bottoni.forEach(function(id) {
    var btn = document.getElementById(id);
    if (btn) {
      if (isOggi) {
        // Stile viola quando siamo sul mese corrente
        btn.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.boxShadow = '0 4px 12px rgba(102,126,234,0.4)';
      } else {
        // Stile outline quando NON siamo sul mese corrente
        btn.style.background = 'var(--card)';
        btn.style.color = '#667eea';
        btn.style.border = '2px solid #667eea';
        btn.style.boxShadow = 'none';
      }
    }
  });
}


function vai(sec, elem) {
  document.querySelectorAll('.section').forEach(function(s) {
    s.classList.remove('active');
  });
  document.querySelectorAll('.nav-item').forEach(function(n) {
    n.classList.remove('active');
  });
  document.getElementById(sec).classList.add('active');
  if (elem) elem.classList.add('active');
  
  currentSection = sec;
  
  if (sec === 'dash') aggiorna();
  if (sec === 'condiviso') mostraCondiviso();
  if (sec === 'finanze') { annoTabelle = anno; aggiornaRisparmio(); mostraAnalisi(); calcolaPrevisioni(); inizializzaSelettoriConfronto(); }
  if (sec === 'obiettivi') mostraObiettivi();
  if (sec === 'trans') { aggFilterCats(); aggiornaMovimentiMese(); mostraTrans(); }
  if (sec === 'cats') mostraCats();
  if (sec === 'settings') { mostraDataTracking(); aggiornaToggleSound(); aggiornaToggleBiometric(); }
  
  aggiornaWidget();
  window.scrollTo({ top: 0, behavior: 'smooth' });
  playSound('click');
}

// ========== SEZIONE CONDIVISO ==========

var condivisoAnno = new Date().getFullYear();
var condivisoMese = new Date().getMonth();
var condivisoTab = 'mensile';
var condivisoTrendChart, condivisoEvoluzioneChart, condivisoTopCategorieChart;
var condivisoExpanded = false;

function toggleCondiviso() {
  condivisoExpanded = !condivisoExpanded;
  var content = document.getElementById('condivisoContent');
  var icon = document.getElementById('condivisoToggleIcon');
  
  if (condivisoExpanded) {
    content.style.display = 'block';
    icon.textContent = '‚ñ≤';
    icon.style.transform = 'rotate(180deg)';
  } else {
    content.style.display = 'none';
    icon.textContent = '‚ñº';
    icon.style.transform = 'rotate(0deg)';
  }
  
  playSound('click');
}

function mostraCondiviso() {
  // Sincronizza con data globale
  condivisoAnno = anno;
  condivisoMese = mese;
  aggiornaCondivisoMeseDisplay();
  mostraTabCondiviso(condivisoTab);
}

function mostraTabCondiviso(tab) {
  condivisoTab = tab;
  
  // Aggiorna tab attivi
  document.getElementById('tabMensile').style.opacity = tab === 'mensile' ? '1' : '0.6';
  document.getElementById('tabAnnuale').style.opacity = tab === 'annuale' ? '1' : '0.6';
  document.getElementById('tabTotale').style.opacity = tab === 'totale' ? '1' : '0.6';
  
  // Mostra/nascondi viste
  document.getElementById('condivisoMensile').style.display = tab === 'mensile' ? 'block' : 'none';
  document.getElementById('condivisoAnnuale').style.display = tab === 'annuale' ? 'block' : 'none';
  document.getElementById('condivisoTotale').style.display = tab === 'totale' ? 'block' : 'none';
  
  if (tab === 'mensile') aggiornaCondivisoMensile();
  if (tab === 'annuale') aggiornaCondivisoAnnuale();
  if (tab === 'totale') aggiornaCondivisoTotale();
  
  playSound('click');
}

function aggiornaCondivisoMensile() {
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  document.getElementById('condivisoMeseCorrente').textContent = mesiNomi[condivisoMese] + ' ' + condivisoAnno;
  
  var tue = 0, sue = 0, tueCount = 0, sueCount = 0;
  var categorie = {};
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === condivisoAnno && d.getMonth() === condivisoMese) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'expense' && t.condiviso && !t.virtualRecovery) {
        tue += imp;
        tueCount++;
        categorie[t.categoria] = (categorie[t.categoria] || 0) + imp;
      } else if (t.tipo === 'partner_payment' && t.condiviso && !t.virtualRecovery) {
        sue += imp;
        sueCount++;
        categorie[t.categoria] = (categorie[t.categoria] || 0) + imp;
      }
    }
  });
  
  var tot = tue + sue;
  var daRec = (tue - sue) / 2;
  
  document.getElementById('condivisoTueMese').textContent = formatEuro(tue);
  document.getElementById('condivisoTueTransMese').textContent = tueCount + ' transazioni';
  document.getElementById('condivisoSueMese').textContent = formatEuro(sue);
  document.getElementById('condivisoSueTransMese').textContent = sueCount + ' transazioni';
  document.getElementById('condivisoTotaleMese').textContent = formatEuro(tot);
  document.getElementById('condivisoQuotaMese').textContent = formatEuro(tot / 2);
  document.getElementById('condivisoDaRecMese').textContent = formatEuro(Math.abs(daRec));
  
  var card = document.getElementById('condivisoDaRecMeseCard');
  var label = document.getElementById('condivisoDaRecLabel');
  var expl = document.getElementById('condivisoDaRecExpl');
  
  if (daRec > 0.01) {
    card.style.background = 'linear-gradient(135deg,#e8f5e9,#c8e6c9)';
    card.style.borderColor = '#4caf50';
    document.getElementById('condivisoDaRecMese').style.color = '#2e7d32';
    label.textContent = 'üí∞ Partner Ti Deve';
    label.style.color = '#2e7d32';
    expl.textContent = 'Tu hai pagato ' + formatEuro(daRec) + ' in pi√π';
    expl.style.color = '#2e7d32';
  } else if (daRec < -0.01) {
    card.style.background = 'linear-gradient(135deg,#ffebee,#ffcdd2)';
    card.style.borderColor = '#f44336';
    document.getElementById('condivisoDaRecMese').style.color = '#c62828';
    label.textContent = 'üí∏ Tu Le Devi';
    label.style.color = '#c62828';
    expl.textContent = 'Partner ha pagato ' + formatEuro(Math.abs(daRec)) + ' in pi√π';
    expl.style.color = '#c62828';
  } else {
    card.style.background = 'linear-gradient(135deg,#f5f5f5,#e0e0e0)';
    card.style.borderColor = '#9e9e9e';
    document.getElementById('condivisoDaRecMese').style.color = '#616161';
    label.textContent = '‚úÖ Pari';
    label.style.color = '#616161';
    expl.textContent = 'Bilancio in pareggio questo mese';
    expl.style.color = '#616161';
  }
  
  // Top Categorie
  var sorted = Object.entries(categorie).sort(function(a,b) { return b[1] - a[1]; }).slice(0, 10);
  var html = '';
  if (sorted.length === 0) {
    html = '<p style="text-align:center;opacity:0.6;padding:20px">Nessuna spesa condivisa questo mese</p>';
  } else {
    sorted.forEach(function(item, idx) {
      var perc = (item[1] / tot * 100).toFixed(1);
      html += '<div style="margin-bottom:12px">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:4px">';
      html += '<span style="font-weight:600">' + (idx + 1) + '. ' + item[0] + '</span>';
      html += '<span style="font-weight:700;color:var(--expense)">‚Ç¨' + item[1].toFixed(0) + ' (' + perc + '%)</span>';
      html += '</div>';
      html += '<div style="background:#e0e0e0;height:8px;border-radius:4px;overflow:hidden">';
      html += '<div style="background:linear-gradient(90deg,#667eea,#764ba2);height:100%;width:' + perc + '%"></div>';
      html += '</div>';
      html += '</div>';
    });
  }
  document.getElementById('condivisoTopCategorieMese').innerHTML = html;
}

function aggiornaCondivisoAnnuale() {
  document.getElementById('condivisoAnnoCorrente').textContent = condivisoAnno;
  
  var tue = 0, sue = 0;
  var perMese = [];
  for (var m = 0; m < 12; m++) {
    perMese[m] = { tue: 0, sue: 0, daRec: 0 };
  }
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === condivisoAnno) {
      var imp = parseFloat(t.importo) || 0;
      var m = d.getMonth();
      if (t.tipo === 'expense' && t.condiviso && !t.virtualRecovery) {
        tue += imp;
        perMese[m].tue += imp;
      } else if (t.tipo === 'partner_payment' && t.condiviso && !t.virtualRecovery) {
        sue += imp;
        perMese[m].sue += imp;
      }
    }
  });
  
  perMese.forEach(function(m) { m.daRec = (m.tue - m.sue) / 2; });
  var daRecAnno = (tue - sue) / 2;
  
  document.getElementById('condivisoTueAnno').textContent = formatEuro(tue);
  document.getElementById('condivisoTueMediaAnno').textContent = formatEuro(tue / 12);
  document.getElementById('condivisoSueAnno').textContent = formatEuro(sue);
  document.getElementById('condivisoSueMediaAnno').textContent = formatEuro(sue / 12);
  document.getElementById('condivisoDaRecAnno').textContent = formatEuro(Math.abs(daRecAnno));
  
  // Grafico Trend
  var isDark = document.body.classList.contains('dark');
  if (condivisoTrendChart) condivisoTrendChart.destroy();
  var ctx = document.getElementById('condivisoTrendChart').getContext('2d');
  condivisoTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'],
      datasets: [
        {
          label: 'Tue Condivise',
          data: perMese.map(function(m) { return m.tue; }),
          borderColor: '#2196f3',
          backgroundColor: 'rgba(33,150,243,0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3
        },
        {
          label: 'Sue Condivise',
          data: perMese.map(function(m) { return m.sue; }),
          borderColor: '#9c27b0',
          backgroundColor: 'rgba(156,39,176,0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: {
          callbacks: {
            label: function(ctx) { return ctx.dataset.label + ': ‚Ç¨' + ctx.parsed.y.toFixed(0); }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: function(v) { return '‚Ç¨' + v; }, color: isDark ? '#999' : '#666' },
          grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
        },
        x: { ticks: { color: isDark ? '#999' : '#666' }, grid: { display: false } }
      }
    }
  });
  
  // Storico Mensile con design a card
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  var html = '<div style="display:grid;gap:12px">';
  
  var hasData = false;
  perMese.forEach(function(m, idx) {
    if (m.tue > 0 || m.sue > 0) {
      hasData = true;
      var color = m.daRec > 0 ? '#27ae60' : (m.daRec < 0 ? '#e74c3c' : '#9e9e9e');
      var bgGradient = m.daRec > 0 
        ? 'linear-gradient(135deg, #e8f5e9, #c8e6c9)'
        : (m.daRec < 0 ? 'linear-gradient(135deg, #ffebee, #ffcdd2)' : 'linear-gradient(135deg, #f5f5f5, #e0e0e0)');
      var icon = m.daRec > 0 ? 'üí∞' : (m.daRec < 0 ? 'üí∏' : '‚úÖ');
      var label = m.daRec > 0 ? 'Partner ti deve' : (m.daRec < 0 ? 'Tu devi a Partner' : 'Pari');
      
      html += '<div style="background:' + bgGradient + ';border-radius:12px;padding:16px;border:2px solid ' + color + '">';
      
      // Header con mese e icona
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
      html += '<h4 style="margin:0;font-size:1.1em;color:#333">' + mesiNomi[idx] + '</h4>';
      html += '<span style="font-size:1.5em">' + icon + '</span>';
      html += '</div>';
      
      // Spese una sopra l'altra
      html += '<div style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:12px">';
      
      html += '<div style="background:rgba(255,255,255,0.7);padding:10px;border-radius:8px;text-align:center">';
      html += '<div style="font-size:0.75em;color:#1976d2;font-weight:600;margin-bottom:4px">üí≥ Tu</div>';
      html += '<div style="font-size:1.2em;font-weight:800;color:#1565c0">‚Ç¨' + m.tue.toFixed(0) + '</div>';
      html += '</div>';
      
      html += '<div style="background:rgba(255,255,255,0.7);padding:10px;border-radius:8px;text-align:center">';
      html += '<div style="font-size:0.75em;color:#7b1fa2;font-weight:600;margin-bottom:4px">üë§ Partner</div>';
      html += '<div style="font-size:1.2em;font-weight:800;color:#6a1b9a">‚Ç¨' + m.sue.toFixed(0) + '</div>';
      html += '</div>';
      
      html += '</div>';
      
      // Risultato
      html += '<div style="text-align:center;padding:10px;background:rgba(255,255,255,0.8);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#666;font-weight:600;margin-bottom:4px">' + label + '</div>';
      html += '<div style="font-size:1.4em;font-weight:900;color:' + color + '">';
      html += (m.daRec > 0 ? '+' : '') + '‚Ç¨' + Math.abs(m.daRec).toFixed(0);
      html += '</div>';
      html += '</div>';
      
      html += '</div>';
    }
  });
  
  if (!hasData) {
    html += '<div style="text-align:center;padding:40px;color:#999;font-size:1.1em">üì≠ Nessuna spesa condivisa quest\'anno</div>';
  }
  
  html += '</div>';
  document.getElementById('condivisoStoricoAnno').innerHTML = html;
}

function aggiornaCondivisoTotale() {
  var tue = 0, sue = 0;
  var prima = null, ultima = null;
  var perMese = {};
  var categorie = {};
  var virtualRecoveryTu = 0, virtualRecoveryPartner = 0;
  var prestiti = 0;
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    var imp = parseFloat(t.importo) || 0;
    if (t.tipo === 'expense' && t.condiviso && !t.virtualRecovery) {
      tue += imp;
      if (!prima || d < prima) prima = d;
      if (!ultima || d > ultima) ultima = d;
      var key = d.getFullYear() + '-' + (d.getMonth() + 1);
      perMese[key] = perMese[key] || { tue: 0, sue: 0 };
      perMese[key].tue += imp;
      categorie[t.categoria] = (categorie[t.categoria] || 0) + imp;
    } else if (t.tipo === 'expense' && t.virtualRecovery) {
      virtualRecoveryTu += imp;
    } else if (t.tipo === 'partner_payment' && t.condiviso && !t.virtualRecovery) {
      sue += imp;
      if (!prima || d < prima) prima = d;
      if (!ultima || d > ultima) ultima = d;
      var key = d.getFullYear() + '-' + (d.getMonth() + 1);
      perMese[key] = perMese[key] || { tue: 0, sue: 0 };
      perMese[key].sue += imp;
      categorie[t.categoria] = (categorie[t.categoria] || 0) + imp;
    } else if (t.tipo === 'partner_payment' && t.virtualRecovery) {
      virtualRecoveryPartner += imp;
    } else if (t.tipo === 'partner_payment' && !t.condiviso) {
      prestiti += imp;
    }
  });
  
  var tot = tue + sue;
  var daRecBase = (tue - sue) / 2;
  var daRecReale = daRecBase - prestiti + virtualRecoveryTu - virtualRecoveryPartner;
  
  var mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
  if (prima) {
    var txt = mesiNomi[prima.getMonth()] + ' ' + prima.getFullYear();
    if (ultima && (ultima.getTime() !== prima.getTime())) {
      txt += ' - ' + mesiNomi[ultima.getMonth()] + ' ' + ultima.getFullYear();
    }
    document.getElementById('condivisoPeriodoTotale').textContent = '(' + txt + ')';
  }
  
  document.getElementById('condivisoTueTotale').textContent = formatEuro(tue);
  document.getElementById('condivisoSueTotale').textContent = formatEuro(sue);
  document.getElementById('condivisoTotaleTotale').textContent = formatEuro(tot);
  document.getElementById('condivisoQuotaTotale').textContent = formatEuro(tot / 2);
  document.getElementById('condivisoDaRecTotale').textContent = formatEuro(Math.abs(daRecReale));
  
  var expl = document.getElementById('condivisoDaRecTotaleExpl');
  if (daRecReale > 0.01) {
    document.getElementById('condivisoDaRecTotale').style.color = '#fff';
    expl.textContent = 'Lei ti deve dall\'inizio';
  } else if (daRecReale < -0.01) {
    document.getElementById('condivisoDaRecTotale').style.color = '#fff';
    expl.textContent = 'Tu le devi dall\'inizio';
  } else {
    document.getElementById('condivisoDaRecTotale').style.color = '#fff';
    expl.textContent = 'Bilancio in pareggio';
  }
  
  // Grafico Evoluzione
  var sorted = Object.keys(perMese).sort();
  var cumulativo = [];
  var cum = 0;
  sorted.forEach(function(key) {
    cum += (perMese[key].tue - perMese[key].sue) / 2;
    cumulativo.push({ mese: key, val: cum });
  });
  
  var isDark = document.body.classList.contains('dark');
  if (condivisoEvoluzioneChart) condivisoEvoluzioneChart.destroy();
  var ctx = document.getElementById('condivisoEvoluzioneChart').getContext('2d');
  condivisoEvoluzioneChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: cumulativo.map(function(c) { return c.mese; }),
      datasets: [{
        label: 'Da Recuperare Cumulativo',
        data: cumulativo.map(function(c) { return c.val; }),
        borderColor: '#667eea',
        backgroundColor: 'rgba(102,126,234,0.2)',
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) { return 'Saldo: ‚Ç¨' + ctx.parsed.y.toFixed(2); }
          }
        }
      },
      scales: {
        y: {
          ticks: { callback: function(v) { return '‚Ç¨' + v; }, color: isDark ? '#999' : '#666' },
          grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
        },
        x: { ticks: { color: isDark ? '#999' : '#666' }, grid: { display: false } }
      }
    }
  });
  
  // Top Categorie
  var sortedCat = Object.entries(categorie).sort(function(a,b) { return b[1] - a[1]; }).slice(0, 15);
  var colors = sortedCat.map(function(c, i) {
    var intensity = 1 - (i / sortedCat.length * 0.6);
    return 'rgba(' + Math.round(102*intensity+153*(1-intensity)) + ',' + Math.round(126*intensity+100*(1-intensity)) + ',234,0.8)';
  });
  
  if (condivisoTopCategorieChart) condivisoTopCategorieChart.destroy();
  var ctx2 = document.getElementById('condivisoTopCategorieChart').getContext('2d');
  condivisoTopCategorieChart = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: sortedCat.map(function(c) { return c[0]; }),
      datasets: [{
        data: sortedCat.map(function(c) { return c[1]; }),
        backgroundColor: colors,
        borderColor: colors.map(function(c) { return c.replace('0.8)', '1)'); }),
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) { 
              var perc = ((ctx.parsed.x / tot) * 100).toFixed(1);
              return ' ‚Ç¨' + ctx.parsed.x.toFixed(0) + ' (' + perc + '%)';
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { callback: function(v) { return '‚Ç¨' + (v >= 1000 ? (v/1000).toFixed(1) + 'k' : v); }, color: isDark ? '#999' : '#666' },
          grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
        },
        y: { ticks: { color: isDark ? '#eee' : '#2c3e50' }, grid: { display: false } }
      }
    }
  });
  
  // Storico Completo con design timeline visivo
  var html = '<div style="position:relative;padding-left:50px">';
  
  // Linea timeline verticale
  html += '<div style="position:absolute;left:24px;top:30px;bottom:30px;width:4px;background:linear-gradient(180deg,#667eea,#764ba2);border-radius:2px;opacity:0.3"></div>';
  
  sorted.forEach(function(key, idx) {
    var m = perMese[key];
    var daRecMese = (m.tue - m.sue) / 2;
    var cumVal = cumulativo[idx].val;
    
    var colorMese = daRecMese > 0 ? '#27ae60' : (daRecMese < 0 ? '#e74c3c' : '#9e9e9e');
    var colorCum = cumVal > 0 ? '#27ae60' : (cumVal < 0 ? '#e74c3c' : '#9e9e9e');
    var iconMese = daRecMese > 0 ? 'üí∞' : (daRecMese < 0 ? 'üí∏' : '‚úÖ');
    var bgCard = '#fff';
    
    html += '<div style="position:relative;margin-bottom:20px;background:' + bgCard + ';border-radius:14px;padding:18px;border:3px solid ' + colorCum + ';box-shadow:0 4px 12px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.transform=\'translateX(5px)\';this.style.boxShadow=\'0 6px 20px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'">';
    
    // Punto sulla timeline
    html += '<div style="position:absolute;left:-42px;top:24px;width:30px;height:30px;background:' + colorCum + ';border-radius:50%;border:5px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;font-size:0.8em;font-weight:900;color:#fff">' + (idx + 1) + '</div>';
    
    // Header: Data e icona
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">';
    html += '<div>';
    html += '<h4 style="margin:0;font-size:1.15em;color:#667eea;font-weight:800">' + key + '</h4>';
    html += '<div style="font-size:0.75em;color:#999;margin-top:3px">Progressione #' + (idx + 1) + '</div>';
    html += '</div>';
    html += '<span style="font-size:2em">' + iconMese + '</span>';
    html += '</div>';
    
    // Spese del mese in grid
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px">';
    
    html += '<div style="background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:12px;border-radius:10px;text-align:center;border:2px solid #2196f3">';
    html += '<div style="font-size:0.7em;color:#1976d2;margin-bottom:4px;font-weight:700">üí≥ TU</div>';
    html += '<div style="font-size:1.1em;font-weight:900;color:#1565c0">‚Ç¨' + m.tue.toFixed(0) + '</div>';
    html += '</div>';
    
    html += '<div style="background:linear-gradient(135deg,#f3e5f5,#e1bee7);padding:12px;border-radius:10px;text-align:center;border:2px solid #9c27b0">';
    html += '<div style="font-size:0.7em;color:#7b1fa2;margin-bottom:4px;font-weight:700">üë§ LEI</div>';
    html += '<div style="font-size:1.1em;font-weight:900;color:#6a1b9a">‚Ç¨' + m.sue.toFixed(0) + '</div>';
    html += '</div>';
    
    var deltaBg = daRecMese > 0 ? 'linear-gradient(135deg,#e8f5e9,#c8e6c9)' : (daRecMese < 0 ? 'linear-gradient(135deg,#ffebee,#ffcdd2)' : 'linear-gradient(135deg,#f5f5f5,#e0e0e0)');
    var deltaBorder = daRecMese > 0 ? '#4caf50' : (daRecMese < 0 ? '#f44336' : '#9e9e9e');
    html += '<div style="background:' + deltaBg + ';padding:12px;border-radius:10px;text-align:center;border:2px solid ' + deltaBorder + '">';
    html += '<div style="font-size:0.7em;color:' + colorMese + ';margin-bottom:4px;font-weight:700">üìä DELTA</div>';
    html += '<div style="font-size:1.1em;font-weight:900;color:' + colorMese + '">' + (daRecMese > 0 ? '+' : '') + '‚Ç¨' + Math.abs(daRecMese).toFixed(0) + '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // Cumulativo in grande evidenza
    var cumBg = cumVal > 0 ? 'linear-gradient(135deg,#667eea,#764ba2)' : (cumVal < 0 ? 'linear-gradient(135deg,#e74c3c,#c0392b)' : 'linear-gradient(135deg,#95a5a6,#7f8c8d)');
    html += '<div style="background:' + cumBg + ';padding:16px;border-radius:12px;text-align:center;box-shadow:0 4px 12px rgba(102,126,234,0.4)">';
    html += '<div style="font-size:0.75em;color:#fff;opacity:0.95;margin-bottom:6px;font-weight:700;letter-spacing:0.5px">üí∞ TOTALE PROGRESSIVO</div>';
    html += '<div style="font-size:1.8em;font-weight:900;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.2)">' + (cumVal > 0 ? '+' : '') + '‚Ç¨' + Math.abs(cumVal).toFixed(0) + '</div>';
    html += '<div style="font-size:0.75em;color:#fff;margin-top:6px;opacity:0.9">' + (cumVal > 0 ? '‚úÖ Lei ti deve dall\'inizio' : (cumVal < 0 ? '‚ö†Ô∏è Tu le devi dall\'inizio' : '‚úÖ In pareggio')) + '</div>';
    html += '</div>';
    
    html += '</div>';
  });
  
  html += '</div>';
  
  // Legenda
  html += '<div style="margin-top:20px;padding:16px;background:linear-gradient(135deg,rgba(102,126,234,0.05),rgba(118,75,162,0.05));border-radius:12px;border:2px solid rgba(102,126,234,0.2)">';
  html += '<div style="font-weight:800;margin-bottom:8px;color:#667eea">üìñ Legenda:</div>';
  html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:0.85em">';
  html += '<div>üí∞ = Lei ti deve questo mese</div>';
  html += '<div>üí∏ = Tu le devi questo mese</div>';
  html += '<div style="color:#27ae60;font-weight:600">‚óè Verde = Saldo a tuo favore</div>';
  html += '<div style="color:#e74c3c;font-weight:600">‚óè Rosso = Saldo a suo favore</div>';
  html += '</div>';
  html += '</div>';
  
  document.getElementById('condivisoStoricoCompleto').innerHTML = html;
}

function cambiaCondivisoMese(delta) {
  condivisoMese += delta;
  if (condivisoMese < 0) { condivisoMese = 11; condivisoAnno--; }
  if (condivisoMese > 11) { condivisoMese = 0; condivisoAnno++; }
  
  // Sincronizza con data globale
  anno = condivisoAnno;
  mese = condivisoMese;
  
  aggiornaCondivisoMensile();
  aggiornaCondivisoMeseDisplay();
  aggiornaBottoniOggi();
  playSound('click');
}

function vaiOggiCondiviso() {
  var oggi = new Date();
  condivisoAnno = oggi.getFullYear();
  condivisoMese = oggi.getMonth();
  
  // Sincronizza con data globale
  anno = condivisoAnno;
  mese = condivisoMese;
  
  aggiornaCondivisoMensile();
  aggiornaCondivisoMeseDisplay();
  aggiornaBottoniOggi();
  playSound('click');
}

function aggiornaCondivisoMeseDisplay() {
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  var elem = document.getElementById('condivisoMeseDisplay');
  if (elem) {
    elem.textContent = mesiNomi[condivisoMese] + ' ' + condivisoAnno;
  }
}

function toggleCondiviso() {
  var content = document.getElementById('condivisoContent');
  var icon = document.getElementById('condivisoToggleIcon');
  
  if (content.style.maxHeight && content.style.maxHeight !== '0px') {
    // Chiudi
    content.style.maxHeight = '0px';
    icon.style.transform = 'rotate(-90deg)';
  } else {
    // Apri
    content.style.maxHeight = content.scrollHeight + 'px';
    icon.style.transform = 'rotate(0deg)';
  }
  playSound('click');
}


// ========== GESTIONE ANNI ==========
function aggAnni() {
  var sel = document.getElementById('year');
  sel.innerHTML = '';
  for (var y = 2020; y <= 2099; y++) {
    var o = document.createElement('option');
    o.value = y;
    o.textContent = y;
    if (y === anno) o.selected = true;
    sel.appendChild(o);
  }
}

// ========== DASHBOARD PRINCIPALE ==========
function aggiorna() {
  var yearSelect = document.getElementById('year');
  var monthSelect = document.getElementById('month');
  
  if (!yearSelect || !monthSelect) {
    // Elementi non ancora disponibili, ritenta dopo
    setTimeout(aggiorna, 100);
    return;
  }
  
  anno = parseInt(yearSelect.value);
  mese = parseInt(monthSelect.value);
  
  // Sincronizza Condiviso con data globale
  condivisoAnno = anno;
  condivisoMese = mese;
  
  // Se siamo nella sezione Condiviso, aggiorna subito
  if (currentSection === 'condiviso') {
    aggiornaCondivisoMensile();
  }
  
  var pat = 0, ent = 0, usc = 0, partnerPaid = 0;
  var dist = {};
  var trend = { 
    entrate: [0,0,0,0,0,0,0,0,0,0,0,0], 
    uscite: [0,0,0,0,0,0,0,0,0,0,0,0] 
  };
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    var imp = parseFloat(t.importo) || 0;
    
    if (t.tipo === 'income') {
      pat += imp;
      if (d.getFullYear() === anno) {
        trend.entrate[d.getMonth()] += imp;
        if (d.getMonth() === mese) ent += imp;
      }
    } else if (t.tipo === 'partner_payment') {
      // Lei paga - NON influenza patrimonio, entrate o uscite
      // Popola solo dist per le statistiche categorie (SOLO spese condivise, no prestiti)
      if (d.getFullYear() === anno && d.getMonth() === mese && t.condiviso && !t.virtualRecovery) {
        partnerPaid += imp;
        // Conta la tua met√† delle spese condivise
        var importoDaContare = splitAmount(imp);
        dist[t.categoria] = (dist[t.categoria] || 0) + importoDaContare;
      }
    } else if (t.tipo === 'expense') {
      // Spesa normale o condivisa
      // Se √® un recupero virtuale, NON intacca il patrimonio
      if (!t.virtualRecovery) {
        pat -= imp; // Patrimonio ridotto solo se NON √® recupero virtuale
      }
      if (d.getFullYear() === anno) {
        // Trend: esclude recuperi virtuali
        if (!t.virtualRecovery) {
          trend.uscite[d.getMonth()] += imp;
        }
        if (d.getMonth() === mese) {
          // STATISTICHE: Esclude recuperi virtuali
          if (!t.virtualRecovery) {
            // Se condiviso, conta solo la tua met√†
            if (t.condiviso) {
              var tuaMet√† = splitAmount(imp);
              dist[t.categoria] = (dist[t.categoria] || 0) + tuaMet√†;
            } else {
              // Non condiviso: conta tutto
              dist[t.categoria] = (dist[t.categoria] || 0) + imp;
            }
          }
        }
      }
    }
  });
  
  document.getElementById('pat').textContent = formatEuro(pat);
  document.getElementById('ent').textContent = formatEuro(ent);
  
  // DASHBOARD: Calcola le uscite REALI dal conto (soldi fisicamente usciti)
  var usciteReali = 0;
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese && t.tipo === 'expense' && !t.virtualRecovery) {
      usciteReali += parseFloat(t.importo) || 0;
    }
  });
  
  document.getElementById('usc').textContent = formatEuro(usciteReali);
  var saldo = ent - usciteReali;
  document.getElementById('saldo').textContent = formatEuro(saldo);
  
  // FINANZE: Calcola uscite EFFETTIVE (costo reale con spese condivise divise)
  var usciteEffettive = 0;
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'expense' && !t.virtualRecovery) {
        // Se condiviso, conta solo la tua met√†
        usciteEffettive += t.condiviso ? splitAmount(imp) : imp;
      } else if (t.tipo === 'partner_payment' && t.condiviso && !t.virtualRecovery) {
        // Sue spese condivise: conta la tua met√†
        usciteEffettive += splitAmount(imp);
      }
    }
  });
  
  // Usa usciteEffettive per le STATISTICHE e Finanze
  usc = usciteEffettive;
  
  // Calcola spese condivise e quanto ha pagato lei - TUTTI I MESI (non solo quello corrente)
  var speseCondivise = 0;
  var leiHaPagatoCondiviso = 0;
  var leiHaPagatoNonCondiviso = 0; // Prestiti
  var recuperiVirtualiTuPaghi = 0; // Tu dai virtualmente a lei (AUMENTA suo debito)
  var recuperiVirtualiLeiPaga = 0; // Lei ti d√† virtualmente (RIDUCE suo debito)
  
  DB.transazioni.forEach(function(t) {
    // RIMUOVO IL FILTRO PER MESE - considera TUTTE le transazioni
    if (t.tipo === 'expense' && t.condiviso && !t.virtualRecovery) {
      speseCondivise += parseFloat(t.importo) || 0;
    } else if (t.tipo === 'partner_payment') {
      var imp = parseFloat(t.importo) || 0;
      if (t.virtualRecovery) {
        // Lei ti d√† virtualmente - RIDUCE suo debito
        recuperiVirtualiLeiPaga += imp;
      } else if (t.condiviso) {
        leiHaPagatoCondiviso += imp;
      } else {
        leiHaPagatoNonCondiviso += imp; // Prestito - tutto
      }
    } else if (t.tipo === 'expense' && t.virtualRecovery) {
      // Tu le dai virtualmente - AUMENTA suo debito
      recuperiVirtualiTuPaghi += parseFloat(t.importo) || 0;
    }
  });
  
  // Da recuperare = (tue spese condivise / 2) - (sue spese condivise / 2) - (prestiti) + (tu le dai virtualmente) - (lei ti d√† virtualmente)
  var daRecuperare = splitAmount(speseCondivise) - splitAmount(leiHaPagatoCondiviso) - leiHaPagatoNonCondiviso + recuperiVirtualiTuPaghi - recuperiVirtualiLeiPaga;
  
  // Arrotonda il risultato finale a 2 decimali
  daRecuperare = Math.round(daRecuperare * 100) / 100;
  
  var leiHaPagatoTotale = leiHaPagatoCondiviso + leiHaPagatoNonCondiviso;
  
  // Aggiorna le metriche condivise
  if (document.getElementById('leiHaPagato')) {
    document.getElementById('leiHaPagato').textContent = formatEuro(leiHaPagatoTotale);
  }
  if (document.getElementById('speseCondivise')) {
    var totaleCondiviso = speseCondivise + leiHaPagatoCondiviso;
    document.getElementById('speseCondivise').textContent = formatEuro(totaleCondiviso);
  }
  if (document.getElementById('daRecuperare')) {
    // Mostra sempre il valore assoluto con il segno nel testo
    var valoreMostrato = Math.abs(daRecuperare);
    document.getElementById('daRecuperare').textContent = formatEuro(valoreMostrato);
    
    var colorRecuperare = '#f39c12'; // Default giallo
    var labelText = '‚úÖ Pari';
    var labelIcon = '‚úÖ';
    
    if (daRecuperare > 0.01) {
      // Lei ti deve soldi
      colorRecuperare = '#27ae60'; // Verde
      labelText = 'üí∞ Da Recuperare';
      labelIcon = 'üí∞';
    } else if (daRecuperare < -0.01) {
      // Tu le devi soldi
      colorRecuperare = '#e74c3c'; // Rosso
      labelText = 'üí∏ Da Rimborsare';
      labelIcon = 'üí∏';
    }
    
    document.getElementById('daRecuperare').style.color = colorRecuperare;
    
    // Aggiorna anche l'etichetta
    if (document.getElementById('daRecuperareLabel')) {
      document.getElementById('daRecuperareLabel').textContent = labelText;
      document.getElementById('daRecuperareLabel').style.color = colorRecuperare;
    }
  }
  
  // ========== CALCOLA METRICHE CONDIVISE MENSILI ==========
  var tueSpeseCondiviseMese = 0;
  var sueSpeseCondiviseMese = 0;
  var tueSpeseCondiviseCount = 0;
  var sueSpeseCondiviseCount = 0;
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'expense' && t.condiviso && !t.virtualRecovery) {
        tueSpeseCondiviseMese += imp;
        tueSpeseCondiviseCount++;
      } else if (t.tipo === 'partner_payment' && t.condiviso && !t.virtualRecovery) {
        sueSpeseCondiviseMese += imp;
        sueSpeseCondiviseCount++;
      }
    }
  });
  
  var totaleCondivisoMese = tueSpeseCondiviseMese + sueSpeseCondiviseMese;
  var daRecuperareMese = (tueSpeseCondiviseMese - sueSpeseCondiviseMese) / 2;
  
  // Aggiorna UI metriche mensili
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  
  if (document.getElementById('sharedMonth')) {
    document.getElementById('sharedMonth').textContent = mesiNomi[mese] + ' ' + anno;
  }
  
  if (document.getElementById('tueSpeseCondiviseMese')) {
    document.getElementById('tueSpeseCondiviseMese').textContent = formatEuro(tueSpeseCondiviseMese);
  }
  if (document.getElementById('tueSpeseCondiviseCount')) {
    document.getElementById('tueSpeseCondiviseCount').textContent = tueSpeseCondiviseCount + ' transazioni';
  }
  
  if (document.getElementById('sueSpeseCondiviseMese')) {
    document.getElementById('sueSpeseCondiviseMese').textContent = formatEuro(sueSpeseCondiviseMese);
  }
  if (document.getElementById('sueSpeseCondiviseCount')) {
    document.getElementById('sueSpeseCondiviseCount').textContent = sueSpeseCondiviseCount + ' transazioni';
  }
  
  if (document.getElementById('totaleCondivisoMese')) {
    document.getElementById('totaleCondivisoMese').textContent = formatEuro(totaleCondivisoMese);
  }
  
  if (document.getElementById('daRecuperareMese')) {
    var valoreMese = Math.abs(daRecuperareMese);
    document.getElementById('daRecuperareMese').textContent = formatEuro(valoreMese);
    
    var cardMese = document.getElementById('daRecuperareMeseCard');
    var labelMese = document.getElementById('daRecuperareMeseLabel');
    var explMese = document.getElementById('daRecuperareMeseExpl');
    
    if (daRecuperareMese > 0.01) {
      // Lei ti deve questo mese
      cardMese.style.background = 'linear-gradient(135deg,#e8f5e9,#c8e6c9)';
      cardMese.style.borderColor = '#4caf50';
      document.getElementById('daRecuperareMese').style.color = '#2e7d32';
      labelMese.textContent = 'üí∞ Da Recuperare Mese';
      labelMese.style.color = '#2e7d32';
      explMese.textContent = 'Lei ti deve per questo mese';
      explMese.style.color = '#2e7d32';
    } else if (daRecuperareMese < -0.01) {
      // Tu le devi questo mese
      cardMese.style.background = 'linear-gradient(135deg,#ffebee,#ffcdd2)';
      cardMese.style.borderColor = '#f44336';
      document.getElementById('daRecuperareMese').style.color = '#c62828';
      labelMese.textContent = 'üí∏ Da Rimborsare Mese';
      labelMese.style.color = '#c62828';
      explMese.textContent = 'Tu le devi per questo mese';
      explMese.style.color = '#c62828';
    } else {
      // Pari questo mese
      cardMese.style.background = 'linear-gradient(135deg,#f5f5f5,#e0e0e0)';
      cardMese.style.borderColor = '#9e9e9e';
      document.getElementById('daRecuperareMese').style.color = '#616161';
      labelMese.textContent = '‚úÖ Pari Questo Mese';
      labelMese.style.color = '#616161';
      explMese.textContent = 'Bilancio in pareggio';
      explMese.style.color = '#616161';
    }
  }
  
  if (document.getElementById('daRecuperarePeriodo')) {
    // Calcola periodo tracking
    var primaData = null;
    DB.transazioni.forEach(function(t) {
      if (t.tipo === 'expense' && t.condiviso || t.tipo === 'partner_payment' && t.condiviso) {
        var d = new Date(t.data);
        if (!primaData || d < primaData) primaData = d;
      }
    });
    
    if (primaData) {
      var mesePrima = mesiNomi[primaData.getMonth()];
      var annoPrima = primaData.getFullYear();
      document.getElementById('daRecuperarePeriodo').textContent = 'Da ' + mesePrima + ' ' + annoPrima;
    }
  }
  
  // TUTTE LE SPESE con separazione visiva
  var allExpenses = Object.entries(dist).sort(function(a,b) { return b[1] - a[1]; });
  var topHtml = '';
  if (allExpenses.length === 0) {
    topHtml = '<div class="empty">‚ú® Nessuna spesa registrata questo mese</div>';
  } else {
    var totalSpese = allExpenses.reduce(function(sum, item) { return sum + item[1]; }, 0);
    topHtml += '<div style="max-height:400px;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:4px">';
    allExpenses.forEach(function(item) {
      var cat = item[0];
      var amount = item[1];
      var percent = totalSpese > 0 ? (amount / totalSpese * 100) : 0;
      topHtml += '<div class="top-expense" style="margin-bottom:16px;box-shadow:0 3px 10px rgba(0,0,0,0.1)">';
      topHtml += '<div class="info"><div class="name">' + cat + '</div>';
      topHtml += '<div class="percent">' + percent.toFixed(1) + '% del totale</div>';
      topHtml += '<div class="progress-bar" style="margin-top:8px"><div class="progress-fill" style="width:' + Math.min(percent, 100) + '%"></div></div></div>';
      topHtml += '<div class="amount">' + formatEuro(amount) + '</div></div>';
    });
    topHtml += '</div><div style="height:2px;background:linear-gradient(to right,transparent,var(--border),transparent);margin:20px 0"></div>';
    topHtml += '<div class="metrics" style="margin-top:15px">';
    topHtml += '<div class="metric"><h4>üìä Categorie</h4><div class="val" style="color:var(--income)">' + allExpenses.length + '</div></div>';
    topHtml += '<div class="metric"><h4>üí∞ Totale</h4><div class="val" style="color:var(--expense)">' + formatEuro(totalSpese) + '</div></div>';
    topHtml += '</div>';
  }
  document.getElementById('topExpenses').innerHTML = topHtml;
  
  // ========== CALENDAR HEATMAP ==========
  generaCalendarHeatmap(mese, anno);
  
  // ========== GRAFICO SPESE VS ENTRATE ULTIMI 6 MESI ==========
  generaGraficoConfronto6Mesi();
  
  
  // Aggiorna anche le altre sezioni se sono attive
  if (currentSection === 'finanze') { aggiornaRisparmio(); mostraAnalisi(); calcolaPrevisioni(); }
  if (currentSection === 'trans') mostraTrans();
  if (currentSection === 'calendario') mostraCalendario();
  
  // Mostra alert nella dashboard
  mostraAlertDashboard();
  
  aggiornaWidget();
  
  // Aggiorna stile bottoni "Oggi"
  aggiornaBottoniOggi();
}

// ========== ANALISI UNIFICATA ==========
function mostraAnalisi() {
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  
  // Aggiorna i riferimenti all'anno
  document.getElementById('spendingYear').textContent = anno;
  document.getElementById('analysisMese').textContent = mesiNomi[mese] + ' ' + anno;
  
  var totaleAnnoSpese = 0;
  var totaleAnnoEntrate = 0;
  var spesePerMese = [0,0,0,0,0,0,0,0,0,0,0,0];
  var entratePerMese = [0,0,0,0,0,0,0,0,0,0,0,0];
  var categorieAnno = {};
  
  // Calcola totali anno
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno) {
      var imp = parseFloat(t.importo) || 0;
      var m = d.getMonth();
      
      if (t.tipo === 'expense' && !t.virtualRecovery) {
        // Se condiviso, conta solo la tua met√†
        var importoEffettivo = t.condiviso ? splitAmount(imp) : imp;
        totaleAnnoSpese += importoEffettivo;
        spesePerMese[m] += importoEffettivo;
        categorieAnno[t.categoria] = (categorieAnno[t.categoria] || 0) + importoEffettivo;
      } else if (t.tipo === 'partner_payment' && t.condiviso && !t.virtualRecovery) {
        // Spesa di lei condivisa - conta solo la tua met√†
        var importoDaContare = splitAmount(imp);
        totaleAnnoSpese += importoDaContare;
        spesePerMese[m] += importoDaContare;
        categorieAnno[t.categoria] = (categorieAnno[t.categoria] || 0) + importoDaContare;
      } else if (t.tipo === 'income') {
        totaleAnnoEntrate += imp;
        entratePerMese[m] += imp;
      }
    }
  });
  
  // Aggiorna riepilogo anno
  document.getElementById('totalYearExpense').textContent = formatEuro(totaleAnnoSpese);
  document.getElementById('totalYearIncome').textContent = formatEuro(totaleAnnoEntrate);
  document.getElementById('avgMonthExpense').textContent = 'Media: ' + formatEuro(totaleAnnoSpese / 12) + '/mese';
  document.getElementById('avgMonthIncome').textContent = 'Media: ' + formatEuro(totaleAnnoEntrate / 12) + '/mese';
  
  // Calcola e aggiorna riepilogo mese corrente
  var speseMeseCorrente = spesePerMese[mese] || 0;
  var entrateMeseCorrente = entratePerMese[mese] || 0;
  
  if (document.getElementById('currentMonthExpense')) {
    document.getElementById('currentMonthExpense').textContent = formatEuro(speseMeseCorrente);
  }
  if (document.getElementById('currentMonthIncome')) {
    document.getElementById('currentMonthIncome').textContent = formatEuro(entrateMeseCorrente);
  }
  
  // Grafico confronto mensile spese
  var isDark = document.body.classList.contains('dark');
  if (monthlyExpenseChart) monthlyExpenseChart.destroy();
  var ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
  monthlyExpenseChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'],
      datasets: [{
        label: 'Spese Mensili',
        data: spesePerMese,
        backgroundColor: 'rgba(230,126,34,0.7)',
        borderColor: '#e67e22',
        borderWidth: 2,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Spese: ‚Ç¨' + context.parsed.y.toFixed(2);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) { return '‚Ç¨' + value; },
            color: isDark ? '#999' : '#666'
          },
          grid: {
            color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
          }
        },
        x: {
          ticks: { color: isDark ? '#999' : '#666' },
          grid: { display: false }
        }
      }
    }
  });
  
  // GRAFICO DISTRIBUZIONE SPESE ANNO (Barre Orizzontali)
  // Aggiorna anno nel titolo
  if (document.getElementById('distribAnno')) {
    document.getElementById('distribAnno').textContent = anno;
  }
  
  var spesePerCategoriaAnno = {};
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'expense') {
        // Se condiviso, conta solo la tua met√†
        var importoEffettivo = t.condiviso ? splitAmount(imp) : imp;
        spesePerCategoriaAnno[t.categoria] = (spesePerCategoriaAnno[t.categoria] || 0) + importoEffettivo;
      } else if (t.tipo === 'partner_payment') {
        // Spesa di lei - se condiviso met√†, altrimenti tutto (prestito)
        var importoDaContare = t.condiviso ? splitAmount(imp) : imp;
        spesePerCategoriaAnno[t.categoria] = (spesePerCategoriaAnno[t.categoria] || 0) + importoDaContare;
      }
    }
  });
  
  // Ordina le categorie per importo (dal pi√π alto al pi√π basso) - TUTTE le categorie
  var categorieOrdinate = Object.entries(spesePerCategoriaAnno)
    .sort(function(a, b) { return b[1] - a[1]; });
  
  var labelsCategorie = categorieOrdinate.map(function(item) { return item[0]; });
  var valoriCategorie = categorieOrdinate.map(function(item) { return item[1]; });
  
  // Genera colori sfumati dal rosso scuro al rosso chiaro
  var coloriGradiente = valoriCategorie.map(function(val, idx) {
    var intensita = 1 - (idx / valoriCategorie.length * 0.6); // Da 1 a 0.4
    var r = Math.round(231 * intensita + 255 * (1 - intensita));
    var g = Math.round(76 * intensita + 200 * (1 - intensita));
    var b = Math.round(60 * intensita + 200 * (1 - intensita));
    return 'rgba(' + r + ',' + g + ',' + b + ',0.8)';
  });
  
  if (finanzePieChart) finanzePieChart.destroy();
  var ctxPie = document.getElementById('finanzePieChart').getContext('2d');
  finanzePieChart = new Chart(ctxPie, {
    type: 'bar',
    data: {
      labels: labelsCategorie,
      datasets: [{
        label: 'Spesa Annuale',
        data: valoriCategorie,
        backgroundColor: coloriGradiente,
        borderColor: coloriGradiente.map(function(c) { 
          return c.replace('0.8)', '1)'); 
        }),
        borderWidth: 2,
        borderRadius: 8,
        barThickness: 'flex',
        maxBarThickness: 40
      }]
    },
    options: {
      indexAxis: 'y', // Barre orizzontali
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          padding: 12,
          titleFont: { size: 13, weight: 'bold' },
          bodyFont: { size: 12 },
          callbacks: {
            label: function(context) {
              var value = context.parsed.x || 0;
              var total = valoriCategorie.reduce(function(a, b) { return a + b; }, 0);
              var percent = ((value / total) * 100).toFixed(1);
              return ' ‚Ç¨' + value.toFixed(0) + ' (' + percent + '%)';
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: function(value) { 
              return '‚Ç¨' + (value >= 1000 ? (value/1000).toFixed(1) + 'k' : value); 
            },
            color: isDark ? '#999' : '#666',
            font: { size: 11, weight: '600' }
          },
          grid: {
            color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
          }
        },
        y: {
          ticks: { 
            color: isDark ? '#eee' : '#2c3e50',
            font: { size: 12, weight: '700' }
          },
          grid: { display: false }
        }
      }
    }
  });
  
  // GRAFICO TREND ANNUALE ENTRATE VS USCITE (Line Chart)
  if (finanzeLineChart) finanzeLineChart.destroy();
  var ctxLine = document.getElementById('finanzeLineChart').getContext('2d');
  finanzeLineChart = new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'],
      datasets: [
        {
          label: 'Entrate',
          data: entratePerMese,
          borderColor: '#27ae60',
          backgroundColor: 'rgba(39,174,96,0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'Uscite',
          data: spesePerMese,
          borderColor: '#e67e22',
          backgroundColor: 'rgba(230,126,34,0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          position: 'top',
          labels: { 
            boxWidth: 12, 
            font: { size: 11, weight: '600' },
            padding: 10,
            color: isDark ? '#eee' : '#2c3e50'
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ‚Ç¨' + context.parsed.y.toFixed(2);
            }
          }
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: {
            callback: function(value) { return '‚Ç¨' + value; },
            color: isDark ? '#999' : '#666'
          },
          grid: {
            color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
          }
        },
        x: {
          ticks: { color: isDark ? '#999' : '#666' },
          grid: {
            color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
          }
        }
      }
    }
  });
  
  // GRAFICO TENDENZA RISPARMIO - mostra % risparmiato mese per mese
  var percentualiRisparmio = [];
  for (var m = 0; m < 12; m++) {
    if (entratePerMese[m] > 0) {
      var risparmiatoMese = entratePerMese[m] - spesePerMese[m];
      var percRisp = (risparmiatoMese / entratePerMese[m]) * 100;
      percentualiRisparmio.push(percRisp);
    } else {
      percentualiRisparmio.push(0);
    }
  }
  
  // TENDENZA RISPARMIO MENSILE - Custom Visualization
  var container = document.getElementById('savingsTrendCustom');
  if (container) {
    var html = '';
    var mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    
    for (var m = 0; m < 12; m++) {
      var percRisp = percentualiRisparmio[m];
      var meseNome = mesiNomi[m];
      
      // Calcola importo risparmiato
      var risparmiato = entratePerMese[m] - spesePerMese[m];
      var importoText = risparmiato !== 0 ? formatEuro(Math.abs(risparmiato)) : '‚Ç¨0';
      
      // Determina colore e icona in base alla percentuale
      var color, bgColor, icon, status;
      if (percRisp >= 15) {
        color = '#27ae60';
        bgColor = 'rgba(39,174,96,0.1)';
        icon = '‚úÖ';
        status = 'Ottimo';
      } else if (percRisp >= 10) {
        color = '#f39c12';
        bgColor = 'rgba(243,156,18,0.1)';
        icon = '‚ö†Ô∏è';
        status = 'Sufficiente';
      } else if (percRisp > 0) {
        color = '#e74c3c';
        bgColor = 'rgba(231,76,60,0.1)';
        icon = '‚ùå';
        status = 'Basso';
      } else if (risparmiato < 0) {
        // Caso in perdita (spese > entrate)
        color = '#e74c3c';
        bgColor = 'rgba(231,76,60,0.15)';
        icon = 'üî¥';
        status = 'In Perdita';
      } else {
        color = '#95a5a6';
        bgColor = 'rgba(149,165,166,0.1)';
        icon = '‚ö™';
        status = 'N/D';
      }
      
      html += '<div style="padding:12px;background:' + bgColor + ';border-radius:10px;border:2px solid ' + color + ';text-align:center">';
      html += '<div style="font-size:0.85em;font-weight:700;color:' + color + ';margin-bottom:6px">' + meseNome + '</div>';
      html += '<div style="font-size:1.5em;margin-bottom:4px">' + icon + '</div>';
      
      // Importo risparmiato
      html += '<div style="font-size:1.1em;font-weight:800;color:' + color + ';margin-bottom:2px">' + (risparmiato < 0 ? '-' : '') + importoText + '</div>';
      
      // Percentuale
      html += '<div style="font-size:1em;font-weight:700;color:' + color + ';opacity:0.8;margin-bottom:4px">' + percRisp.toFixed(1) + '%</div>';
      
      html += '<div style="font-size:0.7em;opacity:0.8;color:' + color + '">' + status + '</div>';
      html += '</div>';
    }
    
    container.innerHTML = html;
  }
  
  // Fine della funzione mostraAnalisi - rimosse sezioni non necessarie
}

// ========== SELETTORE PERIODO ==========
function mostraAlertDashboard() {
  var container = document.getElementById('dashboardAlerts');
  if (!container) return;
  
  var alerts = [];
  
  // Calcola spese del mese corrente per categoria
  var speseCategoria = {};
  var entrateMese = 0;
  var speseMese = 0;
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'income') {
        entrateMese += imp;
      } else if (t.tipo === 'expense') {
        speseMese += imp;
        speseCategoria[t.categoria] = (speseCategoria[t.categoria] || 0) + imp;
      }
    }
  });
  
  // A. ALERT CRITICI (rossi)
  // Budget sforato >100%
  Object.keys(DB.budgetGoals).forEach(function(cat) {
    var budget = DB.budgetGoals[cat];
    var speso = speseCategoria[cat] || 0;
    var perc = budget > 0 ? (speso / budget * 100) : 0;
    
    if (perc > 100) {
      alerts.push({
        type: 'critical',
        icon: '‚ùå',
        message: '<strong>' + cat + '</strong>: budget sforato al ' + perc.toFixed(0) + '% (' + formatEuro(speso) + ' / ' + formatEuro(budget) + ')',
        action: 'obiettivi'
      });
    }
  });
  
  // Obiettivo risparmio 15% a rischio
  if (entrateMese > 0) {
    var risparmiato = entrateMese - speseMese;
    var percRisparmio = (risparmiato / entrateMese) * 100;
    
    if (percRisparmio < 10) {
      alerts.push({
        type: 'critical',
        icon: '‚ùå',
        message: 'Risparmi critici: solo <strong>' + percRisparmio.toFixed(1) + '%</strong> (obiettivo 15%)',
        action: 'finanze'
      });
    }
  }
  
  // B. WARNING (gialli)
  // Budget quasi sforato >90%
  Object.keys(DB.budgetGoals).forEach(function(cat) {
    var budget = DB.budgetGoals[cat];
    var speso = speseCategoria[cat] || 0;
    var perc = budget > 0 ? (speso / budget * 100) : 0;
    
    if (perc > 90 && perc <= 100) {
      var rimanente = budget - speso;
      alerts.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        message: '<strong>' + cat + '</strong>: budget al ' + perc.toFixed(0) + '% (rimangono ' + formatEuro(rimanente) + ')',
        action: 'obiettivi'
      });
    }
  });
  
  // Sotto obiettivo risparmio 15%
  if (entrateMese > 0) {
    var risparmiato = entrateMese - speseMese;
    var percRisparmio = (risparmiato / entrateMese) * 100;
    var obiettivo = entrateMese * 0.15;
    var mancanti = obiettivo - risparmiato;
    
    if (percRisparmio >= 10 && percRisparmio < 15 && mancanti > 0) {
      alerts.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        message: 'Risparmi sotto obiettivo: <strong>' + percRisparmio.toFixed(1) + '%</strong> (mancano ' + formatEuro(mancanti) + ' per 15%)',
        action: 'finanze'
      });
    }
  }
  
  // C. INFO (blu)
  var now = new Date();
  if (now.getDate() === 1 && anno === now.getFullYear() && mese === now.getMonth()) {
    alerts.push({
      type: 'info',
      icon: '‚ÑπÔ∏è',
      message: 'Nuovo mese iniziato! Controlla i tuoi obiettivi',
      action: 'obiettivi'
    });
  }
  
  // D. SUCCESS (verdi)
  // Tutti obiettivi raggiunti
  var tuttiRaggiunti = Object.keys(DB.budgetGoals).length > 0;
  Object.keys(DB.budgetGoals).forEach(function(cat) {
    var budget = DB.budgetGoals[cat];
    var speso = speseCategoria[cat] || 0;
    if (speso > budget) tuttiRaggiunti = false;
  });
  
  if (tuttiRaggiunti && Object.keys(DB.budgetGoals).length > 0) {
    alerts.push({
      type: 'success',
      icon: '‚úÖ',
      message: 'Fantastico! Tutti gli obiettivi budget rispettati questo mese!',
      action: 'obiettivi'
    });
  }
  
  // Risparmi sopra 15%
  if (entrateMese > 0) {
    var risparmiato = entrateMese - speseMese;
    var percRisparmio = (risparmiato / entrateMese) * 100;
    
    if (percRisparmio >= 15) {
      alerts.push({
        type: 'success',
        icon: '‚úÖ',
        message: 'Ottimo lavoro! Hai risparmiato il <strong>' + percRisparmio.toFixed(1) + '%</strong> questo mese (obiettivo: 15%)',
        action: 'finanze'
      });
    }
  }
  
  // Mostra alert
  if (alerts.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  var html = '<div class="card" style="margin-bottom:15px">';
  html += '<h3 style="margin-bottom:12px;font-size:1.1em;color:var(--text)">üîî Notifiche</h3>';
  
  alerts.forEach(function(alert) {
    var color, bgColor, borderColor;
    
    if (alert.type === 'critical') {
      color = '#e74c3c';
      bgColor = 'rgba(231,76,60,0.1)';
      borderColor = '#e74c3c';
    } else if (alert.type === 'warning') {
      color = '#f39c12';
      bgColor = 'rgba(243,156,18,0.1)';
      borderColor = '#f39c12';
    } else if (alert.type === 'info') {
      color = '#3498db';
      bgColor = 'rgba(52,152,219,0.1)';
      borderColor = '#3498db';
    } else if (alert.type === 'success') {
      color = '#27ae60';
      bgColor = 'rgba(39,174,96,0.1)';
      borderColor = '#27ae60';
    }
    
    html += '<div style="padding:12px;margin-bottom:8px;background:' + bgColor + ';border-left:4px solid ' + borderColor + ';border-radius:8px;cursor:pointer" onclick="vai(\'' + alert.action + '\')">';
    html += '<div style="display:flex;align-items:center;gap:10px">';
    html += '<span style="font-size:1.3em">' + alert.icon + '</span>';
    html += '<div style="flex:1;font-size:0.9em;color:' + color + ';font-weight:600">' + alert.message + '</div>';
    html += '<span style="color:' + color + ';opacity:0.5;font-size:0.9em">‚Üí</span>';
    html += '</div>';
    html += '</div>';
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}

function cambiaPatrimonioMese(offset) {
  mese += offset;
  
  if (mese < 0) {
    mese = 11;
    anno--;
  } else if (mese > 11) {
    mese = 0;
    anno++;
  }
  
  document.getElementById('year').value = anno;
  document.getElementById('month').value = mese;
  aggiorna();
  aggiornaBottoniOggi();
}

// ========== TRANSAZIONI ==========
function cambiaFinanzeMese(offset) {
  mese += offset;
  
  if (mese < 0) {
    mese = 11;
    anno--;
  } else if (mese > 11) {
    mese = 0;
    anno++;
  }
  
  document.getElementById('year').value = anno;
  document.getElementById('month').value = mese;
  
  aggiornaRisparmio();
  mostraAnalisi();
  calcolaPrevisioni();
  aggiornaBottoniOggi();
}

function cambiaObiettiviMese(offset) {
  mese += offset;
  
  if (mese < 0) {
    mese = 11;
    anno--;
  } else if (mese > 11) {
    mese = 0;
    anno++;
  }
  
  document.getElementById('year').value = anno;
  document.getElementById('month').value = mese;
  
  mostraObiettivi();
  aggiornaBottoniOggi();
}

// ========== SEZIONE OBIETTIVI ==========
function mostraObiettivi() {
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  
  // Aggiorna titolo mese
  if (document.getElementById('obiettiviMese')) {
    document.getElementById('obiettiviMese').textContent = mesiNomi[mese] + ' ' + anno;
  }
  
  // Mostra long-term goals
  mostraLongTermGoals();
  
  // Mostra riepilogo obiettivi
  mostraRiepilogoObiettivi();
  
  // Mostra obiettivi individuali
  mostraBudgetGoals();
}

// ========== LONG-TERM GOALS ==========
function mostraLongTermGoals() {
  var container = document.getElementById('longTermGoals');
  if (!container) return;
  
  if (!DB.longTermGoals || DB.longTermGoals.length === 0) {
    var html = '<div style="text-align:center;padding:40px;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);border-radius:12px">';
    html += '<div style="font-size:3em;margin-bottom:10px">üèÜ</div>';
    html += '<div style="font-size:1.2em;font-weight:700;color:#2c3e50;margin-bottom:8px">Nessun obiettivo long-term</div>';
    html += '<p style="color:#7f8c8d;margin-bottom:15px">Crea obiettivi su pi√π mesi per raggiungere traguardi importanti!</p>';
    html += '</div>';
    container.innerHTML = html;
    return;
  }
  
  var html = '';
  var oggi = new Date();
  
  DB.longTermGoals.forEach(function(goal, idx) {
    var dataInizio = new Date(goal.dataInizio);
    var dataFine = new Date(goal.dataFine);
    var isScaduto = oggi > dataFine;
    var progressPerc = 0;
    var speso = 0;
    var target = 0;
    var rimanente = 0;
    
    // Calcola progress in base al tipo
    if (goal.tipo === 'risparmio') {
      var totaleSalvato = 0;
      DB.transazioni.forEach(function(t) {
        var d = new Date(t.data);
        if (d >= dataInizio && d <= dataFine) {
          var imp = parseFloat(t.importo) || 0;
          if (t.tipo === 'income') totaleSalvato += imp;
          else if (t.tipo === 'expense') totaleSalvato -= imp;
        }
      });
      
      speso = totaleSalvato;
      target = goal.target;
      rimanente = target - speso;
      progressPerc = target > 0 ? (speso / target * 100) : 0;
      
    } else if (goal.tipo === 'riduzione') {
      var mediaBase = goal.mediaBase || 0;
      var speseCategoria = 0;
      var mesiContati = {};
      
      DB.transazioni.forEach(function(t) {
        var d = new Date(t.data);
        if (d >= dataInizio && d <= dataFine && t.tipo === 'expense' && t.categoria === goal.categoria) {
          speseCategoria += parseFloat(t.importo) || 0;
          var meseKey = d.getFullYear() + '-' + d.getMonth();
          mesiContati[meseKey] = true;
        }
      });
      
      var numMesi = Object.keys(mesiContati).length || 1;
      var mediaAttuale = speseCategoria / numMesi;
      var riduzioneEffettiva = mediaBase > 0 ? ((mediaBase - mediaAttuale) / mediaBase * 100) : 0;
      
      speso = riduzioneEffettiva;
      target = goal.targetPercent;
      rimanente = target - speso;
      progressPerc = target > 0 ? (riduzioneEffettiva / target * 100) : 0;
      
    } else if (goal.tipo === 'budget_multi') {
      var speseCategoria = 0;
      DB.transazioni.forEach(function(t) {
        var d = new Date(t.data);
        if (d >= dataInizio && d <= dataFine && t.tipo === 'expense' && t.categoria === goal.categoria) {
          speseCategoria += parseFloat(t.importo) || 0;
        }
      });
      
      speso = speseCategoria;
      target = goal.target;
      rimanente = target - speso;
      progressPerc = target > 0 ? (speso / target * 100) : 0;
    }
    
    // Determina colori e stato (come obiettivi mensili)
    var colore, bgGradient, emoji, stato;
    if (isScaduto) {
      colore = '#95a5a6';
      bgGradient = 'linear-gradient(135deg, #ecf0f1, #bdc3c7)';
      emoji = '‚è∞';
      stato = 'Scaduto';
    } else if (progressPerc <= 75) {
      colore = '#27ae60';
      bgGradient = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
      emoji = '‚úÖ';
      stato = 'Ottimo!';
    } else if (progressPerc <= 90) {
      colore = '#f39c12';
      bgGradient = 'linear-gradient(135deg, #fff3e0, #ffe0b2)';
      emoji = '‚ö†Ô∏è';
      stato = 'Attenzione';
    } else if (progressPerc <= 100) {
      colore = '#e67e22';
      bgGradient = 'linear-gradient(135deg, #fff3e0, #ffcc80)';
      emoji = '‚ö†Ô∏è';
      stato = 'Vicino al limite';
    } else {
      colore = '#e74c3c';
      bgGradient = 'linear-gradient(135deg, #ffebee, #ffcdd2)';
      emoji = '‚ùå';
      stato = 'Obiettivo superato!';
    }
    
    // Card stile obiettivi mensili
    html += '<div style="margin-bottom:15px;padding:16px;background:' + bgGradient + ';border-radius:12px;border-left:5px solid ' + colore + ';box-shadow:0 2px 8px rgba(0,0,0,0.1)">';
    
    // Header
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
    html += '<div>';
    html += '<div style="font-size:1.1em;font-weight:800;color:#2c3e50">' + (goal.nome || 'Obiettivo') + '</div>';
    
    // Info periodo
    var mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    var periodoText = mesiNomi[dataInizio.getMonth()] + ' ' + dataInizio.getFullYear() + ' ‚Üí ' + mesiNomi[dataFine.getMonth()] + ' ' + dataFine.getFullYear();
    html += '<div style="font-size:0.8em;color:#7f8c8d;margin-top:2px">' + periodoText + ' ‚Ä¢ ' + emoji + ' ' + stato + '</div>';
    html += '</div>';
    html += '<div style="display:flex;gap:6px">';
    html += '<button onclick="eliminaLongTermGoal(' + idx + ')" style="background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:0.9em;font-weight:600;box-shadow:0 2px 4px rgba(231,76,60,0.3)">üóëÔ∏è</button>';
    html += '</div>';
    html += '</div>';
    
    // Importi (grid 3 colonne)
    html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">';
    
    if (goal.tipo === 'risparmio') {
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Risparmiato</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:' + colore + '">' + formatEuro(speso) + '</div>';
      html += '</div>';
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Obiettivo</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:#2c3e50">' + formatEuro(target) + '</div>';
      html += '</div>';
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Mancante</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:' + (rimanente >= 0 ? '#27ae60' : '#e74c3c') + '">' + formatEuro(Math.abs(rimanente)) + '</div>';
      html += '</div>';
    } else if (goal.tipo === 'riduzione') {
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Riduzione</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:' + colore + '">' + speso.toFixed(1) + '%</div>';
      html += '</div>';
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Obiettivo</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:#2c3e50">' + target + '%</div>';
      html += '</div>';
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Categoria</div>';
      html += '<div style="font-size:0.9em;font-weight:800;color:#2c3e50">' + goal.categoria + '</div>';
      html += '</div>';
    } else if (goal.tipo === 'budget_multi') {
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Speso</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:' + colore + '">' + formatEuro(speso) + '</div>';
      html += '</div>';
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Budget</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:#2c3e50">' + formatEuro(target) + '</div>';
      html += '</div>';
      html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
      html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Rimanente</div>';
      html += '<div style="font-size:1.1em;font-weight:800;color:' + (rimanente >= 0 ? '#27ae60' : '#e74c3c') + '">' + formatEuro(Math.abs(rimanente)) + '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    // Barra progresso
    html += '<div style="background:rgba(255,255,255,0.5);height:12px;border-radius:6px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1)">';
    html += '<div style="background:' + colore + ';height:100%;width:' + Math.min(progressPerc, 100) + '%;transition:width 0.5s ease;box-shadow:0 0 10px rgba(' + (progressPerc > 100 ? '231,76,60' : '39,174,96') + ',0.5)"></div>';
    html += '</div>';
    
    // Percentuale
    html += '<div style="text-align:right;font-size:0.85em;color:' + colore + ';font-weight:700;margin-top:6px">';
    html += progressPerc.toFixed(1) + '% completato';
    html += '</div>';
    
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function aggiungiObiettivoLongTerm() {
  var modal = document.getElementById('modal');
  modal.classList.add('active');
  
  var html = '';
  html += '<div class="modal-header">';
  html += '<h3 style="display:flex;align-items:center;gap:10px"><span style="font-size:1.4em">üèÜ</span> Nuovo Obiettivo Long-Term</h3>';
  html += '<button class="close-btn" onclick="chiudiModal()">√ó</button>';
  html += '</div>';
  html += '<div style="padding:25px">';
  html += '<p style="font-size:1em;color:#7f8c8d;margin-bottom:25px;text-align:center">Scegli il tipo di obiettivo che vuoi creare</p>';
  
  html += '<div style="display:grid;gap:15px;margin-bottom:25px">';
  
  // Tipo 1: Risparmio Totale
  html += '<div onclick="creaLongTermGoal(\'risparmio\')" style="padding:20px;background:linear-gradient(135deg,#27ae60,#229954);border-radius:14px;cursor:pointer;transition:all 0.3s;color:#fff;box-shadow:0 4px 15px rgba(39,174,96,0.3);position:relative;overflow:hidden" onmouseover="this.style.transform=\'translateY(-3px)\';this.style.boxShadow=\'0 8px 25px rgba(39,174,96,0.4)\'" onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 4px 15px rgba(39,174,96,0.3)\'">';
  html += '<div style="position:absolute;top:-20px;right:-20px;font-size:6em;opacity:0.1">üí∞</div>';
  html += '<div style="position:relative;z-index:1">';
  html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">';
  html += '<span style="font-size:2.5em">üí∞</span>';
  html += '<div style="font-weight:800;font-size:1.3em">Risparmio Totale</div>';
  html += '</div>';
  html += '<div style="font-size:0.95em;opacity:0.95;line-height:1.4;padding-left:10px">Esempio: "Risparmia ‚Ç¨5000 entro Giugno 2025"</div>';
  html += '</div>';
  html += '</div>';
  
  // Tipo 2: Riduzione Spesa
  html += '<div onclick="creaLongTermGoal(\'riduzione\')" style="padding:20px;background:linear-gradient(135deg,#3498db,#2980b9);border-radius:14px;cursor:pointer;transition:all 0.3s;color:#fff;box-shadow:0 4px 15px rgba(52,152,219,0.3);position:relative;overflow:hidden" onmouseover="this.style.transform=\'translateY(-3px)\';this.style.boxShadow=\'0 8px 25px rgba(52,152,219,0.4)\'" onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 4px 15px rgba(52,152,219,0.3)\'">';
  html += '<div style="position:absolute;top:-20px;right:-20px;font-size:6em;opacity:0.1">üìâ</div>';
  html += '<div style="position:relative;z-index:1">';
  html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">';
  html += '<span style="font-size:2.5em">üìâ</span>';
  html += '<div style="font-weight:800;font-size:1.3em">Riduzione Spesa</div>';
  html += '</div>';
  html += '<div style="font-size:0.95em;opacity:0.95;line-height:1.4;padding-left:10px">Esempio: "Riduci Uscite Ristoranti del 20%"</div>';
  html += '</div>';
  html += '</div>';
  
  // Tipo 3: Budget Multi-Mese
  html += '<div onclick="creaLongTermGoal(\'budget_multi\')" style="padding:20px;background:linear-gradient(135deg,#9b59b6,#8e44ad);border-radius:14px;cursor:pointer;transition:all 0.3s;color:#fff;box-shadow:0 4px 15px rgba(155,89,182,0.3);position:relative;overflow:hidden" onmouseover="this.style.transform=\'translateY(-3px)\';this.style.boxShadow=\'0 8px 25px rgba(155,89,182,0.4)\'" onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 4px 15px rgba(155,89,182,0.3)\'">';
  html += '<div style="position:absolute;top:-20px;right:-20px;font-size:6em;opacity:0.1">üéØ</div>';
  html += '<div style="position:relative;z-index:1">';
  html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">';
  html += '<span style="font-size:2.5em">üéØ</span>';
  html += '<div style="font-weight:800;font-size:1.3em">Budget Multi-Mese</div>';
  html += '</div>';
  html += '<div style="font-size:0.95em;opacity:0.95;line-height:1.4;padding-left:10px">Esempio: "Max ‚Ç¨600 per Palestra in 3 mesi"</div>';
  html += '</div>';
  html += '</div>';
  
  html += '</div>';
  html += '<button class="btn" onclick="chiudiModal()" style="width:100%;background:#95a5a6;padding:14px;font-size:1.05em">‚úñ Annulla</button>';
  html += '</div>';
  
  var content = modal.querySelector('.modal-content');
  content.innerHTML = html;
}

function creaLongTermGoal(tipo) {
  chiudiModal();
  
  var modal = document.getElementById('modal');
  var oggi = new Date();
  var dataInizio = oggi.toISOString().split('T')[0];
  
  if (tipo === 'risparmio') {
    // Modal per Risparmio Totale
    modal.classList.add('active');
    var html = '';
    html += '<div class="modal-header">';
    html += '<h3 style="display:flex;align-items:center;gap:10px"><span style="font-size:1.4em">üí∞</span> Nuovo Obiettivo Risparmio</h3>';
    html += '<button class="close-btn" onclick="chiudiModal()">√ó</button>';
    html += '</div>';
    html += '<div style="padding:25px">';
    
    // Nome obiettivo
    html += '<div style="margin-bottom:20px">';
    html += '<label style="display:flex;align-items:center;gap:8px;font-weight:700;margin-bottom:10px;color:#2c3e50;font-size:1em">';
    html += '<span style="font-size:1.3em">üìù</span>';
    html += '<span>Nome del tuo obiettivo</span>';
    html += '</label>';
    html += '<input type="text" id="ltgNome" placeholder="Es: Fondo Vacanze, Nuova Auto, Casa..." style="width:100%;padding:14px;border:2px solid #27ae60;border-radius:10px;font-size:1em;background:#f8f9fa;transition:all 0.3s" onfocus="this.style.borderColor=\'#27ae60\';this.style.background=\'#fff\'" onblur="this.style.borderColor=\'#ddd\';this.style.background=\'#f8f9fa\'">';
    html += '<div style="font-size:0.85em;color:#7f8c8d;margin-top:6px;padding-left:4px">üí° Scegli un nome motivante!</div>';
    html += '</div>';
    
    // Target importo
    html += '<div style="margin-bottom:20px">';
    html += '<label style="display:flex;align-items:center;gap:8px;font-weight:700;margin-bottom:10px;color:#2c3e50;font-size:1em">';
    html += '<span style="font-size:1.3em">üí∞</span>';
    html += '<span>Quanto vuoi risparmiare?</span>';
    html += '</label>';
    html += '<div style="position:relative">';
    html += '<input type="number" id="ltgTarget" placeholder="5000" style="width:100%;padding:14px;padding-left:35px;border:2px solid #27ae60;border-radius:10px;font-size:1em;background:#f8f9fa" onfocus="this.style.borderColor=\'#27ae60\';this.style.background=\'#fff\'" onblur="this.style.borderColor=\'#ddd\';this.style.background=\'#f8f9fa\'">';
    html += '<span style="position:absolute;left:14px;top:14px;font-size:1em;color:#27ae60;font-weight:700">‚Ç¨</span>';
    html += '</div>';
    html += '</div>';
    
    // Data fine
    html += '<div style="margin-bottom:25px">';
    html += '<label style="display:flex;align-items:center;gap:8px;font-weight:700;margin-bottom:10px;color:#2c3e50;font-size:1em">';
    html += '<span style="font-size:1.3em">üìÖ</span>';
    html += '<span>Entro quale data?</span>';
    html += '</label>';
    html += '<input type="date" id="ltgDataFine" style="width:100%;padding:14px;border:2px solid #27ae60;border-radius:10px;font-size:1em;background:#f8f9fa" onfocus="this.style.borderColor=\'#27ae60\';this.style.background=\'#fff\'" onblur="this.style.borderColor=\'#ddd\';this.style.background=\'#f8f9fa\'">';
    html += '</div>';
    
    html += '<div style="display:flex;gap:10px">';
    html += '<button class="btn" onclick="salvaRisparmioGoal()" style="flex:2;background:#27ae60;padding:14px;font-weight:700">‚úÖ Crea Obiettivo</button>';
    html += '<button class="btn btn-danger" onclick="chiudiModal()" style="flex:1;padding:14px">Annulla</button>';
    html += '</div>';
    html += '</div>';
    
    var content = modal.querySelector('.modal-content');
    content.innerHTML = html;
    
  } else if (tipo === 'riduzione') {
    // Modal per Riduzione Spesa - STILE MODERNO CON SELECT
    modal.classList.add('active');
    var html = '';
    html += '<div class="modal-header" style="background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;padding:20px;border-radius:16px 16px 0 0">';
    html += '<h3 style="display:flex;align-items:center;gap:10px;margin:0;font-size:1.3em"><span style="font-size:1.2em">üìâ</span> Obiettivo Riduzione Spesa</h3>';
    html += '<button class="close-btn" onclick="chiudiModal()" style="background:rgba(255,255,255,0.2);color:#fff;border:none;width:32px;height:32px;border-radius:50%;font-size:1.5em;cursor:pointer;display:flex;align-items:center;justify-content:center">√ó</button>';
    html += '</div>';
    html += '<div style="padding:20px;background:var(--card)">';
    
    // Categoria da ridurre - SELECT NATIVO
    html += '<div style="margin-bottom:18px">';
    html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text);font-size:0.95em">üìÇ Categoria da ridurre</label>';
    html += '<select id="ltgCategoria" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text);font-weight:600" onfocus="this.style.borderColor=\'#e74c3c\'" onblur="this.style.borderColor=\'var(--border)\'">';
    html += '<option value="">Seleziona categoria...</option>';
    DB.categorie.expense.sort().forEach(function(cat) {
      html += '<option value="' + cat + '">' + cat + '</option>';
    });
    html += '</select>';
    html += '</div>';
    
    // Percentuale riduzione
    html += '<div style="margin-bottom:18px">';
    html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text);font-size:0.95em">üìâ Riduzione desiderata</label>';
    html += '<div style="position:relative">';
    html += '<input type="number" id="ltgPercent" placeholder="20" style="width:100%;padding:12px 40px 12px 12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text);font-weight:600" onfocus="this.style.borderColor=\'#e74c3c\'" onblur="this.style.borderColor=\'var(--border)\'">';
    html += '<span style="position:absolute;right:12px;top:12px;font-size:1em;color:#e74c3c;font-weight:700">%</span>';
    html += '</div>';
    html += '</div>';
    
    // Media base
    html += '<div style="margin-bottom:18px">';
    html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text);font-size:0.95em">üí∞ Spesa media mensile attuale</label>';
    html += '<div style="position:relative">';
    html += '<span style="position:absolute;left:12px;top:12px;font-size:1em;color:#e74c3c;font-weight:700">‚Ç¨</span>';
    html += '<input type="number" id="ltgMediaBase" placeholder="200" style="width:100%;padding:12px 12px 12px 40px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text);font-weight:600" onfocus="this.style.borderColor=\'#e74c3c\'" onblur="this.style.borderColor=\'var(--border)\'">';
    html += '</div>';
    html += '</div>';
    
    // Data fine
    html += '<div style="margin-bottom:20px">';
    html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text);font-size:0.95em">üìÖ Entro quale data?</label>';
    html += '<input type="date" id="ltgDataFine" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text);font-weight:600" onfocus="this.style.borderColor=\'#e74c3c\'" onblur="this.style.borderColor=\'var(--border)\'">';
    html += '</div>';
    
    html += '<div style="display:flex;gap:10px">';
    html += '<button class="btn" onclick="chiudiModal()" style="flex:1;background:#95a5a6;padding:14px;border-radius:10px;border:none;color:#fff;font-weight:700;font-size:1em">Annulla</button>';
    html += '<button class="btn" onclick="salvaRiduzioneGoal()" style="flex:2;background:linear-gradient(135deg,#e74c3c,#c0392b);padding:14px;border-radius:10px;border:none;color:#fff;font-weight:700;font-size:1em;box-shadow:0 4px 12px rgba(231,76,60,0.3)">‚úÖ Crea Obiettivo</button>';
    html += '</div>';
    html += '</div>';
    
    var content = modal.querySelector('.modal-content');
    content.innerHTML = html;
    
  } else if (tipo === 'budget_multi') {
    // Modal per Budget Multi-Mese - STILE MODERNO
    modal.classList.add('active');
    var html = '';
    html += '<div class="modal-header" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;padding:20px;border-radius:16px 16px 0 0">';
    html += '<h3 style="display:flex;align-items:center;gap:10px;margin:0;font-size:1.3em"><span style="font-size:1.2em">üéØ</span> Budget Multi-Mese</h3>';
    html += '<button class="close-btn" onclick="chiudiModal()" style="background:rgba(255,255,255,0.2);color:#fff;border:none;width:32px;height:32px;border-radius:50%;font-size:1.5em;cursor:pointer;display:flex;align-items:center;justify-content:center">√ó</button>';
    html += '</div>';
    html += '<div style="padding:20px;background:var(--card)">';
    
    // Categoria
    html += '<div style="margin-bottom:18px">';
    html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text);font-size:0.95em">üìÇ Categoria</label>';
    html += '<select id="ltgCategoria" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text);font-weight:600" onfocus="this.style.borderColor=\'#9b59b6\'" onblur="this.style.borderColor=\'var(--border)\'">';
    html += '<option value="">Seleziona categoria...</option>';
    DB.categorie.expense.forEach(function(cat) {
      html += '<option value="' + cat + '">' + cat + '</option>';
    });
    html += '</select>';
    html += '</div>';
    
    // Budget totale
    html += '<div style="margin-bottom:18px">';
    html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text);font-size:0.95em">üí∞ Budget totale massimo</label>';
    html += '<div style="position:relative">';
    html += '<span style="position:absolute;left:12px;top:12px;font-size:1em;color:#9b59b6;font-weight:700">‚Ç¨</span>';
    html += '<input type="number" id="ltgTarget" placeholder="600" style="width:100%;padding:12px 12px 12px 40px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text);font-weight:600" onfocus="this.style.borderColor=\'#9b59b6\'" onblur="this.style.borderColor=\'var(--border)\'">';
    html += '</div>';
    html += '<div style="font-size:0.85em;color:#7f8c8d;margin-top:6px;padding-left:4px">üí° Somma totale per tutti i mesi del periodo</div>';
    html += '</div>';
    
    // Data fine
    html += '<div style="margin-bottom:20px">';
    html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text);font-size:0.95em">üìÖ Fino a quale data?</label>';
    html += '<input type="date" id="ltgDataFine" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text);font-weight:600" onfocus="this.style.borderColor=\'#9b59b6\'" onblur="this.style.borderColor=\'var(--border)\'">';
    html += '</div>';
    
    html += '<div style="display:flex;gap:10px">';
    html += '<button class="btn" onclick="chiudiModal()" style="flex:1;background:#95a5a6;padding:14px;border-radius:10px;border:none;color:#fff;font-weight:700;font-size:1em">Annulla</button>';
    html += '<button class="btn" onclick="salvaBudgetMultiGoal()" style="flex:2;background:linear-gradient(135deg,#9b59b6,#8e44ad);padding:14px;border-radius:10px;border:none;color:#fff;font-weight:700;font-size:1em;box-shadow:0 4px 12px rgba(155,89,182,0.3)">‚úÖ Crea Obiettivo</button>';
    html += '</div>';
    html += '</div>';
    
    var content = modal.querySelector('.modal-content');
    content.innerHTML = html;
  }
}

// Funzioni di salvataggio per Long-Term Goals
function salvaRisparmioGoal() {
  var nome = document.getElementById('ltgNome').value.trim();
  var target = parseFloat(document.getElementById('ltgTarget').value);
  var dataFine = document.getElementById('ltgDataFine').value;
  
  if (!nome) {
    mostraToast('‚ö†Ô∏è Inserisci un nome per l\'obiettivo!', 'warning');
    return;
  }
  
  if (!target || target <= 0) {
    mostraToast('‚ö†Ô∏è Importo non valido!', 'warning');
    return;
  }
  
  if (!dataFine) {
    mostraToast('‚ö†Ô∏è Seleziona una data!', 'warning');
    return;
  }
  
  var oggi = new Date();
  var dataInizio = oggi.toISOString().split('T')[0];
  
  DB.longTermGoals.push({
    tipo: 'risparmio',
    nome: nome,
    target: target,
    dataInizio: dataInizio,
    dataFine: dataFine
  });
  
  salvaDB();
  chiudiModal();
  mostraObiettivi();
  mostraToast('‚úÖ Obiettivo risparmio creato!', 'success');
  playSound('success');
}

// Funzione rimossa - ora usa select nativo nella modal

function salvaRiduzioneGoal() {
  var categoria = document.getElementById('ltgCategoria').value;
  var targetPercent = parseFloat(document.getElementById('ltgPercent').value);
  var mediaBase = parseFloat(document.getElementById('ltgMediaBase').value);
  var dataFine = document.getElementById('ltgDataFine').value;
  
  if (!categoria) {
    mostraToast('‚ö†Ô∏è Seleziona una categoria!', 'warning');
    return;
  }
  
  if (!targetPercent || targetPercent <= 0) {
    mostraToast('‚ö†Ô∏è Percentuale non valida!', 'warning');
    return;
  }
  
  if (!mediaBase || mediaBase <= 0) {
    mostraToast('‚ö†Ô∏è Importo non valido!', 'warning');
    return;
  }
  
  if (!dataFine) {
    mostraToast('‚ö†Ô∏è Seleziona una data!', 'warning');
    return;
  }
  
  var oggi = new Date();
  var dataInizio = oggi.toISOString().split('T')[0];
  
  DB.longTermGoals.push({
    tipo: 'riduzione',
    nome: 'Riduci ' + categoria + ' del ' + targetPercent + '%',
    categoria: categoria,
    targetPercent: targetPercent,
    mediaBase: mediaBase,
    dataInizio: dataInizio,
    dataFine: dataFine
  });
  
  salvaDB();
  chiudiModal();
  mostraObiettivi();
  mostraToast('‚úÖ Obiettivo riduzione creato!', 'success');
  playSound('success');
}

function salvaBudgetMultiGoal() {
  var categoria = document.getElementById('ltgCategoria').value;
  var target = parseFloat(document.getElementById('ltgTarget').value);
  var dataFine = document.getElementById('ltgDataFine').value;
  
  if (!categoria) {
    mostraToast('‚ö†Ô∏è Seleziona una categoria!', 'warning');
    return;
  }
  
  if (!target || target <= 0) {
    mostraToast('‚ö†Ô∏è Importo non valido!', 'warning');
    return;
  }
  
  if (!dataFine) {
    mostraToast('‚ö†Ô∏è Seleziona una data!', 'warning');
    return;
  }
  
  var oggi = new Date();
  var dataInizio = oggi.toISOString().split('T')[0];
  
  DB.longTermGoals.push({
    tipo: 'budget_multi',
    nome: 'Max ' + formatEuro(target) + ' per ' + categoria,
    categoria: categoria,
    target: target,
    dataInizio: dataInizio,
    dataFine: dataFine
  });
  
  salvaDB();
  chiudiModal();
  mostraObiettivi();
  mostraToast('‚úÖ Obiettivo budget multi-mese creato!', 'success');
  playSound('success');
}

function eliminaLongTermGoal(idx) {
  var goal = DB.longTermGoals[idx];
  
  mostraConferma({
    icon: 'üóëÔ∏è',
    title: 'Elimina Obiettivo',
    message: 'Vuoi davvero eliminare l\'obiettivo "' + goal.nome + '"?',
    confirmText: 'üóëÔ∏è Elimina',
    danger: true
  }).then(function(confirmed) {
    if (!confirmed) return;
    
    DB.longTermGoals.splice(idx, 1);
    salvaDB();
    mostraObiettivi();
    mostraToast('‚úÖ Obiettivo eliminato!', 'success');
  });
}

function mostraRiepilogoObiettivi() {
  var container = document.getElementById('obiettiviRiepilogo');
  if (!container) return;
  
  // Calcola spese del mese corrente per categoria
  var speseCategoria = {};
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese && t.tipo === 'expense') {
      var imp = parseFloat(t.importo) || 0;
      speseCategoria[t.categoria] = (speseCategoria[t.categoria] || 0) + imp;
    }
  });
  
  var totaleObiettivi = 0;
  var totaleSpeso = 0;
  var obiettiviRaggiunto = 0;
  
  Object.keys(DB.budgetGoals).forEach(function(cat) {
    totaleObiettivi++;
    var budget = DB.budgetGoals[cat];
    var speso = speseCategoria[cat] || 0;
    totaleSpeso += speso;
    
    if (speso <= budget) {
      obiettiviRaggiunto++;
    }
  });
  
  var totBudget = Object.values(DB.budgetGoals).reduce(function(a, b) { return a + b; }, 0);
  var percentualeGlobale = totBudget > 0 ? (totaleSpeso / totBudget * 100) : 0;
  
  var html = '';
  
  if (totaleObiettivi === 0) {
    html = '<div style="text-align:center;padding:30px;background:var(--bg);border-radius:10px">';
    html += '<div style="font-size:2em;margin-bottom:10px">üéØ</div>';
    html += '<p style="color:#7f8c8d">Nessun obiettivo impostato per questo mese</p>';
    html += '</div>';
  } else {
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px">';
    
    // Obiettivi Totali
    html += '<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;border-radius:12px;text-align:center;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3)">';
    html += '<div style="font-size:0.85em;opacity:0.9;margin-bottom:5px">Obiettivi Attivi</div>';
    html += '<div style="font-size:2.5em;font-weight:800;margin-bottom:5px">' + totaleObiettivi + '</div>';
    html += '<div style="font-size:0.8em;opacity:0.8">categorie monitorate</div>';
    html += '</div>';
    
    // Obiettivi Raggiunti
    var percRagg = totaleObiettivi > 0 ? (obiettiviRaggiunto / totaleObiettivi * 100) : 0;
    var coloreRagg = percRagg >= 80 ? '#27ae60' : percRagg >= 50 ? '#f39c12' : '#e74c3c';
    html += '<div style="background:linear-gradient(135deg,' + coloreRagg + ',rgba(' + (percRagg >= 80 ? '39,174,96' : percRagg >= 50 ? '243,156,18' : '231,76,60') + ',0.8));padding:20px;border-radius:12px;text-align:center;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.2)">';
    html += '<div style="font-size:0.85em;opacity:0.9;margin-bottom:5px">Obiettivi Raggiunti</div>';
    html += '<div style="font-size:2.5em;font-weight:800;margin-bottom:5px">' + obiettiviRaggiunto + '/' + totaleObiettivi + '</div>';
    html += '<div style="font-size:0.8em;opacity:0.8">' + percRagg.toFixed(0) + '% completati</div>';
    html += '</div>';
    
    // Budget Utilizzato
    var coloreGlob = percentualeGlobale > 100 ? '#e74c3c' : percentualeGlobale > 90 ? '#f39c12' : '#27ae60';
    html += '<div style="background:linear-gradient(135deg,' + coloreGlob + ',rgba(' + (percentualeGlobale > 100 ? '231,76,60' : percentualeGlobale > 90 ? '243,156,18' : '39,174,96') + ',0.8));padding:20px;border-radius:12px;text-align:center;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.2)">';
    html += '<div style="font-size:0.85em;opacity:0.9;margin-bottom:5px">Budget Utilizzato</div>';
    html += '<div style="font-size:2.5em;font-weight:800;margin-bottom:5px">' + percentualeGlobale.toFixed(0) + '%</div>';
    html += '<div style="font-size:0.8em;opacity:0.8">' + formatEuro(totaleSpeso) + ' / ' + formatEuro(totBudget) + '</div>';
    html += '</div>';
    
    html += '</div>';
  }
  
  container.innerHTML = html;
}

// ========== OBIETTIVI PERSONALIZZATI ==========
function mostraBudgetGoals() {
  var container = document.getElementById('budgetGoals');
  if (!container) return;
  
  // Calcola spese del mese corrente per categoria
  var speseCategoria = {};
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese && t.tipo === 'expense') {
      var imp = parseFloat(t.importo) || 0;
      speseCategoria[t.categoria] = (speseCategoria[t.categoria] || 0) + imp;
    }
  });
  
  var html = '';
  var hasGoals = false;
  
  Object.keys(DB.budgetGoals).sort().forEach(function(categoria) {
    hasGoals = true;
    var budget = DB.budgetGoals[categoria];
    var speso = speseCategoria[categoria] || 0;
    var rimanente = budget - speso;
    var percentuale = budget > 0 ? (speso / budget * 100) : 0;
    
    var colore, bgGradient, emoji, stato;
    if (percentuale <= 75) {
      colore = '#27ae60';
      bgGradient = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
      emoji = '‚úÖ';
      stato = 'Ottimo!';
    } else if (percentuale <= 90) {
      colore = '#f39c12';
      bgGradient = 'linear-gradient(135deg, #fff3e0, #ffe0b2)';
      emoji = '‚ö†Ô∏è';
      stato = 'Attenzione';
    } else if (percentuale <= 100) {
      colore = '#e67e22';
      bgGradient = 'linear-gradient(135deg, #fff3e0, #ffcc80)';
      emoji = '‚ö†Ô∏è';
      stato = 'Vicino al limite';
    } else {
      colore = '#e74c3c';
      bgGradient = 'linear-gradient(135deg, #ffebee, #ffcdd2)';
      emoji = '‚ùå';
      stato = 'Budget superato!';
    }
    
    html += '<div style="margin-bottom:15px;padding:16px;background:' + bgGradient + ';border-radius:12px;border-left:5px solid ' + colore + ';box-shadow:0 2px 8px rgba(0,0,0,0.1)">';
    
    // Header
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
    html += '<div>';
    html += '<div style="font-size:1.1em;font-weight:800;color:#2c3e50">' + categoria + '</div>';
    html += '<div style="font-size:0.8em;color:#7f8c8d;margin-top:2px">' + emoji + ' ' + stato + '</div>';
    html += '</div>';
    html += '<div style="display:flex;gap:6px">';
    html += '<button onclick="editObiettivo(\'' + categoria + '\')" style="background:#3498db;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:0.9em;font-weight:600;box-shadow:0 2px 4px rgba(52,152,219,0.3)">‚úèÔ∏è Modifica</button>';
    html += '<button onclick="eliminaObiettivo(\'' + categoria + '\')" style="background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:0.9em;font-weight:600;box-shadow:0 2px 4px rgba(231,76,60,0.3)">üóëÔ∏è</button>';
    html += '</div>';
    html += '</div>';
    
    // Importi
    html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">';
    html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
    html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Speso</div>';
    html += '<div style="font-size:1.1em;font-weight:800;color:' + colore + '">' + formatEuro(speso) + '</div>';
    html += '</div>';
    html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
    html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Budget</div>';
    html += '<div style="font-size:1.1em;font-weight:800;color:#2c3e50">' + formatEuro(budget) + '</div>';
    html += '</div>';
    html += '<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px">';
    html += '<div style="font-size:0.75em;color:#7f8c8d;margin-bottom:3px">Rimanente</div>';
    html += '<div style="font-size:1.1em;font-weight:800;color:' + (rimanente >= 0 ? '#27ae60' : '#e74c3c') + '">' + formatEuro(Math.abs(rimanente)) + '</div>';
    html += '</div>';
    html += '</div>';
    
    // Barra progresso
    html += '<div style="background:rgba(255,255,255,0.5);height:12px;border-radius:6px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1)">';
    html += '<div style="background:' + colore + ';height:100%;width:' + Math.min(percentuale, 100) + '%;transition:width 0.5s ease;box-shadow:0 0 10px rgba(' + (percentuale > 100 ? '231,76,60' : '39,174,96') + ',0.5)"></div>';
    html += '</div>';
    
    // Percentuale
    html += '<div style="text-align:right;font-size:0.85em;color:' + colore + ';font-weight:700;margin-top:6px">';
    html += percentuale.toFixed(1) + '% utilizzato';
    html += '</div>';
    
    html += '</div>';
  });
  
  if (!hasGoals) {
    html = '<div style="text-align:center;padding:40px;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);border-radius:12px">';
    html += '<div style="font-size:3em;margin-bottom:10px">üéØ</div>';
    html += '<div style="font-size:1.2em;font-weight:700;color:#2c3e50;margin-bottom:8px">Nessun obiettivo impostato</div>';
    html += '<p style="color:#7f8c8d;margin-bottom:15px">Imposta budget mensili per tenere sotto controllo le tue spese!</p>';
    html += '</div>';
  }
  
  container.innerHTML = html;
}

function aggiungiObiettivo() {
  var modal = document.getElementById('modal');
  modal.classList.add('active');
  
  // Costruisci le opzioni del select
  var optionsHTML = '<option value="">-- Seleziona categoria --</option>';
  DB.categorie.expense.sort().forEach(function(cat) {
    var disabled = DB.budgetGoals[cat] ? ' disabled' : '';
    var label = DB.budgetGoals[cat] ? cat + ' (gi√† impostato)' : cat;
    optionsHTML += '<option value="' + cat + '"' + disabled + '>' + label + '</option>';
  });
  
  // Costruisci tutto l'HTML in una volta
  var html = '';
  html += '<div class="modal-header"><h3>üéØ Aggiungi Obiettivo Budget</h3><button class="close-btn" onclick="chiudiModal()">√ó</button></div>';
  html += '<div style="padding:20px">';
  html += '<p style="font-size:0.9em;color:#7f8c8d;margin-bottom:15px">Imposta un budget mensile per una categoria di spesa e monitora i tuoi progressi</p>';
  
  html += '<div style="margin-bottom:15px">';
  html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text)">üìÇ Categoria</label>';
  html += '<select id="goalCategory" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text)">';
  html += optionsHTML;
  html += '</select>';
  html += '</div>';
  
  html += '<div style="margin-bottom:20px">';
  html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text)">üí∞ Budget Mensile (‚Ç¨)</label>';
  html += '<input type="number" id="goalAmount" placeholder="es. 200" step="0.01" min="0.01" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text)">';
  html += '</div>';
  
  html += '<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:15px;border-radius:10px;margin-bottom:20px">';
  html += '<div style="font-size:0.85em;color:#fff;line-height:1.6">';
  html += '<strong>üí° Suggerimenti:</strong><br>';
  html += '‚Ä¢ Necessit√†: budget realistici per spese fisse<br>';
  html += '‚Ä¢ Desideri: obiettivi sfidanti per risparmiare<br>';
  html += '‚Ä¢ Monitora i progressi con le barre colorate';
  html += '</div>';
  html += '</div>';
  
  html += '<div style="display:flex;gap:10px">';
  html += '<button class="btn" onclick="salvaObiettivo()" style="flex:1;background:var(--income);font-size:1em;padding:14px">‚úÖ Aggiungi Obiettivo</button>';
  html += '<button class="btn btn-danger" onclick="chiudiModal()" style="flex:1;font-size:1em;padding:14px">Annulla</button>';
  html += '</div>';
  
  html += '</div>';
  
  var content = modal.querySelector('.modal-content');
  content.innerHTML = html;
}

function salvaObiettivo() {
  var categoria = document.getElementById('goalCategory').value;
  var budget = parseFloat(document.getElementById('goalAmount').value);
  
  if (!categoria) {
    mostraToast('‚ö†Ô∏è Seleziona una categoria!', 'warning');
    return;
  }
  
  if (!budget || budget <= 0) {
    mostraToast('‚ö†Ô∏è Inserisci un importo valido!', 'warning');
    return;
  }
  
  DB.budgetGoals[categoria] = budget;
  salvaDB();
  chiudiModal();
  mostraBudgetGoals();
  mostraToast('‚úÖ Obiettivo aggiunto per ' + categoria + '!', 'success');
  playSound('success');
}

function editObiettivo(categoria) {
  var modal = document.getElementById('modal');
  modal.classList.add('active');
  
  var budgetAttuale = DB.budgetGoals[categoria];
  
  // Costruisci tutto l'HTML in una volta
  var html = '';
  html += '<div class="modal-header"><h3>‚úèÔ∏è Modifica Obiettivo</h3><button class="close-btn" onclick="chiudiModal()">√ó</button></div>';
  html += '<div style="padding:20px">';
  
  html += '<div style="margin-bottom:15px">';
  html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text)">üìÇ Categoria</label>';
  html += '<input type="text" value="' + categoria + '" disabled style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:#7f8c8d">';
  html += '</div>';
  
  html += '<div style="margin-bottom:20px">';
  html += '<label style="display:block;font-weight:700;margin-bottom:8px;color:var(--text)">üí∞ Budget Mensile (‚Ç¨)</label>';
  html += '<input type="number" id="goalEditAmount" value="' + budgetAttuale + '" step="0.01" min="0.01" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1em;background:var(--bg);color:var(--text)">';
  html += '</div>';
  
  html += '<div style="display:flex;gap:10px">';
  html += '<button class="btn" onclick="salvaEditObiettivo(\'' + categoria + '\')" style="flex:1;background:#3498db;font-size:1em;padding:14px">‚úÖ Salva Modifiche</button>';
  html += '<button class="btn btn-danger" onclick="chiudiModal()" style="flex:1;font-size:1em;padding:14px">Annulla</button>';
  html += '</div>';
  
  html += '</div>';
  
  var content = modal.querySelector('.modal-content');
  content.innerHTML = html;
}

function salvaEditObiettivo(categoria) {
  var nuovoBudget = parseFloat(document.getElementById('goalEditAmount').value);
  
  if (!nuovoBudget || nuovoBudget <= 0) {
    mostraToast('‚ö†Ô∏è Importo non valido!', 'warning');
    return;
  }
  
  DB.budgetGoals[categoria] = nuovoBudget;
  salvaDB();
  chiudiModal();
  mostraBudgetGoals();
  mostraToast('‚úÖ Obiettivo aggiornato!', 'success');
  playSound('success');
}

function eliminaObiettivo(categoria) {
  mostraConferma({
    icon: 'üóëÔ∏è',
    title: 'Elimina Obiettivo',
    message: 'Vuoi davvero eliminare l\'obiettivo per "' + categoria + '"?',
    confirmText: 'üóëÔ∏è Elimina',
    danger: true
  }).then(function(confirmed) {
    if (!confirmed) return;
    
    delete DB.budgetGoals[categoria];
    salvaDB();
    mostraBudgetGoals();
    mostraToast('‚úÖ Obiettivo eliminato!', 'success');
  });
}

// ========== TRANSAZIONI ==========
function nuovaTrans() {
  document.getElementById('modal').classList.add('active');
  document.getElementById('tid').value = '';
  document.getElementById('tdata').value = new Date().toISOString().split('T')[0];
  
  // Imposta l'orario corrente
  var now = new Date();
  var hours = String(now.getHours()).padStart(2, '0');
  var minutes = String(now.getMinutes()).padStart(2, '0');
  document.getElementById('tora').value = hours + ':' + minutes;
  
  document.getElementById('ttipo').value = 'expense';
  aggCatSel();
  document.getElementById('timp').value = '';
  document.getElementById('tnote').value = '';
  
  // Reset checkbox condiviso
  var checkboxCondiviso = document.getElementById('tcondiviso');
  if (checkboxCondiviso) {
    checkboxCondiviso.checked = false;
  }
  
  // Reset checkbox virtual recovery
  var checkboxVirtual = document.getElementById('tvirtual');
  if (checkboxVirtual) {
    checkboxVirtual.checked = false;
  }
  
  // Reset visual custom checkboxes
  aggiornaVisualCheckbox();
  aggiornaVisualCheckboxVirtual();
}

function toggleCondivisoCustom() {
  var checkbox = document.getElementById('tcondiviso');
  if (!checkbox) return;
  
  checkbox.checked = !checkbox.checked;
  aggiornaVisualCheckbox();
}

function aggiornaVisualCheckbox() {
  var checkbox = document.getElementById('tcondiviso');
  var checkIcon = document.getElementById('checkIcon');
  var customCheckbox = document.getElementById('customCheckbox');
  
  if (!checkbox || !checkIcon || !customCheckbox) return;
  
  if (checkbox.checked) {
    checkIcon.style.display = 'block';
    customCheckbox.style.background = 'var(--income)';
    customCheckbox.style.borderColor = 'var(--income)';
    checkIcon.style.color = '#fff';
  } else {
    checkIcon.style.display = 'none';
    customCheckbox.style.background = '#fff';
    customCheckbox.style.borderColor = 'var(--income)';
  }
}

function toggleRecuperoVirtuale() {
  var checkbox = document.getElementById('tvirtual');
  if (!checkbox) return;
  
  checkbox.checked = !checkbox.checked;
  aggiornaVisualCheckboxVirtual();
}

function aggiornaVisualCheckboxVirtual() {
  var checkbox = document.getElementById('tvirtual');
  var checkIcon = document.getElementById('virtualCheckIcon');
  var customCheckbox = document.getElementById('virtualCheckbox');
  
  if (!checkbox || !checkIcon || !customCheckbox) return;
  
  if (checkbox.checked) {
    checkIcon.style.display = 'block';
    customCheckbox.style.background = '#9b59b6';
    customCheckbox.style.borderColor = '#9b59b6';
    checkIcon.style.color = '#fff';
  } else {
    checkIcon.style.display = 'none';
    customCheckbox.style.background = '#fff';
    customCheckbox.style.borderColor = '#9b59b6';
  }
}

function aggCatSel() {
  var tipo = document.getElementById('ttipo').value;
  var sel = document.getElementById('tcat');
  sel.innerHTML = '';
  
  // Per "Spesa Partner" usa le categorie expense
  var catType = tipo === 'partner_payment' ? 'expense' : tipo;
  
  DB.categorie[catType].forEach(function(cat) {
    var o = document.createElement('option');
    o.value = cat;
    o.textContent = cat;
    sel.appendChild(o);
  });
  
  // Aggiorna visual checkbox senza forzare checked/disabled
  aggiornaVisualCheckbox();
}

function chiudiModal() {
  document.getElementById('modal').classList.remove('active');
}

// ========== MODAL CONFERMA PERSONALIZZATO ==========
var confirmCallback = null;

function mostraConferma(options) {
  return new Promise(function(resolve) {
    var modal = document.getElementById('confirmModal');
    var icon = document.getElementById('confirmIcon');
    var title = document.getElementById('confirmTitle');
    var message = document.getElementById('confirmMessage');
    var confirmBtn = document.getElementById('confirmButton');
    
    // Imposta contenuto
    icon.textContent = options.icon || '‚ö†Ô∏è';
    title.textContent = options.title || 'Conferma azione';
    message.textContent = options.message || 'Sei sicuro di voler procedere?';
    confirmBtn.textContent = options.confirmText || '‚úì Conferma';
    
    // Cambia colore bottone se necessario
    confirmBtn.className = 'confirm-btn';
    if (options.danger !== false) {
      confirmBtn.classList.add('confirm-btn-confirm');
    } else {
      confirmBtn.classList.add('confirm-btn-primary');
    }
    
    // Mostra modal
    modal.classList.add('active');
    
    // Salva callback
    confirmCallback = resolve;
    
    playSound('click');
  });
}

function chiudiConferma(result) {
  var modal = document.getElementById('confirmModal');
  modal.classList.remove('active');
  
  if (confirmCallback) {
    confirmCallback(result);
    confirmCallback = null;
  }
  
  playSound(result ? 'success' : 'click');
}

function salva(e) {
  e.preventDefault();
  
  var id = document.getElementById('tid').value;
  var dataTransazione = document.getElementById('tdata').value;
  
  var condiviso = document.getElementById('tcondiviso') ? document.getElementById('tcondiviso').checked : false;
  var virtualRecovery = document.getElementById('tvirtual') ? document.getElementById('tvirtual').checked : false;
  
  var t = {
    data: dataTransazione,
    ora: document.getElementById('tora').value,
    tipo: document.getElementById('ttipo').value,
    categoria: document.getElementById('tcat').value,
    importo: parseFloat(document.getElementById('timp').value),
    note: document.getElementById('tnote').value.trim(),
    condiviso: condiviso,
    virtualRecovery: virtualRecovery
  };
  
  if (id === '') {
    DB.transazioni.push(t);
  } else {
    DB.transazioni[parseInt(id)] = t;
  }
  
  salvaDB();
  chiudiModal();
  
  // Passa automaticamente all'anno e mese della transazione appena salvata
  var dataObj = new Date(dataTransazione);
  var annoTrans = dataObj.getFullYear();
  var meseTrans = dataObj.getMonth();
  
  // Aggiorna i selettori
  document.getElementById('year').value = annoTrans;
  document.getElementById('month').value = meseTrans;
  anno = annoTrans;
  mese = meseTrans;
  
  // Aggiorna tutte le sezioni
  aggiorna();
  mostraTrans();
  
  mostraToast('‚úÖ Transazione salvata!', 'success');
  playSound('success');
}

function aggFilterCats() {
  var sel = document.getElementById('filterCat');
  var filterType = document.getElementById('filterType').value;
  
  sel.innerHTML = '<option value="all">Tutte</option>';
  
  var cats = [];
  
  // Se √® selezionato un tipo specifico, mostra solo quelle categorie
  if (filterType === 'income') {
    cats = DB.categorie.income;
  } else if (filterType === 'expense') {
    cats = DB.categorie.expense;
  } else if (filterType === 'partner_payment') {
    cats = DB.categorie.expense; // Partner usa le stesse categorie di expense
  } else {
    // 'all' - mostra tutte
    cats = [].concat(DB.categorie.income, DB.categorie.expense);
  }
  
  var uniqueCats = Array.from(new Set(cats)).sort();
  
  uniqueCats.forEach(function(cat) {
    var o = document.createElement('option');
    o.value = cat;
    o.textContent = cat;
    sel.appendChild(o);
  });
}

// ========== PERFORMANCE OTTIMIZZAZIONI ==========
var searchTimeout;
function ricercaDebounced() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(function() {
    mostraTrans();
  }, 300);
}

// Throttle per scroll events
function throttle(func, delay) {
  var lastCall = 0;
  return function() {
    var now = Date.now();
    if (now - lastCall < delay) return;
    lastCall = now;
    return func.apply(this, arguments);
  };
}

// Lazy loading per grafici pesanti
var graficiCaricati = {};
function caricaGraficoSeVisibile(graficoId, generaFunc) {
  var el = document.getElementById(graficoId);
  if (!el) return;
  
  var rect = el.getBoundingClientRect();
  var isVisible = rect.top < window.innerHeight && rect.bottom > 0;
  
  if (isVisible && !graficiCaricati[graficoId]) {
    graficiCaricati[graficoId] = true;
    generaFunc();
  }
}

// Memoization per calcoli ripetuti
var memoCache = {};
function memoize(func, key) {
  if (memoCache[key]) {
    return memoCache[key];
  }
  var result = func();
  memoCache[key] = result;
  return result;
}

function clearMemoCache() {
  memoCache = {};
}

// ========== GESTURE MOBILE ==========
var swipeState = {
  startX: 0,
  startY: 0,
  currentX: 0,
  isDragging: false,
  element: null,
  transId: null,
  threshold: 100 // pixel per attivare delete
};

function initSwipeGestures() {
  // Ottieni tutti gli elementi trans-item ogni volta che mostriamo le transazioni
  setTimeout(function() {
    var items = document.querySelectorAll('.trans-item');
    items.forEach(function(item) {
      // Rimuovi listener esistenti
      item.replaceWith(item.cloneNode(true));
    });
    
    // Ri-aggiungi listener puliti
    items = document.querySelectorAll('.trans-item');
    items.forEach(function(item, index) {
      aggiungiSwipeToDelete(item, index);
    });
  }, 100);
}

function aggiungiSwipeToDelete(elemento, transId) {
  elemento.addEventListener('touchstart', handleTouchStart, { passive: true });
  elemento.addEventListener('touchmove', handleTouchMove, { passive: false });
  elemento.addEventListener('touchend', handleTouchEnd, { passive: true });
}

function handleTouchStart(e) {
  swipeState.startX = e.touches[0].clientX;
  swipeState.startY = e.touches[0].clientY;
  swipeState.isDragging = false;
  swipeState.element = e.currentTarget;
  
  // Trova l'indice della transazione
  var items = Array.from(document.querySelectorAll('.trans-item'));
  swipeState.transId = items.indexOf(swipeState.element);
}

function handleTouchMove(e) {
  if (!swipeState.element) return;
  
  swipeState.currentX = e.touches[0].clientX;
  var currentY = e.touches[0].clientY;
  
  var diffX = swipeState.currentX - swipeState.startX;
  var diffY = currentY - swipeState.startY;
  
  // Swipe orizzontale > verticale
  if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
    swipeState.isDragging = true;
    e.preventDefault(); // Previeni scroll
    
    // Solo swipe left (negativo)
    if (diffX < 0) {
      swipeState.element.classList.add('swiping');
      swipeState.element.style.setProperty('--swipe-offset', diffX + 'px');
      
      // Mostra indicatore delete se oltre threshold
      if (Math.abs(diffX) > swipeState.threshold) {
        swipeState.element.classList.add('show-delete');
      } else {
        swipeState.element.classList.remove('show-delete');
      }
    }
  }
}

function handleTouchEnd(e) {
  if (!swipeState.element || !swipeState.isDragging) {
    resetSwipe();
    return;
  }
  
  var diffX = swipeState.currentX - swipeState.startX;
  
  // Se swipe oltre threshold, elimina
  if (diffX < -swipeState.threshold) {
    // Animazione delete
    swipeState.element.classList.add('swipe-delete');
    swipeState.element.classList.remove('swiping');
    
    // Haptic feedback
    if (window.navigator && window.navigator.vibrate) {
      window.navigator.vibrate(50);
    }
    
    // Elimina dopo animazione
    setTimeout(function() {
      eliminaTrans(swipeState.transId);
    }, 300);
  } else {
    // Reset position
    swipeState.element.classList.remove('swiping', 'show-delete');
    swipeState.element.style.setProperty('--swipe-offset', '0px');
  }
  
  resetSwipe();
}

function resetSwipe() {
  swipeState.startX = 0;
  swipeState.currentX = 0;
  swipeState.isDragging = false;
  swipeState.element = null;
  swipeState.transId = null;
}

// ========== PULL TO REFRESH ==========
var pullState = {
  startY: 0,
  pulling: false,
  threshold: 80
};

function initPullToRefresh() {
  var main = document.body;
  
  main.addEventListener('touchstart', function(e) {
    if (window.scrollY === 0) {
      pullState.startY = e.touches[0].pageY;
      pullState.pulling = true;
    }
  }, { passive: true });
  
  main.addEventListener('touchmove', function(e) {
    if (!pullState.pulling) return;
    
    var currentY = e.touches[0].pageY;
    var diff = currentY - pullState.startY;
    
    if (diff > 10 && window.scrollY === 0) {
      // Mostra indicatore (optional)
      if (diff > pullState.threshold) {
        // Visual feedback
        main.style.paddingTop = Math.min(diff * 0.5, 60) + 'px';
      }
    }
  }, { passive: true });
  
  main.addEventListener('touchend', function() {
    if (!pullState.pulling) return;
    
    var paddingTop = parseInt(main.style.paddingTop) || 0;
    
    if (paddingTop > 40) {
      // Trigger refresh
      mostraToast('üîÑ Aggiornamento...', 'info');
      
      if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate([50, 100, 50]);
      }
      
      setTimeout(function() {
        aggiorna();
        main.style.paddingTop = '0';
        mostraToast('‚úÖ Aggiornato!', 'success');
      }, 500);
    } else {
      main.style.paddingTop = '0';
    }
    
    pullState.pulling = false;
    pullState.startY = 0;
  }, { passive: true });
}

// Navigazione mesi per Movimenti
function cambiaMovimentiMese(delta) {
  mese += delta;
  if (mese < 0) { mese = 11; anno--; }
  if (mese > 11) { mese = 0; anno++; }
  aggiornaMovimentiMese();
  mostraTrans();
  aggiornaBottoniOggi();
  playSound('click');
}

function vaiOggiMovimenti() {
  var oggi = new Date();
  anno = oggi.getFullYear();
  mese = oggi.getMonth();
  aggiornaMovimentiMese();
  mostraTrans();
  aggiornaBottoniOggi();
  playSound('click');
}

function aggiornaMovimentiMese() {
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  var elem = document.getElementById('movimentiMeseCorrente');
  if (elem) {
    elem.textContent = mesiNomi[mese] + ' ' + anno;
  }
}

function mostraTrans() {
  var search = document.getElementById('searchTrans').value.toLowerCase();
  var filterType = document.getElementById('filterType').value;
  var filterCat = document.getElementById('filterCat').value;
  
  // Ricerca avanzata
  var dateFrom = document.getElementById('searchDateFrom').value;
  var dateTo = document.getElementById('searchDateTo').value;
  var amountMin = document.getElementById('searchAmountMin').value;
  var amountMax = document.getElementById('searchAmountMax').value;
  
  // Crea una copia dell'array transazioni con indici originali
  var listaConIndici = DB.transazioni.map(function(t, i) {
    return {
      data: t.data,
      ora: t.ora || '00:00',
      tipo: t.tipo,
      categoria: t.categoria,
      importo: t.importo,
      note: t.note,
      condiviso: t.condiviso || false,
      virtualRecovery: t.virtualRecovery || false,
      indiceOriginale: i
    };
  });
  
  var listaFiltrata = listaConIndici.filter(function(t) {
    // Filtro mensile/annuale
    var dataObj = new Date(t.data);
    if (!mostraTutteTransazioni) {
      // Mostra solo transazioni del mese corrente
      if (dataObj.getFullYear() !== anno || dataObj.getMonth() !== mese) return false;
    } else {
      // Mostra tutte le transazioni dell'anno
      if (dataObj.getFullYear() !== anno) return false;
    }
    
    if (filterType !== 'all' && t.tipo !== filterType) return false;
    if (filterCat !== 'all' && t.categoria !== filterCat) return false;
    
    // Filtri avanzati
    if (dateFrom && t.data < dateFrom) return false;
    if (dateTo && t.data > dateTo) return false;
    if (amountMin && t.importo < parseFloat(amountMin)) return false;
    if (amountMax && t.importo > parseFloat(amountMax)) return false;
    
    if (search) {
      var matchCat = t.categoria.toLowerCase().indexOf(search) > -1;
      var matchNote = (t.note || '').toLowerCase().indexOf(search) > -1;
      var matchAmount = t.importo.toString().indexOf(search) > -1;
      if (!matchCat && !matchNote && !matchAmount) return false;
    }
    
    return true;
  });
  
  // Ordinamento basato su ordinamentoTransazioni
  listaFiltrata.sort(function(a, b) {
    switch(ordinamentoTransazioni) {
      case 'recenti':
        var dateTimeA = new Date(a.data + ' ' + a.ora);
        var dateTimeB = new Date(b.data + ' ' + b.ora);
        return dateTimeB - dateTimeA;
      
      case 'ultime-inserite':
        // Ordina per indice originale (ultime inserite = indice pi√π alto)
        // Debug: verifica che gli indici siano corretti
        if (a.indiceOriginale === undefined || b.indiceOriginale === undefined) {
          console.warn('‚ö†Ô∏è Attenzione: indiceOriginale mancante!', a, b);
        }
        return b.indiceOriginale - a.indiceOriginale;
      
      case 'vecchie':
        var dateTimeA = new Date(a.data + ' ' + a.ora);
        var dateTimeB = new Date(b.data + ' ' + b.ora);
        return dateTimeA - dateTimeB;
      
      case 'a-z':
        var catA = a.categoria.toLowerCase();
        var catB = b.categoria.toLowerCase();
        if (catA < catB) return -1;
        if (catA > catB) return 1;
        return 0;
      
      case 'z-a':
        var catA = a.categoria.toLowerCase();
        var catB = b.categoria.toLowerCase();
        if (catA > catB) return -1;
        if (catA < catB) return 1;
        return 0;
      
      case 'importo-alto':
        return parseFloat(b.importo) - parseFloat(a.importo);
      
      case 'importo-basso':
        return parseFloat(a.importo) - parseFloat(b.importo);
      
      default:
        var dateTimeA = new Date(a.data + ' ' + a.ora);
        var dateTimeB = new Date(b.data + ' ' + b.ora);
        return dateTimeB - dateTimeA;
    }
  });
  
  var total = 0;
  listaFiltrata.forEach(function(t) {
    var imp = parseFloat(t.importo) || 0;
    // I recuperi virtuali NON modificano il totale (non intaccano patrimonio)
    if (t.tipo === 'income') total += imp;
    else if (t.tipo === 'expense' && !t.virtualRecovery) total -= imp;
    // 'partner' e 'virtualRecovery' non modificano il totale
  });
  
  document.getElementById('statsCount').textContent = listaFiltrata.length;
  document.getElementById('statsTotal').textContent = formatEuro(total);
  
  var container = document.getElementById('transList');
  container.innerHTML = '';
  
  if (listaFiltrata.length === 0) {
    container.innerHTML = '<div class="empty">üîç Nessuna transazione trovata</div>';
  } else {
    listaFiltrata.forEach(function(t) {
      var icon = 'üìâ';
      if (t.tipo === 'income') icon = 'üìà';
      else if (t.tipo === 'partner_payment') icon = 'üë•';
      var cls = '';
      if (t.tipo === 'income') cls = ' income';
      else if (t.tipo === 'partner_payment') cls = ' partner_payment';
      var date = new Date(t.data).toLocaleDateString('it-IT', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
      });
      
      var div = document.createElement('div');
      div.className = 'trans-item' + cls + (t.condiviso ? ' condiviso' : '');
      
      var badges = '';
      if (t.condiviso) badges += '<span class="condiviso-badge">CONDIVISO</span>';
      if (t.virtualRecovery) badges += '<span class="condiviso-badge" style="background:#9b59b6">üíù RECUPERO VIRTUALE</span>';
      
      var header = document.createElement('div');
      header.className = 'trans-header';
      header.innerHTML = '<strong>' + icon + ' ' + t.categoria + badges + '</strong><span class="trans-amount" style="color:' + (t.tipo === 'income' ? 'var(--income)' : (t.tipo === 'partner_payment' ? '#9b59b6' : 'var(--expense)')) + '">‚Ç¨' + t.importo.toFixed(2) + '</span>';
      
      var details = document.createElement('div');
      details.className = 'trans-details';
      var detailsHTML = 'üìÖ ' + date + ' ‚è∞ ' + t.ora;
      
      // Mostra indice quando ordini per "ultime inserite"
      if (ordinamentoTransazioni === 'ultime-inserite') {
        detailsHTML += ' <span style="background:#667eea;color:#fff;padding:2px 8px;border-radius:12px;font-size:0.75em;font-weight:700;margin-left:8px">#' + (t.indiceOriginale + 1) + '</span>';
      }
      
      if (t.note) detailsHTML += '<br>üìù ' + t.note;
      details.innerHTML = detailsHTML;
      
      var actions = document.createElement('div');
      actions.className = 'trans-actions';
      
      var btnMod = document.createElement('button');
      btnMod.className = 'btn-edit';
      btnMod.textContent = '‚úèÔ∏è Modifica';
      btnMod.onclick = function() { modifica(t.indiceOriginale); };
      
      var btnDel = document.createElement('button');
      btnDel.className = 'btn-danger';
      btnDel.textContent = 'üóëÔ∏è Elimina';
      btnDel.onclick = function() { eliminaTrans(t.indiceOriginale); };
      
      actions.appendChild(btnMod);
      actions.appendChild(btnDel);
      
      div.appendChild(header);
      div.appendChild(details);
      div.appendChild(actions);
      
      container.appendChild(div);
    });
  }
  
  // Inizializza gesture swipe su mobile
  if ('ontouchstart' in window) {
    initSwipeGestures();
  }
}

function modifica(id) {
  console.log('üîß MODIFICA CHIAMATA - ID:', id);
  var t = DB.transazioni[id];
  console.log('üîß Transazione trovata:', t);
  if (!t) {
    console.error('‚ùå Transazione non trovata per ID:', id);
    mostraToast('‚ùå Transazione non trovata', 'danger');
    return;
  }
  
  console.log('üîß Aprendo modal...');
  document.getElementById('modal').classList.add('active');
  document.getElementById('tid').value = id;
  document.getElementById('tdata').value = t.data;
  document.getElementById('tora').value = t.ora || '00:00';
  document.getElementById('ttipo').value = t.tipo;
  aggCatSel();
  document.getElementById('tcat').value = t.categoria;
  document.getElementById('timp').value = t.importo;
  document.getElementById('tnote').value = t.note || '';
  if (document.getElementById('tcondiviso')) {
    document.getElementById('tcondiviso').checked = t.condiviso || false;
    aggiornaVisualCheckbox();
  }
  if (document.getElementById('tvirtual')) {
    document.getElementById('tvirtual').checked = t.virtualRecovery || false;
    aggiornaVisualCheckboxVirtual();
  }
  console.log('‚úÖ Modal aperta con successo');
}

function eliminaTrans(id) {
  console.log('üóëÔ∏è ELIMINA CHIAMATA - ID:', id);
  console.log('üóëÔ∏è Totale transazioni:', DB.transazioni.length);
  
  if (id < 0 || id >= DB.transazioni.length) {
    console.error('‚ùå ID non valido:', id, 'Max:', DB.transazioni.length - 1);
    mostraToast('‚ùå Errore: transazione non valida', 'danger');
    return;
  }
  
  var t = DB.transazioni[id];
  console.log('üóëÔ∏è Transazione da eliminare:', t);
  var descrizione = t.categoria + ' - ‚Ç¨' + t.importo.toFixed(2);
  
  mostraConferma({
    icon: 'üóëÔ∏è',
    title: 'Elimina Transazione',
    message: 'Vuoi davvero eliminare questa transazione?\n\n' + descrizione + '\n\nQuesta azione non pu√≤ essere annullata.',
    confirmText: 'üóëÔ∏è Elimina',
    danger: true
  }).then(function(confirmed) {
    console.log('üóëÔ∏è Conferma ricevuta:', confirmed);
    if (!confirmed) {
      console.log('üóëÔ∏è Eliminazione annullata');
      return;
    }
    
    console.log('üóëÔ∏è Eliminando transazione ID:', id);
    // ELIMINA usando l'indice corretto
    DB.transazioni.splice(id, 1);
    salvaDB();
    mostraTrans();
    aggiorna();
    mostraAnalisi(); // Aggiorna anche la sezione analisi
    mostraToast('‚úÖ Transazione eliminata', 'success');
    console.log('‚úÖ Transazione eliminata con successo');
  });
}

// ========== CATEGORIE ==========
function mostraCats() {
  // Mostra categorie entrate
  var containerIn = document.getElementById('catIn');
  var htmlIn = '';
  
  DB.categorie.income.sort().forEach(function(cat, i) {
    htmlIn += '<div class="cat-item income">';
    htmlIn += '<strong>' + cat + '</strong>';
    htmlIn += '<div class="cat-actions">';
    htmlIn += '<button class="btn-edit" style="padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em" onclick="editCat(\'income\',' + i + ')">‚úèÔ∏è</button>';
    htmlIn += '<button class="btn-danger" style="padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:1em" onclick="elimCat(\'income\',' + i + ')">üóëÔ∏è</button>';
    htmlIn += '</div>';
    htmlIn += '</div>';
  });
  
  containerIn.innerHTML = htmlIn;
  
  // Mostra categorie uscite divise per tipo
  var categorieNecessita = [];
  var categorieDesideri = [];
  
  DB.categorie.expense.forEach(function(cat) {
    var tipo = DB.categorieClassificazione[cat] || 'desideri';
    if (tipo === 'necessita') {
      categorieNecessita.push(cat);
    } else {
      categorieDesideri.push(cat);
    }
  });
  
  // Necessit√†
  var containerNec = document.getElementById('catNecessita');
  var htmlNec = '';
  
  if (categorieNecessita.length === 0) {
    htmlNec = '<p style="font-size:0.9em;color:#7f8c8d;padding:10px;background:var(--bg);border-radius:10px">Nessuna categoria classificata come Necessit√†</p>';
  } else {
    categorieNecessita.sort().forEach(function(cat) {
      var idx = DB.categorie.expense.indexOf(cat);
      htmlNec += '<div class="cat-item expense" style="border-left-color:#e67e22">';
      htmlNec += '<strong>' + cat + '</strong>';
      htmlNec += '<div class="cat-actions">';
      htmlNec += '<button class="btn-edit" style="padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.9em" onclick="editCat(\'expense\',' + idx + ')">‚úèÔ∏è</button>';
      htmlNec += '<button class="btn-danger" style="padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.9em" onclick="elimCat(\'expense\',' + idx + ')">üóëÔ∏è</button>';
      htmlNec += '<button onclick="cambiaClassificazione(\'' + cat + '\', \'desideri\')" style="background:#9b59b6;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:0.85em;cursor:pointer;font-weight:600;white-space:nowrap">‚Üí Desideri</button>';
      htmlNec += '</div>';
      htmlNec += '</div>';
    });
  }
  
  containerNec.innerHTML = htmlNec;
  
  // Desideri
  var containerDes = document.getElementById('catDesideri');
  var htmlDes = '';
  
  if (categorieDesideri.length === 0) {
    htmlDes = '<p style="font-size:0.9em;color:#7f8c8d;padding:10px;background:var(--bg);border-radius:10px">Nessuna categoria classificata come Desideri</p>';
  } else {
    categorieDesideri.sort().forEach(function(cat) {
      var idx = DB.categorie.expense.indexOf(cat);
      htmlDes += '<div class="cat-item expense" style="border-left-color:#9b59b6">';
      htmlDes += '<strong>' + cat + '</strong>';
      htmlDes += '<div class="cat-actions">';
      htmlDes += '<button class="btn-edit" style="padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.9em" onclick="editCat(\'expense\',' + idx + ')">‚úèÔ∏è</button>';
      htmlDes += '<button class="btn-danger" style="padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.9em" onclick="elimCat(\'expense\',' + idx + ')">üóëÔ∏è</button>';
      htmlDes += '<button onclick="cambiaClassificazione(\'' + cat + '\', \'necessita\')" style="background:#e67e22;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:0.85em;cursor:pointer;font-weight:600;white-space:nowrap">‚Üí Necessit√†</button>';
      htmlDes += '</div>';
      htmlDes += '</div>';
    });
  }
  
  containerDes.innerHTML = htmlDes;
}

async function aggCatConClassificazione() {
  mostraDialogInput('üìù Nome della nuova categoria di uscita:', 'Es: Spesa Casa', function(name) {
    // Debug
    
    if (!name || !name.trim()) {
      return;
    }
    
    name = name.trim();
    
    if (DB.categorie.expense.indexOf(name) > -1) {
      mostraToast('‚ö†Ô∏è Categoria gi√† esistente!', 'warning');
      return;
    }
    
    
    // Dialog classificazione
    var modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)';
    
    var dialog = document.createElement('div');
    dialog.style.cssText = 'background:var(--card);border-radius:20px;padding:30px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4)';
    
    dialog.innerHTML = '<h3 style="margin-bottom:15px;color:var(--text);font-size:1.4em;text-align:center">üè∑Ô∏è Classifica "' + name + '"</h3>' +
      '<p style="margin-bottom:25px;color:#7f8c8d;text-align:center;line-height:1.6;font-size:0.95em">Dividi le spese in <strong style="color:var(--income)">Necessit√† (65%)</strong> e <strong style="color:var(--expense)">Desideri (20%)</strong></p>' +
      '<div style="display:grid;gap:14px">' +
      '<button id="btnNecessita" style="padding:20px;border:none;background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;border-radius:16px;font-weight:700;font-size:1.1em;cursor:pointer;box-shadow:0 6px 20px rgba(39,174,96,0.4)">' +
      '<div style="font-size:1.3em;margin-bottom:5px">‚úÖ Necessit√† (65%)</div>' +
      '<div style="font-size:0.85em;font-weight:400;opacity:0.95">Affitto, cibo, bollette...</div>' +
      '</button>' +
      '<button id="btnDesideri" style="padding:20px;border:none;background:linear-gradient(135deg,#e67e22,#f39c12);color:#fff;border-radius:16px;font-weight:700;font-size:1.1em;cursor:pointer;box-shadow:0 6px 20px rgba(230,126,34,0.4)">' +
      '<div style="font-size:1.3em;margin-bottom:5px">üéÅ Desideri (20%)</div>' +
      '<div style="font-size:0.85em;font-weight:400;opacity:0.95">Shopping, uscite, hobby...</div>' +
      '</button>' +
      '</div>';
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    document.getElementById('btnNecessita').onclick = function() {
      document.body.removeChild(modal);
      
      DB.categorieClassificazione[name] = 'necessita';
      DB.categorie.expense.push(name);
      DB.categorie.expense.sort();
      
      salvaDB();
      
      mostraCats();
      
      mostraToast('‚úÖ Categoria "' + name + '" aggiunta come Necessit√†!', 'success');
    };
    
    document.getElementById('btnDesideri').onclick = function() {
      document.body.removeChild(modal);
      
      DB.categorieClassificazione[name] = 'desideri';
      DB.categorie.expense.push(name);
      DB.categorie.expense.sort();
      
      salvaDB();
      
      mostraCats();
      
      mostraToast('‚úÖ Categoria "' + name + '" aggiunta come Desiderio!', 'success');
    };
  });
}

function mostraClassificazioneCategorie() {
  // Funzione rimossa - ora integrata in mostraCats()
}

function cambiaClassificazione(categoria, nuovoTipo) {
  DB.categorieClassificazione[categoria] = nuovoTipo;
  salvaDB();
  mostraCats();
  
  // Aggiorna finanze se siamo in quella sezione
  if (currentSection === 'finanze') {
    aggiornaRisparmio();
  }
  
  var nomeNuovoTipo = nuovoTipo === 'necessita' ? 'Necessit√†' : 'Desideri';
  mostraToast('‚úÖ "' + categoria + '" spostata in ' + nomeNuovoTipo, 'success');
  playSound('success');
}

function aggCat(tipo) {
  var tipoTesto = tipo === 'income' ? 'entrata' : 'uscita';
  
  mostraDialogInput('üìù Nome della nuova categoria di ' + tipoTesto + ':', 'Inserisci nome...', function(name) {
    
    if (!name || !name.trim()) {
      return;
    }
    
    name = name.trim();
    
    if (DB.categorie[tipo].indexOf(name) > -1) {
      mostraToast('‚ö†Ô∏è Categoria gi√† esistente!', 'warning');
      return;
    }
    
    // Se √® expense, chiedi classificazione
    if (tipo === 'expense') {
      
      var modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)';
      
      var dialog = document.createElement('div');
      dialog.style.cssText = 'background:var(--card);border-radius:20px;padding:30px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4)';
      
      dialog.innerHTML = '<h3 style="margin-bottom:15px;color:var(--text);font-size:1.4em;text-align:center">üè∑Ô∏è Classifica "' + name + '"</h3>' +
        '<p style="margin-bottom:25px;color:#7f8c8d;text-align:center;line-height:1.6;font-size:0.95em">Dividi le spese in <strong style="color:var(--income)">Necessit√† (65%)</strong> e <strong style="color:var(--expense)">Desideri (20%)</strong></p>' +
        '<div style="display:grid;gap:14px">' +
        '<button id="btnNec" style="padding:20px;border:none;background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;border-radius:16px;font-weight:700;font-size:1.1em;cursor:pointer;box-shadow:0 6px 20px rgba(39,174,96,0.4)">' +
        '<div style="font-size:1.3em;margin-bottom:5px">‚úÖ Necessit√† (65%)</div>' +
        '<div style="font-size:0.85em;font-weight:400;opacity:0.95">Affitto, cibo, bollette...</div>' +
        '</button>' +
        '<button id="btnDes" style="padding:20px;border:none;background:linear-gradient(135deg,#e67e22,#f39c12);color:#fff;border-radius:16px;font-weight:700;font-size:1.1em;cursor:pointer;box-shadow:0 6px 20px rgba(230,126,34,0.4)">' +
        '<div style="font-size:1.3em;margin-bottom:5px">üéÅ Desideri (20%)</div>' +
        '<div style="font-size:0.85em;font-weight:400;opacity:0.95">Shopping, uscite, hobby...</div>' +
        '</button>' +
        '</div>';
      
      modal.appendChild(dialog);
      document.body.appendChild(modal);
      
      document.getElementById('btnNec').onclick = function() {
        document.body.removeChild(modal);
        DB.categorieClassificazione[name] = 'necessita';
        DB.categorie[tipo].push(name);
        DB.categorie[tipo].sort();
        salvaDB();
        mostraCats();
        mostraToast('‚úÖ Categoria aggiunta!', 'success');
      };
      
      document.getElementById('btnDes').onclick = function() {
        document.body.removeChild(modal);
        DB.categorieClassificazione[name] = 'desideri';
        DB.categorie[tipo].push(name);
        DB.categorie[tipo].sort();
        salvaDB();
        mostraCats();
        mostraToast('‚úÖ Categoria aggiunta!', 'success');
      };
    } else {
      // Income - nessuna classificazione
      DB.categorie[tipo].push(name);
      DB.categorie[tipo].sort();
      salvaDB();
      mostraCats();
      mostraToast('‚úÖ Categoria aggiunta!', 'success');
    }
  });
}

function editCat(tipo, idx) {
  var oldName = DB.categorie[tipo][idx];
  var newName = prompt('‚úèÔ∏è Nuovo nome per "' + oldName + '":', oldName);
  
  if (!newName || !newName.trim() || newName.trim() === oldName) return;
  
  newName = newName.trim();
  
  if (DB.categorie[tipo].indexOf(newName) > -1) {
    mostraToast('‚ö†Ô∏è Nome gi√† esistente!', 'warning');
    return;
  }
  
  // Aggiorna transazioni
  DB.transazioni.forEach(function(t) {
    if (t.tipo === tipo && t.categoria === oldName) {
      t.categoria = newName;
    }
  });
  
  // Se √® expense, mantieni la classificazione
  if (tipo === 'expense' && DB.categorieClassificazione[oldName]) {
    DB.categorieClassificazione[newName] = DB.categorieClassificazione[oldName];
    delete DB.categorieClassificazione[oldName];
  }
  
  DB.categorie[tipo][idx] = newName;
  DB.categorie[tipo].sort();
  salvaDB();
  mostraCats();
  mostraToast('‚úÖ Categoria rinominata!', 'success');
}

function elimCat(tipo, idx) {
  var cat = DB.categorie[tipo][idx];
  
  // Verifica se la categoria √® in uso
  var used = DB.transazioni.some(function(t) {
    // Per le categorie expense, controlla sia expense che partner_payment
    if (tipo === 'expense') {
      return (t.tipo === 'expense' || t.tipo === 'partner_payment') && t.categoria === cat;
    }
    return t.tipo === tipo && t.categoria === cat;
  });
  
  if (used) {
    mostraToast('‚ö†Ô∏è Categoria in uso nelle transazioni!', 'warning');
    playSound('error');
    return;
  }
  
  mostraConferma({
    icon: 'üóëÔ∏è',
    title: 'Elimina Categoria',
    message: 'Vuoi davvero eliminare la categoria "' + cat + '"?\n\nQuesta azione non pu√≤ essere annullata.',
    confirmText: 'üóëÔ∏è Elimina',
    danger: true
  }).then(function(confirmed) {
    if (!confirmed) return;
    
    DB.categorie[tipo].splice(idx, 1);
    
    // Rimuovi anche la classificazione se esiste
    if (tipo === 'expense' && DB.categorieClassificazione[cat]) {
      delete DB.categorieClassificazione[cat];
    }
    
    salvaDB();
    mostraCats();
    mostraToast('‚úÖ Categoria eliminata!', 'success');
  });
}

// ========== EXPORT/IMPORT ==========
function mostraCSV() {
  if (!DB.transazioni || DB.transazioni.length === 0) {
    mostraToast('‚ö†Ô∏è Nessuna transazione da esportare!', 'warning');
    return;
  }
  
  var csv = 'Data,Ora,Tipo,Categoria,Importo,Note\n';
  
  DB.transazioni.slice().sort(function(a, b) {
    var dateTimeA = new Date(a.data + ' ' + (a.ora || '00:00'));
    var dateTimeB = new Date(b.data + ' ' + (b.ora || '00:00'));
    return dateTimeA - dateTimeB;
  }).forEach(function(t) {
    var tipo = t.tipo === 'income' ? 'Entrata' : 'Uscita';
    var note = (t.note || '').replace(/"/g, '""');
    var ora = t.ora || '00:00';
    csv += t.data + ',' + ora + ',' + tipo + ',' + t.categoria + ',' + t.importo.toFixed(2) + ',"' + note + '"\n';
  });
  
  var modal = document.getElementById('modal');
  modal.classList.add('active');
  
  var content = modal.querySelector('.modal-content');
  content.innerHTML = '<div class="modal-header"><h3>üìä Esporta CSV</h3><button class="close-btn" onclick="chiudiModal()">√ó</button></div>';
  content.innerHTML += '<div class="info-box">Copia questi dati e incollali in Excel o Google Sheets</div>';
  content.innerHTML += '<textarea readonly style="width:100%;height:300px;padding:12px;font-family:monospace;font-size:0.9em;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text)">' + csv + '</textarea>';
  content.innerHTML += '<button class="btn" onclick="copiaCSV()">üìã Copia negli Appunti</button>';
  content.innerHTML += '<button class="btn btn-danger" onclick="chiudiModal()">Chiudi</button>';
  
  window.tempCSV = csv;
}

function copiaCSV() {
  var textarea = document.createElement('textarea');
  textarea.value = window.tempCSV;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    document.execCommand('copy');
    mostraToast('‚úÖ Dati copiati negli appunti!', 'success');
  } catch (e) {
    mostraToast('‚ùå Impossibile copiare automaticamente', 'danger');
  }
  
  document.body.removeChild(textarea);
}

function esporta() {
  try {
    var txt = JSON.stringify(DB, null, 2);
    var blob = new Blob([txt], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'budget_backup_' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    mostraToast('‚úÖ Backup esportato!', 'success');
  } catch (e) {
    mostraToast('‚ùå Errore durante l\'esportazione', 'danger');
  }
}

function importa(e) {
  var file = e.target.files[0];
  if (!file) return;
  
  var reader = new FileReader();
  reader.onload = function(evt) {
    try {
      var imported = JSON.parse(evt.target.result);
      
      if (!imported.categorie || !imported.transazioni) {
        mostraToast('‚ùå File non valido!', 'danger');
        return;
      }
      
      mostraConferma({
        icon: '‚ö†Ô∏è',
        title: 'Importa Dati',
        message: 'Sostituire TUTTI i dati attuali?\n\nI dati esistenti verranno eliminati definitivamente.',
        confirmText: 'üì• Importa',
        danger: true
      }).then(function(confirmed) {
        if (!confirmed) return;
        
        DB = imported;
        if (!DB.theme) DB.theme = 'auto';
        salvaDB();
        mostraToast('‚úÖ Dati importati! Ricarico...', 'success');
        setTimeout(function() { location.reload(); }, 1500);
      });
    } catch (e) {
      mostraToast('‚ùå File non valido!', 'danger');
    }
  };
  reader.readAsText(file);
  
  e.target.value = '';
}

function reset() {
  mostraConferma({
    icon: '‚ö†Ô∏è',
    title: 'ELIMINA TUTTI I DATI',
    message: 'ATTENZIONE: Questa azione eliminer√† TUTTI i dati in modo IRREVERSIBILE!\n\nSei ASSOLUTAMENTE SICURO di voler procedere?',
    confirmText: 'üóëÔ∏è ELIMINA TUTTO',
    danger: true
  }).then(function(confirmed) {
    if (!confirmed) return;
    
    // Seconda conferma
    mostraConferma({
      icon: 'üö®',
      title: 'ULTIMA CONFERMA',
      message: 'I dati non potranno essere recuperati!\n\nConfermi l\'eliminazione definitiva?',
      confirmText: 'üóëÔ∏è S√å, ELIMINA',
      danger: true
    }).then(function(doubleConfirm) {
      if (!doubleConfirm) return;
      
      localStorage.removeItem('budgetDBPro');
      mostraToast('‚úÖ Dati eliminati. Ricarico...', 'success');
      setTimeout(function() { location.reload(); }, 1500);
    });
  });
}

// ========== GESTIONE DATA TRACKING ==========
function salvaDataTracking() {
  var data = document.getElementById('trackingDateInput').value;
  if (!data) {
    mostraToast('‚ö†Ô∏è Seleziona una data!', 'warning');
    return;
  }
  
  DB.dataInizioTracking = data;
  salvaDB();
  mostraDataTracking();
  mostraToast('‚úÖ Data inizio salvata!', 'success');
}

function resetDataTracking() {
  mostraConferma({
    icon: 'üîÑ',
    title: 'Reimposta Data Tracking',
    message: 'Vuoi reimpostare la data di inizio tracking?',
    confirmText: 'üîÑ Reimposta',
    danger: false
  }).then(function(confirmed) {
    if (!confirmed) return;
    
    DB.dataInizioTracking = null;
    document.getElementById('trackingDateInput').value = '';
    salvaDB();
    mostraDataTracking();
    mostraToast('‚úÖ Data reimpostata!', 'success');
  });
}

function mostraDataTracking() {
  var displayElement = document.getElementById('trackingDateDisplay');
  var daysElement = document.getElementById('trackingDays');
  var inputElement = document.getElementById('trackingDateInput');
  
  if (DB.dataInizioTracking) {
    var dataInizio = new Date(DB.dataInizioTracking);
    var oggi = new Date();
    var diffTime = Math.abs(oggi - dataInizio);
    var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    var dataFormattata = dataInizio.toLocaleDateString('it-IT', { 
      day: 'numeric', 
      month: 'long', 
      year: 'numeric' 
    });
    
    displayElement.textContent = dataFormattata;
    
    if (diffDays === 0) {
      daysElement.textContent = 'Iniziato oggi! üéâ';
    } else if (diffDays === 1) {
      daysElement.textContent = '1 giorno di tracking';
    } else if (diffDays < 30) {
      daysElement.textContent = diffDays + ' giorni di tracking';
    } else if (diffDays < 365) {
      var mesi = Math.floor(diffDays / 30);
      var giorniRestanti = diffDays % 30;
      daysElement.textContent = mesi + ' ' + (mesi === 1 ? 'mese' : 'mesi') + 
        (giorniRestanti > 0 ? ' e ' + giorniRestanti + ' giorni' : '') + ' di tracking';
    } else {
      var anni = Math.floor(diffDays / 365);
      var giorniRestanti = diffDays % 365;
      daysElement.textContent = anni + ' ' + (anni === 1 ? 'anno' : 'anni') + 
        (giorniRestanti > 0 ? ' e ' + giorniRestanti + ' giorni' : '') + ' di tracking üèÜ';
    }
    
    inputElement.value = DB.dataInizioTracking;
  } else {
    displayElement.textContent = 'Non impostata';
    daysElement.textContent = 'Imposta una data per iniziare';
    inputElement.value = '';
  }
}

// ========== UTILITY ==========
function formatEuro(val) {
  return '‚Ç¨' + val.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// ========== WIDGET RIASSUNTIVO ==========
function aggiornaWidget() {
  var saldo = 0;
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'income') saldo += imp;
      else if (t.tipo === 'expense') saldo -= imp;
    }
  });
  
  document.getElementById('widgetValue').textContent = formatEuro(saldo);
  
  // Mostra widget solo se non sei in dashboard
  var widget = document.getElementById('widgetFloat');
  widget.style.display = currentSection === 'dash' ? 'none' : 'block';
}

// ========== TABELLE RIEPILOGO MENSILI ==========
function popolaTabelleMensili() {
  // Verifica che gli elementi esistano
  var tableYear = document.getElementById('tableYear');
  var incomeBody = document.getElementById('incomeTableBody');
  var expenseBody = document.getElementById('expenseTableBody');
  var savingsBody = document.getElementById('savingsTableBody');
  
  if (!tableYear || !incomeBody || !expenseBody || !savingsBody) {
    return;
  }
  
  var mesiNomi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                  'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
  var mesiIcone = ['‚ùÑÔ∏è', 'üå®Ô∏è', 'üå∏', 'üå∑', 'üå∫', '‚òÄÔ∏è', 'üèñÔ∏è', 'üåû', 'üçÇ', 'üéÉ', 'üçÅ', 'üéÑ'];
  
  // Aggiorna display anno
  document.getElementById('tableYear').textContent = annoTabelle;
  document.getElementById('tableYear2').textContent = annoTabelle;
  document.getElementById('tableYear3').textContent = annoTabelle;
  
  // Calcola dati per ogni mese
  var datiMensili = [];
  var totaleEntrate = 0;
  var totaleUscite = 0;
  var totaleRisparmi = 0;
  
  for (var m = 0; m < 12; m++) {
    var entrate = 0;
    var uscite = 0;
    
    DB.transazioni.forEach(function(t) {
      var d = new Date(t.data);
      if (d.getFullYear() === annoTabelle && d.getMonth() === m) {
        var imp = parseFloat(t.importo) || 0;
        if (t.tipo === 'income') {
          entrate += imp;
        } else if (t.tipo === 'expense' && !t.virtualRecovery) {
          uscite += imp;
        }
      }
    });
    
    var saldo = entrate - uscite;
    
    datiMensili.push({
      mese: m,
      nome: mesiNomi[m],
      icona: mesiIcone[m],
      entrate: entrate,
      uscite: uscite,
      saldo: saldo
    });
    
    totaleEntrate += entrate;
    totaleUscite += uscite;
    totaleRisparmi += saldo;
  }
  
  // Popola tabella entrate
  var incomeBody = document.getElementById('incomeTableBody');
  incomeBody.innerHTML = '';
  datiMensili.forEach(function(dato) {
    var tr = document.createElement('tr');
    var meseCorrente = (annoTabelle === new Date().getFullYear() && dato.mese === new Date().getMonth());
    if (meseCorrente) tr.classList.add('current-month');
    
    tr.innerHTML = '<td><span class="month-name"><span class="month-icon">' + dato.icona + '</span>' + dato.nome + '</span></td>' +
                   '<td class="amount-positive">' + formatEuro(dato.entrate) + '</td>';
    incomeBody.appendChild(tr);
  });
  document.getElementById('incomeTotalYear').textContent = formatEuro(totaleEntrate);
  
  // Popola tabella uscite
  var expenseBody = document.getElementById('expenseTableBody');
  expenseBody.innerHTML = '';
  datiMensili.forEach(function(dato) {
    var tr = document.createElement('tr');
    var meseCorrente = (annoTabelle === new Date().getFullYear() && dato.mese === new Date().getMonth());
    if (meseCorrente) tr.classList.add('current-month');
    
    tr.innerHTML = '<td><span class="month-name"><span class="month-icon">' + dato.icona + '</span>' + dato.nome + '</span></td>' +
                   '<td class="amount-negative">' + formatEuro(dato.uscite) + '</td>';
    expenseBody.appendChild(tr);
  });
  document.getElementById('expenseTotalYear').textContent = formatEuro(totaleUscite);
  
  // Popola tabella risparmi
  var savingsBody = document.getElementById('savingsTableBody');
  savingsBody.innerHTML = '';
  datiMensili.forEach(function(dato) {
    var tr = document.createElement('tr');
    var meseCorrente = (annoTabelle === new Date().getFullYear() && dato.mese === new Date().getMonth());
    if (meseCorrente) tr.classList.add('current-month');
    
    var colorClass = dato.saldo > 0 ? 'amount-positive' : (dato.saldo < 0 ? 'amount-negative' : 'amount-neutral');
    tr.innerHTML = '<td><span class="month-name"><span class="month-icon">' + dato.icona + '</span>' + dato.nome + '</span></td>' +
                   '<td class="' + colorClass + '">' + (dato.saldo >= 0 ? '+' : '') + formatEuro(dato.saldo) + '</td>';
    savingsBody.appendChild(tr);
  });
  
  var saldoColorClass = totaleRisparmi > 0 ? 'savings' : (totaleRisparmi < 0 ? 'expense' : 'income');
  var savingsTotalEl = document.getElementById('savingsTotalYear');
  savingsTotalEl.textContent = (totaleRisparmi >= 0 ? '+' : '') + formatEuro(totaleRisparmi);
  savingsTotalEl.className = 'table-footer-value ' + saldoColorClass;
}

function cambiaAnnoTabelle(delta) {
  annoTabelle += delta;
  if (typeof popolaTabelleMensili === 'function') {
    popolaTabelleMensili();
  }
  if (typeof playSound === 'function') {
    playSound('click');
  }
}

function toggleTabelle() {
  var content = document.getElementById('tabelleContent');
  var icon = document.getElementById('tabelleIcon');
  
  if (!content || !icon) {
    return;
  }
  
  if (content.style.display === 'none' || content.style.display === '') {
    content.style.display = 'block';
    icon.textContent = '‚ñº';
    icon.style.transform = 'rotate(0deg)';
    
    // Popola le tabelle quando vengono aperte
    if (typeof popolaTabelleMensili === 'function') {
      popolaTabelleMensili();
    }
  } else {
    content.style.display = 'none';
    icon.textContent = '‚ñ∂';
    icon.style.transform = 'rotate(0deg)';
  }
  
  if (typeof playSound === 'function') {
    playSound('click');
  }
}

// ========== CALENDAR HEATMAP COMPATTO OTTIMIZZATO ==========
function generaCalendarHeatmap(mese, anno) {
  var container = document.getElementById('calendarHeatmap');
  if (!container) return;
  
  var numGiorni = new Date(anno, mese + 1, 0).getDate();
  
  // Calcola spese per ogni giorno
  var speseGiornaliere = {};
  var totaleSpese = 0;
  var giorniConSpese = 0;
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese && t.tipo === 'expense' && !t.virtualRecovery) {
      var giorno = d.getDate();
      var imp = parseFloat(t.importo);
      speseGiornaliere[giorno] = (speseGiornaliere[giorno] || 0) + imp;
      totaleSpese += imp;
    }
  });
  
  // Trova max per scala colori
  var valori = Object.values(speseGiornaliere);
  var maxSpesa = valori.length > 0 ? Math.max.apply(Math, valori) : 0;
  giorniConSpese = valori.filter(function(v) { return v > 0; }).length;
  var mediaGiornaliera = totaleSpese / numGiorni;
  var giorniSenzaSpese = numGiorni - giorniConSpese;
  
  // Funzione per determinare il livello di intensit√† (1-5)
  function getLevel(amount, max) {
    if (!amount || amount === 0) return 0;
    if (max === 0) return 1;
    
    var intensity = amount / max;
    if (intensity <= 0.2) return 1; // Verde - Minimo
    if (intensity <= 0.4) return 2; // Giallo - Basso
    if (intensity <= 0.6) return 3; // Arancione - Medio
    if (intensity <= 0.8) return 4; // Rosso chiaro - Alto
    return 5; // Rosso scuro - Massimo
  }
  
  var html = '<div class="heatmap-compact">';
  
  var oggi = new Date();
  for (var giorno = 1; giorno <= numGiorni; giorno++) {
    var spesa = speseGiornaliere[giorno] || 0;
    var hasExpense = spesa > 0;
    var level = getLevel(spesa, maxSpesa);
    
    var isToday = oggi.getDate() === giorno && 
                  oggi.getMonth() === mese && 
                  oggi.getFullYear() === anno;
    
    // Classi CSS
    var classes = 'heatmap-compact-day';
    if (isToday) classes += ' today';
    if (!hasExpense) {
      classes += ' no-expense';
    } else {
      classes += ' has-expense level-' + level;
    }
    
    // Tooltip con data-amount
    var tooltipText = hasExpense ? '‚Ç¨' + spesa.toFixed(2) : 'Nessuna spesa';
    
    html += '<div class="' + classes + '" ' +
            'data-amount="' + tooltipText + '" ' +
            'onclick="mostraTransazioniGiorno(' + anno + ',' + mese + ',' + giorno + ')" ' +
            'title="Giorno ' + giorno + ': ' + tooltipText + (hasExpense ? ' - Click per dettagli' : '') + '">' +
            giorno +
            '</div>';
  }
  
  html += '</div>';
  
  // Legenda MIGLIORATA con descrizioni chiare
  html += '<div class="heatmap-compact-legend">';
  
  html += '<div class="heatmap-legend-item">';
  html += '<div class="heatmap-compact-legend-box" style="background:var(--bg);border:2px dashed #ddd"></div>';
  html += '<span style="font-weight:600">Nessuna spesa</span>';
  html += '</div>';
  
  html += '<div class="heatmap-legend-item">';
  html += '<div class="heatmap-compact-legend-box" style="background:linear-gradient(135deg,#52c41a,#73d13d)"></div>';
  html += '<span>Minimo</span>';
  html += '</div>';
  
  html += '<div class="heatmap-legend-item">';
  html += '<div class="heatmap-compact-legend-box" style="background:linear-gradient(135deg,#fadb14,#ffc53d)"></div>';
  html += '<span>Basso</span>';
  html += '</div>';
  
  html += '<div class="heatmap-legend-item">';
  html += '<div class="heatmap-compact-legend-box" style="background:linear-gradient(135deg,#fa8c16,#ff9c6e)"></div>';
  html += '<span>Medio</span>';
  html += '</div>';
  
  html += '<div class="heatmap-legend-item">';
  html += '<div class="heatmap-compact-legend-box" style="background:linear-gradient(135deg,#f5222d,#ff4d4f)"></div>';
  html += '<span>Alto</span>';
  html += '</div>';
  
  html += '<div class="heatmap-legend-item">';
  html += '<div class="heatmap-compact-legend-box" style="background:linear-gradient(135deg,#a8071a,#cf1322)"></div>';
  html += '<span>Massimo</span>';
  html += '</div>';
  
  html += '</div>';
  
  // Mini statistiche (4 in una riga)
  html += '<div class="heatmap-stats">';
  
  html += '<div class="heatmap-stat">';
  html += '<div class="heatmap-stat-label">üí∞ Totale</div>';
  html += '<div class="heatmap-stat-value">‚Ç¨' + totaleSpese.toFixed(0) + '</div>';
  html += '</div>';
  
  html += '<div class="heatmap-stat">';
  html += '<div class="heatmap-stat-label">üìä Media/Giorno</div>';
  html += '<div class="heatmap-stat-value">‚Ç¨' + mediaGiornaliera.toFixed(0) + '</div>';
  html += '</div>';
  
  html += '<div class="heatmap-stat">';
  html += '<div class="heatmap-stat-label">üî• Max Giorno</div>';
  html += '<div class="heatmap-stat-value">‚Ç¨' + (maxSpesa || 0).toFixed(0) + '</div>';
  html += '</div>';
  
  html += '<div class="heatmap-stat">';
  html += '<div class="heatmap-stat-label">‚úÖ Giorni OK</div>';
  html += '<div class="heatmap-stat-value" style="color:#52c41a">' + giorniSenzaSpese + '</div>';
  html += '</div>';
  
  html += '</div>';
  
  container.innerHTML = html;
}

// ========== DRILL-DOWN TRANSAZIONI GIORNO ==========
function mostraTransazioniGiorno(anno, mese, giorno) {
  playSound('click');
  
  // Crea data string nel formato YYYY-MM-DD
  var meseStr = String(mese + 1).padStart(2, '0');  // mese √® 0-indexed
  var giornoStr = String(giorno).padStart(2, '0');
  var dataStr = anno + '-' + meseStr + '-' + giornoStr;
  
  var trans = DB.transazioni.filter(function(t) {
    return t.data.startsWith(dataStr) && t.tipo === 'expense' && !t.virtualRecovery;
  });
  
  if (trans.length === 0) {
    mostraToast('üì≠ Nessuna spesa in questo giorno', 'info');
    return;
  }
  
  var modal = document.getElementById('modal');
  modal.classList.add('active');
  
  var nomiMesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno',
                  'Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  
  var html = '<div class="modal-header">';
  html += '<h3>üìÖ ' + giorno + ' ' + nomiMesi[mese] + ' ' + anno + '</h3>';
  html += '<button class="close-btn" onclick="chiudiModal()">√ó</button>';
  html += '</div>';
  html += '<div style="padding:20px;max-height:500px;overflow-y:auto">';
  
  var totale = 0;
  trans.forEach(function(t) {
    totale += parseFloat(t.importo);
    var nota = t.note || '';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg);border-radius:10px;margin-bottom:10px;border-left:4px solid var(--expense);transition:all 0.2s" onmouseover="this.style.transform=\'translateX(4px)\'" onmouseout="this.style.transform=\'\'">';
    html += '<div style="flex:1">';
    html += '<div style="font-weight:700;font-size:1.1em;margin-bottom:4px">' + t.categoria + '</div>';
    if (nota) {
      html += '<div style="font-size:0.85em;opacity:0.7">üí¨ ' + nota + '</div>';
    }
    html += '</div>';
    html += '<div style="font-size:1.4em;font-weight:800;color:var(--expense)">‚Ç¨' + t.importo.toFixed(2) + '</div>';
    html += '</div>';
  });
  
  html += '<div style="margin-top:20px;padding:20px;background:linear-gradient(135deg,var(--expense),#d35400);color:#fff;border-radius:12px;text-align:center;box-shadow:0 4px 12px rgba(230,126,34,0.3)">';
  html += '<div style="font-size:0.95em;opacity:0.95;margin-bottom:8px">üí∞ Totale Giorno</div>';
  html += '<div style="font-size:2.5em;font-weight:800">‚Ç¨' + totale.toFixed(2) + '</div>';
  html += '<div style="font-size:0.9em;opacity:0.9;margin-top:8px">' + trans.length + ' transazion' + (trans.length === 1 ? 'e' : 'i') + '</div>';
  html += '</div>';
  html += '</div>';
  
  modal.querySelector('.modal-content').innerHTML = html;
}

// ========== GRAFICO CONFRONTO 6 MESI ==========
function generaGraficoConfronto6Mesi() {
  var ctx = document.getElementById('compareChart');
  if (!ctx) return;
  
  var oggi = new Date();
  var mesi = [];
  var entrate = [];
  var uscite = [];
  var saldi = [];
  
  // Calcola ultimi 6 mesi
  for (var i = 5; i >= 0; i--) {
    var data = new Date(oggi.getFullYear(), oggi.getMonth() - i, 1);
    var mese = data.getMonth();
    var anno = data.getFullYear();
    
    var nomiMesi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    mesi.push(nomiMesi[mese]);
    
    var entratasMese = 0;
    var usciteMese = 0;
    
    DB.transazioni.forEach(function(t) {
      var d = new Date(t.data);
      if (d.getFullYear() === anno && d.getMonth() === mese) {
        var importo = parseFloat(t.importo) || 0;
        if (t.tipo === 'income') {
          entratasMese += importo;
        } else if (t.tipo === 'expense' && !t.virtualRecovery) {
          usciteMese += importo;
        }
      }
    });
    
    entrate.push(entratasMese);
    uscite.push(usciteMese);
    saldi.push(entratasMese - usciteMese);
  }
  
  var isDark = document.body.classList.contains('dark');
  
  if (compareChart) compareChart.destroy();
  compareChart = new Chart(ctx.getContext('2d'), {
    type: 'bar',
    data: {
      labels: mesi,
      datasets: [
        {
          label: 'Entrate',
          data: entrate,
          backgroundColor: 'rgba(39, 174, 96, 0.8)',
          borderColor: '#27ae60',
          borderWidth: 2,
          borderRadius: 6,
          barPercentage: 0.7
        },
        {
          label: 'Uscite',
          data: uscite,
          backgroundColor: 'rgba(231, 76, 60, 0.8)',
          borderColor: '#e74c3c',
          borderWidth: 2,
          borderRadius: 6,
          barPercentage: 0.7
        },
        {
          label: 'Saldo',
          data: saldi,
          type: 'line',
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: '#667eea',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          tension: 0.4,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: {
          left: 0,
          right: 10,
          top: 5,
          bottom: 0
        }
      },
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: isDark ? '#eee' : '#2c3e50',
            font: { size: 11, weight: '700' },
            padding: 10,
            usePointStyle: true,
            boxWidth: 12,
            boxHeight: 12
          }
        },
        tooltip: {
          backgroundColor: isDark ? 'rgba(44,62,80,0.95)' : 'rgba(255,255,255,0.95)',
          titleColor: isDark ? '#fff' : '#2c3e50',
          bodyColor: isDark ? '#fff' : '#2c3e50',
          borderColor: isDark ? '#34495e' : '#e0e0e0',
          borderWidth: 1,
          padding: 12,
          titleFont: { size: 13, weight: '700' },
          bodyFont: { size: 12, weight: '600' },
          displayColors: true,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ‚Ç¨' + context.parsed.y.toFixed(0);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) { 
              if (value >= 1000) return '‚Ç¨' + (value/1000).toFixed(1) + 'k';
              return '‚Ç¨' + value; 
            },
            color: isDark ? '#999' : '#666',
            font: { size: 9, weight: '600' },
            padding: 8,
            maxTicksLimit: 6,
            autoSkip: true
          },
          grid: {
            color: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)',
            drawBorder: false
          }
        },
        x: {
          ticks: {
            color: isDark ? '#eee' : '#2c3e50',
            font: { size: 11, weight: '700' },
            padding: 8
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
}

// ========== COMPARAZIONI PERIODI ==========
function confrontaMesi() {
  var oggi = new Date();
  var meseCorrente = oggi.getMonth();
  var annoCorrente = oggi.getFullYear();
  
  var meseScorso = meseCorrente === 0 ? 11 : meseCorrente - 1;
  var annoScorso = meseCorrente === 0 ? annoCorrente - 1 : annoCorrente;
  
  var speseCorrente = calcolaSpeseMese(annoCorrente, meseCorrente);
  var entrateCorrente = calcolaEntrateMese(annoCorrente, meseCorrente);
  var saldoCorrente = entrateCorrente - speseCorrente;
  
  var speseScorso = calcolaSpeseMese(annoScorso, meseScorso);
  var entrateScorso = calcolaEntrateMese(annoScorso, meseScorso);
  var saldoScorso = entrateScorso - speseScorso;
  
  var diffSpese = speseCorrente - speseScorso;
  var percDiffSpese = speseScorso > 0 ? ((diffSpese / speseScorso) * 100).toFixed(1) : 0;
  
  var diffEntrate = entrateCorrente - entrateScorso;
  var percDiffEntrate = entrateScorso > 0 ? ((diffEntrate / entrateScorso) * 100).toFixed(1) : 0;
  
  var diffSaldo = saldoCorrente - saldoScorso;
  var percDiffSaldo = Math.abs(saldoScorso) > 0 ? ((diffSaldo / Math.abs(saldoScorso)) * 100).toFixed(1) : 0;
  
  var nomiMesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
  
  var html = '<div style="background:var(--card);padding:20px;border-radius:16px;margin-top:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08)">';
  
  // Header confronto
  html += '<div style="text-align:center;margin-bottom:20px">';
  html += '<h4 style="font-size:1.2em;margin-bottom:8px">üìÖ Confronto Mensile</h4>';
  html += '<div style="font-size:0.9em;opacity:0.7">' + nomiMesi[meseScorso] + ' ' + annoScorso + ' vs ' + nomiMesi[meseCorrente] + ' ' + annoCorrente + '</div>';
  html += '</div>';
  
  // Grid comparazioni
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px">';
  
  // Uscite
  html += '<div style="text-align:center;padding:15px;background:var(--bg);border-radius:12px">';
  html += '<div style="font-size:0.8em;opacity:0.7;margin-bottom:8px">üí∏ Uscite</div>';
  html += '<div style="font-size:1.1em;font-weight:600;color:var(--expense);margin-bottom:4px">‚Ç¨' + speseScorso.toFixed(0) + '</div>';
  html += '<div style="font-size:0.75em;opacity:0.6">Scorso</div>';
  html += '</div>';
  
  html += '<div style="text-align:center;padding:15px;background:var(--bg);border-radius:12px">';
  html += '<div style="font-size:0.8em;opacity:0.7;margin-bottom:8px">üí∞ Entrate</div>';
  html += '<div style="font-size:1.1em;font-weight:600;color:var(--income);margin-bottom:4px">‚Ç¨' + entrateScorso.toFixed(0) + '</div>';
  html += '<div style="font-size:0.75em;opacity:0.6">Scorso</div>';
  html += '</div>';
  
  html += '<div style="text-align:center;padding:15px;background:var(--bg);border-radius:12px">';
  html += '<div style="font-size:0.8em;opacity:0.7;margin-bottom:8px">üìä Saldo</div>';
  html += '<div style="font-size:1.1em;font-weight:600;color:' + (saldoScorso >= 0 ? 'var(--income)' : 'var(--expense)') + ';margin-bottom:4px">‚Ç¨' + saldoScorso.toFixed(0) + '</div>';
  html += '<div style="font-size:0.75em;opacity:0.6">Scorso</div>';
  html += '</div>';
  
  html += '</div>';
  
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px">';
  
  html += '<div style="text-align:center;padding:15px;background:var(--bg);border-radius:12px">';
  html += '<div style="font-size:0.8em;opacity:0.7;margin-bottom:8px">üí∏ Uscite</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:var(--expense);margin-bottom:4px">‚Ç¨' + speseCorrente.toFixed(0) + '</div>';
  html += '<div style="font-size:0.75em;opacity:0.6">Corrente</div>';
  html += '</div>';
  
  html += '<div style="text-align:center;padding:15px;background:var(--bg);border-radius:12px">';
  html += '<div style="font-size:0.8em;opacity:0.7;margin-bottom:8px">üí∞ Entrate</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:var(--income);margin-bottom:4px">‚Ç¨' + entrateCorrente.toFixed(0) + '</div>';
  html += '<div style="font-size:0.75em;opacity:0.6">Corrente</div>';
  html += '</div>';
  
  html += '<div style="text-align:center;padding:15px;background:var(--bg);border-radius:12px">';
  html += '<div style="font-size:0.8em;opacity:0.7;margin-bottom:8px">üìä Saldo</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:' + (saldoCorrente >= 0 ? 'var(--income)' : 'var(--expense)') + ';margin-bottom:4px">‚Ç¨' + saldoCorrente.toFixed(0) + '</div>';
  html += '<div style="font-size:0.75em;opacity:0.6">Corrente</div>';
  html += '</div>';
  
  html += '</div>';
  
  // Variazioni
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  
  html += '<div style="padding:12px;background:' + (diffSpese > 0 ? '#ffe5e5' : '#e5f7e5') + ';border-radius:10px;text-align:center">';
  html += '<div style="font-size:0.75em;opacity:0.8;margin-bottom:4px">Œî Uscite</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:' + (diffSpese > 0 ? '#e74c3c' : '#27ae60') + '">';
  html += (diffSpese > 0 ? '+' : '') + '‚Ç¨' + diffSpese.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.7;margin-top:2px">' + (diffSpese > 0 ? '+' : '') + percDiffSpese + '%</div>';
  html += '</div>';
  
  html += '<div style="padding:12px;background:' + (diffEntrate >= 0 ? '#e5f7e5' : '#ffe5e5') + ';border-radius:10px;text-align:center">';
  html += '<div style="font-size:0.75em;opacity:0.8;margin-bottom:4px">Œî Entrate</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:' + (diffEntrate >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += (diffEntrate > 0 ? '+' : '') + '‚Ç¨' + diffEntrate.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.7;margin-top:2px">' + (diffEntrate > 0 ? '+' : '') + percDiffEntrate + '%</div>';
  html += '</div>';
  
  html += '<div style="padding:12px;background:' + (diffSaldo >= 0 ? '#e5f7e5' : '#ffe5e5') + ';border-radius:10px;text-align:center">';
  html += '<div style="font-size:0.75em;opacity:0.8;margin-bottom:4px">Œî Saldo</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:' + (diffSaldo >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += (diffSaldo > 0 ? '+' : '') + '‚Ç¨' + diffSaldo.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.7;margin-top:2px">' + (diffSaldo > 0 ? '+' : '') + percDiffSaldo + '%</div>';
  html += '</div>';
  
  html += '</div>';
  html += '</div>';
  
  document.getElementById('confrontoResult').innerHTML = html;
  
  // Scroll smooth
  document.getElementById('confrontoResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function confrontaAnni() {
  var annoCorrente = new Date().getFullYear();
  var annoScorso = annoCorrente - 1;
  
  var speseCorrente = calcolaSpeseAnno(annoCorrente);
  var entrateCorrente = calcolaEntrateAnno(annoCorrente);
  var saldoCorrente = entrateCorrente - speseCorrente;
  
  var speseScorso = calcolaSpeseAnno(annoScorso);
  var entrateScorso = calcolaEntrateAnno(annoScorso);
  var saldoScorso = entrateScorso - speseScorso;
  
  var diffSpese = speseCorrente - speseScorso;
  var percDiffSpese = speseScorso > 0 ? ((diffSpese / speseScorso) * 100).toFixed(1) : 0;
  
  var diffEntrate = entrateCorrente - entrateScorso;
  var percDiffEntrate = entrateScorso > 0 ? ((diffEntrate / entrateScorso) * 100).toFixed(1) : 0;
  
  var diffSaldo = saldoCorrente - saldoScorso;
  var percDiffSaldo = Math.abs(saldoScorso) > 0 ? ((diffSaldo / Math.abs(saldoScorso)) * 100).toFixed(1) : 0;
  
  var html = '<div style="background:var(--card);padding:20px;border-radius:16px;margin-top:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08)">';
  
  html += '<div style="text-align:center;margin-bottom:20px">';
  html += '<h4 style="font-size:1.2em;margin-bottom:8px">üìÜ Confronto Annuale</h4>';
  html += '<div style="font-size:0.9em;opacity:0.7">Anno ' + annoScorso + ' vs Anno ' + annoCorrente + '</div>';
  html += '</div>';
  
  html += '<div style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px">';
  
  // Anno scorso
  html += '<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#ecf0f1,#bdc3c7);border-radius:12px">';
  html += '<div style="font-size:1em;font-weight:700;margin-bottom:12px;opacity:0.8">' + annoScorso + '</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.7">Uscite</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:#e74c3c">‚Ç¨' + speseScorso.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.7">Entrate</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:#27ae60">‚Ç¨' + entrateScorso.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div>';
  html += '<div style="font-size:0.7em;opacity:0.7">Saldo</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:' + (saldoScorso >= 0 ? '#27ae60' : '#e74c3c') + '">‚Ç¨' + saldoScorso.toFixed(0) + '</div>';
  html += '</div>';
  html += '</div>';
  
  // Anno corrente
  html += '<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(102,126,234,0.4)">';
  html += '<div style="font-size:1em;font-weight:700;margin-bottom:12px">' + annoCorrente + ' ‚≠ê</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.9">Uscite</div>';
  html += '<div style="font-size:1.3em;font-weight:800">‚Ç¨' + speseCorrente.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.9">Entrate</div>';
  html += '<div style="font-size:1.3em;font-weight:800">‚Ç¨' + entrateCorrente.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div>';
  html += '<div style="font-size:0.7em;opacity:0.9">Saldo</div>';
  html += '<div style="font-size:1.3em;font-weight:800">‚Ç¨' + saldoCorrente.toFixed(0) + '</div>';
  html += '</div>';
  html += '</div>';
  
  html += '</div>';
  
  // Variazioni annuali - una sopra l'altra
  html += '<div style="display:grid;grid-template-columns:1fr;gap:10px">';
  
  html += '<div style="padding:12px;background:' + (diffSpese > 0 ? '#ffe5e5' : '#e5f7e5') + ';border-radius:12px;text-align:center">';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:4px">üìâ Œî Uscite</div>';
  html += '<div style="font-size:1.3em;font-weight:800;color:' + (diffSpese > 0 ? '#e74c3c' : '#27ae60') + '">';
  html += (diffSpese > 0 ? '+' : '') + '‚Ç¨' + diffSpese.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.7;margin-top:3px;font-weight:600">' + (diffSpese > 0 ? '+' : '') + percDiffSpese + '%</div>';
  html += '</div>';
  
  html += '<div style="padding:12px;background:' + (diffEntrate >= 0 ? '#e5f7e5' : '#ffe5e5') + ';border-radius:12px;text-align:center">';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:4px">üìà Œî Entrate</div>';
  html += '<div style="font-size:1.3em;font-weight:800;color:' + (diffEntrate >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += (diffEntrate > 0 ? '+' : '') + '‚Ç¨' + diffEntrate.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.7;margin-top:3px;font-weight:600">' + (diffEntrate > 0 ? '+' : '') + percDiffEntrate + '%</div>';
  html += '</div>';
  
  html += '<div style="padding:12px;background:' + (diffSaldo >= 0 ? '#e5f7e5' : '#ffe5e5') + ';border-radius:12px;text-align:center">';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:4px">üí∞ Œî Saldo</div>';
  html += '<div style="font-size:1.3em;font-weight:800;color:' + (diffSaldo >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += (diffSaldo > 0 ? '+' : '') + '‚Ç¨' + diffSaldo.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.7;margin-top:3px;font-weight:600">' + (diffSaldo > 0 ? '+' : '') + percDiffSaldo + '%</div>';
  html += '</div>';
  
  html += '</div>';
  html += '</div>';
  
  document.getElementById('confrontoResult').innerHTML = html;
  document.getElementById('confrontoResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Helper functions
function calcolaSpeseMese(anno, mese) {
  return DB.transazioni
    .filter(function(t) {
      var d = new Date(t.data);
      return d.getFullYear() === anno && d.getMonth() === mese && t.tipo === 'expense' && !t.virtualRecovery;
    })
    .reduce(function(sum, t) { return sum + parseFloat(t.importo); }, 0);
}

function calcolaEntrateMese(anno, mese) {
  return DB.transazioni
    .filter(function(t) {
      var d = new Date(t.data);
      return d.getFullYear() === anno && d.getMonth() === mese && t.tipo === 'income';
    })
    .reduce(function(sum, t) { return sum + parseFloat(t.importo); }, 0);
}

function calcolaSpeseAnno(anno) {
  return DB.transazioni
    .filter(function(t) {
      return new Date(t.data).getFullYear() === anno && t.tipo === 'expense' && !t.virtualRecovery;
    })
    .reduce(function(sum, t) { return sum + parseFloat(t.importo); }, 0);
}

function calcolaEntrateAnno(anno) {
  return DB.transazioni
    .filter(function(t) {
      return new Date(t.data).getFullYear() === anno && t.tipo === 'income';
    })
    .reduce(function(sum, t) { return sum + parseFloat(t.importo); }, 0);
}

// ========== NUOVE FUNZIONI CONFRONTO PERSONALIZZATO ==========

// Inizializza i selettori di anno per il confronto
function inizializzaSelettoriConfronto() {
  var anniDisponibili = [];
  DB.transazioni.forEach(function(t) {
    var anno = new Date(t.data).getFullYear();
    if (anniDisponibili.indexOf(anno) === -1) {
      anniDisponibili.push(anno);
    }
  });
  anniDisponibili.sort(function(a, b) { return b - a; }); // Dal pi√π recente
  
  // Popola selettori mesi
  var selettori = ['confrontoAnno1', 'confrontoAnno2', 'confrontoAnnoA', 'confrontoAnnoB'];
  selettori.forEach(function(id) {
    var select = document.getElementById(id);
    if (select) {
      select.innerHTML = '';
      anniDisponibili.forEach(function(anno) {
        var option = document.createElement('option');
        option.value = anno;
        option.textContent = anno;
        select.appendChild(option);
      });
      // Imposta valori di default
      if (id === 'confrontoAnno1' || id === 'confrontoAnnoA') {
        select.value = anniDisponibili[0]; // Anno corrente
      } else if (anniDisponibili.length > 1) {
        select.value = anniDisponibili[1]; // Anno scorso
      }
    }
  });
  
  // Imposta mesi di default
  var oggi = new Date();
  var meseCorrente = oggi.getMonth();
  var meseScorso = meseCorrente === 0 ? 11 : meseCorrente - 1;
  
  if (document.getElementById('confrontoMese1')) {
    document.getElementById('confrontoMese1').value = meseScorso;
  }
  if (document.getElementById('confrontoMese2')) {
    document.getElementById('confrontoMese2').value = meseCorrente;
  }
}

// Mostra/Nascondi tab confronto
function mostraTabConfronto(tipo) {
  var tabMesi = document.getElementById('tabMesi');
  var tabAnni = document.getElementById('tabAnni');
  var uiMesi = document.getElementById('confrontoMesiUI');
  var uiAnni = document.getElementById('confrontoAnniUI');
  var result = document.getElementById('confrontoResult');
  
  // Safety check
  if (!tabMesi || !tabAnni || !uiMesi || !uiAnni || !result) {
    console.error('Elementi confronto non trovati');
    return;
  }
  
  if (tipo === 'mesi') {
    tabMesi.style.opacity = '1';
    tabAnni.style.opacity = '0.6';
    uiMesi.style.display = 'block';
    uiAnni.style.display = 'none';
  } else {
    tabMesi.style.opacity = '0.6';
    tabAnni.style.opacity = '1';
    uiMesi.style.display = 'none';
    uiAnni.style.display = 'block';
  }
  
  result.innerHTML = ''; // Pulisci risultato
  playSound('click');
}

// Confronto mesi personalizzato
function confrontaMesiPersonalizzato() {
  var elem1 = document.getElementById('confrontoMese1');
  var elem2 = document.getElementById('confrontoAnno1');
  var elem3 = document.getElementById('confrontoMese2');
  var elem4 = document.getElementById('confrontoAnno2');
  var result = document.getElementById('confrontoResult');
  
  if (!elem1 || !elem2 || !elem3 || !elem4 || !result) {
    mostraToast('‚ö†Ô∏è Errore: elementi del confronto non trovati', 'error');
    return;
  }
  
  var mese1 = parseInt(elem1.value);
  var anno1 = parseInt(elem2.value);
  var mese2 = parseInt(elem3.value);
  var anno2 = parseInt(elem4.value);
  
  var spese1 = calcolaSpeseMese(anno1, mese1);
  var entrate1 = calcolaEntrateMese(anno1, mese1);
  var saldo1 = entrate1 - spese1;
  
  var spese2 = calcolaSpeseMese(anno2, mese2);
  var entrate2 = calcolaEntrateMese(anno2, mese2);
  var saldo2 = entrate2 - spese2;
  
  var diffSpese = spese2 - spese1;
  var percDiffSpese = spese1 > 0 ? ((diffSpese / spese1) * 100).toFixed(1) : 0;
  
  var diffEntrate = entrate2 - entrate1;
  var percDiffEntrate = entrate1 > 0 ? ((diffEntrate / entrate1) * 100).toFixed(1) : 0;
  
  var diffSaldo = saldo2 - saldo1;
  var percDiffSaldo = Math.abs(saldo1) > 0 ? ((diffSaldo / Math.abs(saldo1)) * 100).toFixed(1) : 0;
  
  var nomiMesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  
  var html = '<div style="margin-top:20px">';
  
  // Header con titolo e vs
  html += '<div style="text-align:center;margin-bottom:20px">';
  html += '<div style="font-size:1.3em;font-weight:800;color:var(--text);margin-bottom:8px">üìä Confronto Periodi</div>';
  html += '<div style="display:flex;align-items:center;justify-content:center;gap:12px;font-size:1.1em;font-weight:700">';
  html += '<span style="color:#667eea">' + nomiMesi[mese1] + ' ' + anno1 + '</span>';
  html += '<span style="color:var(--text);opacity:0.5">‚ö°</span>';
  html += '<span style="color:#27ae60">' + nomiMesi[mese2] + ' ' + anno2 + '</span>';
  html += '</div>';
  html += '</div>';
  
  // Card comparativa stile dashboard
  html += '<div style="background:var(--card);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:15px">';
  
  // Grid 2 colonne
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">';
  
  // Colonna 1 - Primo mese
  html += '<div style="text-align:center">';
  html += '<div style="font-size:0.9em;font-weight:700;color:#667eea;margin-bottom:15px;opacity:0.8">üìÖ ' + nomiMesi[mese1].substring(0,3) + ' ' + anno1 + '</div>';
  
  // Uscite
  html += '<div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg,rgba(231,76,60,0.1),rgba(231,76,60,0.05));border-radius:10px;border-left:3px solid #e74c3c">';
  html += '<div style="font-size:0.75em;color:#e74c3c;opacity:0.8;margin-bottom:4px">üí∏ Uscite</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:#e74c3c">‚Ç¨' + spese1.toFixed(0) + '</div>';
  html += '</div>';
  
  // Entrate
  html += '<div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg,rgba(39,174,96,0.1),rgba(39,174,96,0.05));border-radius:10px;border-left:3px solid #27ae60">';
  html += '<div style="font-size:0.75em;color:#27ae60;opacity:0.8;margin-bottom:4px">üí∞ Entrate</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:#27ae60">‚Ç¨' + entrate1.toFixed(0) + '</div>';
  html += '</div>';
  
  // Saldo
  html += '<div style="padding:12px;background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(102,126,234,0.05));border-radius:10px;border-left:3px solid #667eea">';
  html += '<div style="font-size:0.75em;color:#667eea;opacity:0.8;margin-bottom:4px">üìä Saldo</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:' + (saldo1 >= 0 ? '#27ae60' : '#e74c3c') + '">‚Ç¨' + saldo1.toFixed(0) + '</div>';
  html += '</div>';
  
  html += '</div>';
  
  // Colonna 2 - Secondo mese
  html += '<div style="text-align:center">';
  html += '<div style="font-size:0.9em;font-weight:700;color:#27ae60;margin-bottom:15px;opacity:0.8">üìÖ ' + nomiMesi[mese2].substring(0,3) + ' ' + anno2 + '</div>';
  
  // Uscite
  html += '<div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg,rgba(231,76,60,0.1),rgba(231,76,60,0.05));border-radius:10px;border-left:3px solid #e74c3c">';
  html += '<div style="font-size:0.75em;color:#e74c3c;opacity:0.8;margin-bottom:4px">üí∏ Uscite</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:#e74c3c">‚Ç¨' + spese2.toFixed(0) + '</div>';
  html += '</div>';
  
  // Entrate
  html += '<div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg,rgba(39,174,96,0.1),rgba(39,174,96,0.05));border-radius:10px;border-left:3px solid #27ae60">';
  html += '<div style="font-size:0.75em;color:#27ae60;opacity:0.8;margin-bottom:4px">üí∞ Entrate</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:#27ae60">‚Ç¨' + entrate2.toFixed(0) + '</div>';
  html += '</div>';
  
  // Saldo
  html += '<div style="padding:12px;background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(102,126,234,0.05));border-radius:10px;border-left:3px solid #667eea">';
  html += '<div style="font-size:0.75em;color:#667eea;opacity:0.8;margin-bottom:4px">üìä Saldo</div>';
  html += '<div style="font-size:1.4em;font-weight:800;color:' + (saldo2 >= 0 ? '#27ae60' : '#e74c3c') + '">‚Ç¨' + saldo2.toFixed(0) + '</div>';
  html += '</div>';
  
  html += '</div>';
  html += '</div>';
  
  // Divider
  html += '<div style="height:2px;background:linear-gradient(to right,transparent,var(--border),transparent);margin:20px 0"></div>';
  
  // Variazioni - stile card compatte
  html += '<div style="text-align:center;margin-bottom:15px">';
  html += '<div style="font-size:1.1em;font-weight:700;color:var(--text);margin-bottom:12px">üìà Variazioni</div>';
  html += '</div>';
  
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
  
  // Variazione Uscite - INTELLIGENTE: Meno spese = MEGLIO (verde), Pi√π spese = PEGGIO (rosso)
  var speseIcon = diffSpese < 0 ? '‚ÜòÔ∏è' : '‚ÜóÔ∏è';
  var speseBetter = diffSpese < 0; // Meno spese √® meglio
  var speseColor = speseBetter ? '#27ae60' : '#e74c3c';
  var speseBg = speseBetter ? 'rgba(39,174,96,0.1)' : 'rgba(231,76,60,0.1)';
  var speseBadge = speseBetter ? '‚úÖ Meglio' : '‚ö†Ô∏è Peggio';
  var speseBadgeColor = speseBetter ? '#27ae60' : '#e74c3c';
  
  html += '<div style="padding:14px;background:' + speseBg + ';border-radius:12px;text-align:center;border:2px solid ' + speseColor + '">';
  html += '<div style="font-size:0.75em;font-weight:700;color:' + speseColor + ';margin-bottom:6px">üí∏ Uscite</div>';
  html += '<div style="font-size:1.5em;font-weight:800;color:' + speseColor + ';margin-bottom:4px">';
  html += speseIcon + ' ' + (diffSpese > 0 ? '+' : '') + '‚Ç¨' + Math.abs(diffSpese).toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:6px">' + (diffSpese > 0 ? '+' : '') + percDiffSpese + '%</div>';
  html += '<div style="font-size:0.65em;font-weight:700;padding:4px 8px;border-radius:6px;background:' + (speseBetter ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)') + ';color:' + speseBadgeColor + ';display:inline-block">' + speseBadge + '</div>';
  html += '</div>';
  
  // Variazione Entrate - INTELLIGENTE: Pi√π entrate = MEGLIO (verde), Meno entrate = PEGGIO (rosso)
  var entrateIcon = diffEntrate > 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
  var entrateBetter = diffEntrate > 0; // Pi√π entrate √® meglio
  var entrateColor = entrateBetter ? '#27ae60' : '#e74c3c';
  var entrateBg = entrateBetter ? 'rgba(39,174,96,0.1)' : 'rgba(231,76,60,0.1)';
  var entrateBadge = entrateBetter ? '‚úÖ Meglio' : '‚ö†Ô∏è Peggio';
  var entrateBadgeColor = entrateBetter ? '#27ae60' : '#e74c3c';
  
  html += '<div style="padding:14px;background:' + entrateBg + ';border-radius:12px;text-align:center;border:2px solid ' + entrateColor + '">';
  html += '<div style="font-size:0.75em;font-weight:700;color:' + entrateColor + ';margin-bottom:6px">üí∞ Entrate</div>';
  html += '<div style="font-size:1.5em;font-weight:800;color:' + entrateColor + ';margin-bottom:4px">';
  html += entrateIcon + ' ' + (diffEntrate > 0 ? '+' : '') + '‚Ç¨' + Math.abs(diffEntrate).toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:6px">' + (diffEntrate > 0 ? '+' : '') + percDiffEntrate + '%</div>';
  html += '<div style="font-size:0.65em;font-weight:700;padding:4px 8px;border-radius:6px;background:' + (entrateBetter ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)') + ';color:' + entrateBadgeColor + ';display:inline-block">' + entrateBadge + '</div>';
  html += '</div>';
  
  // Variazione Saldo - INTELLIGENTE: Pi√π saldo = MEGLIO (verde), Meno saldo = PEGGIO (rosso)
  var saldoIcon = diffSaldo > 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
  var saldoBetter = diffSaldo > 0; // Pi√π saldo √® meglio
  var saldoColor = saldoBetter ? '#27ae60' : '#e74c3c';
  var saldoBg = saldoBetter ? 'rgba(39,174,96,0.1)' : 'rgba(231,76,60,0.1)';
  var saldoBadge = saldoBetter ? '‚úÖ Meglio' : '‚ö†Ô∏è Peggio';
  var saldoBadgeColor = saldoBetter ? '#27ae60' : '#e74c3c';
  
  html += '<div style="padding:14px;background:' + saldoBg + ';border-radius:12px;text-align:center;border:2px solid ' + saldoColor + '">';
  html += '<div style="font-size:0.75em;font-weight:700;color:' + saldoColor + ';margin-bottom:6px">üìä Saldo</div>';
  html += '<div style="font-size:1.5em;font-weight:800;color:' + saldoColor + ';margin-bottom:4px">';
  html += saldoIcon + ' ' + (diffSaldo > 0 ? '+' : '') + '‚Ç¨' + Math.abs(diffSaldo).toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:6px">' + (diffSaldo > 0 ? '+' : '') + percDiffSaldo + '%</div>';
  html += '<div style="font-size:0.65em;font-weight:700;padding:4px 8px;border-radius:6px;background:' + (saldoBetter ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)') + ';color:' + saldoBadgeColor + ';display:inline-block">' + saldoBadge + '</div>';
  html += '</div>';
  
  html += '</div>';
  html += '</div>'; // Chiude card principale
  
  // Insight
  html += '<div style="margin-top:20px;padding:15px;background:linear-gradient(135deg,#fff9e6,#fff3cc);border-left:4px solid #f39c12;border-radius:8px;color:#333">';
  html += '<div style="font-weight:700;margin-bottom:8px;color:#333">üí° Insight</div>';
  if (diffSpese > 0) {
    html += '<div style="font-size:0.9em;color:#333">Le uscite sono aumentate di ‚Ç¨' + Math.abs(diffSpese).toFixed(0) + ' rispetto al mese precedente. ';
    if (diffEntrate > diffSpese) {
      html += 'Fortunatamente, le entrate sono cresciute di pi√π! üëç</div>';
    } else {
      html += 'Cerca di ottimizzare le spese per il prossimo mese. üí™</div>';
    }
  } else {
    html += '<div style="font-size:0.9em;color:#333">Ottimo! Le uscite sono diminuite di ‚Ç¨' + Math.abs(diffSpese).toFixed(0) + '. Continua cos√¨! üéâ</div>';
  }
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('confrontoResult').innerHTML = html;
  document.getElementById('confrontoResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  playSound('success');
  mostraToast('‚úÖ Confronto completato!', 'success');
}

// Confronto anni personalizzato
function confrontaAnniPersonalizzato() {
  var elemA = document.getElementById('confrontoAnnoA');
  var elemB = document.getElementById('confrontoAnnoB');
  var result = document.getElementById('confrontoResult');
  
  if (!elemA || !elemB || !result) {
    mostraToast('‚ö†Ô∏è Errore: elementi del confronto non trovati', 'error');
    return;
  }
  
  var anno1 = parseInt(elemA.value);
  var anno2 = parseInt(elemB.value);
  
  var spese1 = calcolaSpeseAnno(anno1);
  var entrate1 = calcolaEntrateAnno(anno1);
  var saldo1 = entrate1 - spese1;
  
  var spese2 = calcolaSpeseAnno(anno2);
  var entrate2 = calcolaEntrateAnno(anno2);
  var saldo2 = entrate2 - spese2;
  
  var diffSpese = spese2 - spese1;
  var percDiffSpese = spese1 > 0 ? ((diffSpese / spese1) * 100).toFixed(1) : 0;
  
  var diffEntrate = entrate2 - entrate1;
  var percDiffEntrate = entrate1 > 0 ? ((diffEntrate / entrate1) * 100).toFixed(1) : 0;
  
  var diffSaldo = saldo2 - saldo1;
  var percDiffSaldo = Math.abs(saldo1) > 0 ? ((diffSaldo / Math.abs(saldo1)) * 100).toFixed(1) : 0;
  
  var html = '<div style="background:var(--card);padding:20px;border-radius:16px;margin-top:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08);animation:slideIn 0.3s ease-out">';
  
  // Header
  html += '<div style="text-align:center;margin-bottom:20px">';
  html += '<h4 style="font-size:1.2em;margin-bottom:8px">üìÜ Confronto Annuale Personalizzato</h4>';
  html += '<div style="font-size:0.9em;opacity:0.7">';
  html += '<span style="color:#9b59b6;font-weight:600">üîµ Anno ' + anno1 + '</span>';
  html += ' vs ';
  html += '<span style="color:#667eea;font-weight:600">üü¢ Anno ' + anno2 + '</span>';
  html += '</div>';
  html += '</div>';
  
  // Grid - una card sopra l'altra
  html += '<div style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px">';
  
  // Primo anno
  html += '<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#f3e5f5,#e1bee7);border-radius:12px;border:2px solid #9b59b6">';
  html += '<div style="font-size:1em;font-weight:700;margin-bottom:12px;color:#9b59b6">üîµ ' + anno1 + '</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.7">Uscite</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:#e74c3c">‚Ç¨' + spese1.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.7">Entrate</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:#27ae60">‚Ç¨' + entrate1.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div>';
  html += '<div style="font-size:0.7em;opacity:0.7">Saldo</div>';
  html += '<div style="font-size:1.2em;font-weight:700;color:' + (saldo1 >= 0 ? '#27ae60' : '#e74c3c') + '">‚Ç¨' + saldo1.toFixed(0) + '</div>';
  html += '</div>';
  html += '</div>';
  
  // Secondo anno
  html += '<div style="text-align:center;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(102,126,234,0.4)">';
  html += '<div style="font-size:1em;font-weight:700;margin-bottom:12px">üü¢ ' + anno2 + ' ‚≠ê</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.9">Uscite</div>';
  html += '<div style="font-size:1.3em;font-weight:800">‚Ç¨' + spese2.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div style="margin-bottom:8px">';
  html += '<div style="font-size:0.7em;opacity:0.9">Entrate</div>';
  html += '<div style="font-size:1.3em;font-weight:800">‚Ç¨' + entrate2.toFixed(0) + '</div>';
  html += '</div>';
  html += '<div>';
  html += '<div style="font-size:0.7em;opacity:0.9">Saldo</div>';
  html += '<div style="font-size:1.3em;font-weight:800">‚Ç¨' + saldo2.toFixed(0) + '</div>';
  html += '</div>';
  html += '</div>';
  
  html += '</div>';
  
  // Variazioni - una sopra l'altra
  html += '<div style="display:grid;grid-template-columns:1fr;gap:10px">';
  
  html += '<div style="padding:12px;background:' + (diffSpese > 0 ? '#ffebee' : '#e8f5e9') + ';border-radius:10px;text-align:center;border:2px solid ' + (diffSpese > 0 ? '#e74c3c' : '#27ae60') + '">';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:3px">Œî Uscite Annuali</div>';
  html += '<div style="font-size:1.3em;font-weight:800;color:' + (diffSpese > 0 ? '#e74c3c' : '#27ae60') + '">';
  html += (diffSpese > 0 ? '+' : '') + '‚Ç¨' + diffSpese.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.65em;opacity:0.7;margin-top:2px">' + (diffSpese > 0 ? '+' : '') + percDiffSpese + '%</div>';
  html += '</div>';
  
  html += '<div style="padding:12px;background:' + (diffEntrate >= 0 ? '#e8f5e9' : '#ffebee') + ';border-radius:10px;text-align:center;border:2px solid ' + (diffEntrate >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:3px">Œî Entrate Annuali</div>';
  html += '<div style="font-size:1.3em;font-weight:800;color:' + (diffEntrate >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += (diffEntrate > 0 ? '+' : '') + '‚Ç¨' + diffEntrate.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.65em;opacity:0.7;margin-top:2px">' + (diffEntrate > 0 ? '+' : '') + percDiffEntrate + '%</div>';
  html += '</div>';
  
  html += '<div style="padding:12px;background:' + (diffSaldo >= 0 ? '#e8f5e9' : '#ffebee') + ';border-radius:10px;text-align:center;border:2px solid ' + (diffSaldo >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += '<div style="font-size:0.7em;opacity:0.8;margin-bottom:3px">Œî Saldo Annuale</div>';
  html += '<div style="font-size:1.3em;font-weight:800;color:' + (diffSaldo >= 0 ? '#27ae60' : '#e74c3c') + '">';
  html += (diffSaldo > 0 ? '+' : '') + '‚Ç¨' + diffSaldo.toFixed(0);
  html += '</div>';
  html += '<div style="font-size:0.65em;opacity:0.7;margin-top:2px">' + (diffSaldo > 0 ? '+' : '') + percDiffSaldo + '%</div>';
  html += '</div>';
  
  html += '</div>';
  html += '</div>';
  
  document.getElementById('confrontoResult').innerHTML = html;
  document.getElementById('confrontoResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  playSound('success');
  mostraToast('‚úÖ Confronto completato!', 'success');
}

// ========== CALENDARIO ==========
// ========== RICERCA AVANZATA ==========
function toggleAdvancedSearch() {
  var panel = document.getElementById('advancedSearchPanel');
  var btn = document.getElementById('advancedSearchBtn');
  var isOpen = panel.style.display !== 'none';
  
  if (isOpen) {
    panel.style.display = 'none';
    btn.innerHTML = 'üîç Avanzata';
  } else {
    panel.style.display = 'block';
    btn.innerHTML = '‚úï Chiudi';
  }
  
  playSound('click');
}

// ========== SISTEMA RISPARMIO 15/20/65 ==========
function aggiornaRisparmio() {
  // Calcola le entrate del mese corrente
  var entrateCorrente = 0;
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese && t.tipo === 'income') {
      entrateCorrente += parseFloat(t.importo) || 0;
    }
  });
  
  // Calcola le percentuali: 65% necessit√†, 20% desideri, 15% risparmi
  var budgetNecessita = entrateCorrente * 0.65;  // 65%
  var budgetDesideri = entrateCorrente * 0.20;   // 20%
  var budgetRisparmi = entrateCorrente * 0.15;   // 15%
  
  // Aggiorna i valori nell'interfaccia
  document.getElementById('savingsIncome').textContent = formatEuro(entrateCorrente);
  document.getElementById('savingsNeeds').textContent = formatEuro(budgetNecessita);
  document.getElementById('savingsWants').textContent = formatEuro(budgetDesideri);
  document.getElementById('savingsSavings').textContent = formatEuro(budgetRisparmi);
  
  // Calcola le spese effettive per tipo
  var speseNecessita = 0;
  var speseDesideri = 0;
  var totaleUscite = 0; // Per statistiche (con spese condivise divise)
  var totaleUsciteReali = 0; // Per cash flow reale
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      var imp = parseFloat(t.importo) || 0;
      
      if (t.tipo === 'expense' && !t.virtualRecovery) {
        // Cash flow reale: sempre importo intero
        totaleUsciteReali += imp;
        
        // Statistiche: se condiviso, conta solo la tua met√†
        var importoEffettivo = t.condiviso ? splitAmount(imp) : imp;
        totaleUscite += importoEffettivo;
        
        var tipo = DB.categorieClassificazione[t.categoria] || 'desideri';
        if (tipo === 'necessita') {
          speseNecessita += importoEffettivo;
        } else if (tipo === 'desideri') {
          speseDesideri += importoEffettivo;
        }
      } else if (t.tipo === 'partner_payment' && t.condiviso && !t.virtualRecovery) {
        // Lei paga condiviso - conta solo la tua met√†
        var importoDaContare = splitAmount(imp);
        totaleUscite += importoDaContare;
        
        var tipo = DB.categorieClassificazione[t.categoria] || 'desideri';
        if (tipo === 'necessita') {
          speseNecessita += importoDaContare;
        } else if (tipo === 'desideri') {
          speseDesideri += importoDaContare;
        }
      }
    }
  });
  
  // Calcola spese condivise e da recuperare
  var speseCondivise = 0;
  var leiHaPagatoCondiviso = 0;
  var leiHaPagatoNonCondiviso = 0; // Prestiti
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      if (t.tipo === 'expense' && t.condiviso) {
        speseCondivise += parseFloat(t.importo) || 0;
      } else if (t.tipo === 'partner_payment') {
        var imp = parseFloat(t.importo) || 0;
        if (t.condiviso) {
          leiHaPagatoCondiviso += imp;
        } else {
          leiHaPagatoNonCondiviso += imp; // Prestito - tutto
        }
      }
    }
  });
  
  // Da recuperare = (tue spese condivise / 2) - (sue spese condivise / 2) - (prestiti)
  var daRecuperare = splitAmount(speseCondivise) - splitAmount(leiHaPagatoCondiviso) - leiHaPagatoNonCondiviso;
  
  // Arrotonda il risultato finale a 2 decimali
  daRecuperare = Math.round(daRecuperare * 100) / 100;
  
  // Risparmio sul conto (cash flow reale)
  var risparmioSulConto = entrateCorrente - totaleUsciteReali;
  
  // Risparmio totale effettivo (considerando da recuperare)
  var risparmiatoTotale = risparmioSulConto + daRecuperare;
  
  var percentualeRisparmio = entrateCorrente > 0 ? (risparmiatoTotale / budgetRisparmi * 100) : 0;
  
  // Limita al 100%
  if (percentualeRisparmio > 100) percentualeRisparmio = 100;
  if (percentualeRisparmio < 0) percentualeRisparmio = 0;
  
  document.getElementById('savingsProgress').textContent = percentualeRisparmio.toFixed(0) + '%';
  document.getElementById('savingsProgressBar').style.width = percentualeRisparmio + '%';
  
  // Analisi mensile con dati dettagliati
  aggiornaAnalisiRisparmio(entrateCorrente, speseNecessita, speseDesideri, risparmioSulConto, daRecuperare, risparmiatoTotale, budgetNecessita, budgetDesideri, budgetRisparmi);
}

function aggiornaAnalisiRisparmio(entrate, speseNecessita, speseDesideri, risparmioSulConto, daRecuperare, risparmioTotale, budgetNecessita, budgetDesideri, budgetRisparmi) {
  var analisiDiv = document.getElementById('savingsAnalysis');
  
  var html = '';
  
  // Card riepilogativa con breakdown dettagliato
  html += '<div style="background:var(--bg);padding:18px;border-radius:12px;margin-bottom:15px">';
  html += '<div style="font-size:1.2em;font-weight:700;margin-bottom:15px;text-align:center">üí∞ Risparmio del Mese</div>';
  
  // Risparmio sul conto
  html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card);border-radius:10px;margin-bottom:10px;border-left:4px solid #3498db">';
  html += '<div>';
  html += '<div style="font-size:0.85em;color:#7f8c8d">üè¶ Sul Conto</div>';
  html += '<div style="font-size:0.75em;color:#95a5a6;margin-top:2px">Cash flow reale</div>';
  html += '</div>';
  html += '<div style="font-size:1.5em;font-weight:800;color:#3498db">' + formatEuro(risparmioSulConto) + '</div>';
  html += '</div>';
  
  // Da recuperare/rimborsare
  var daRecupLabel = '‚úÖ Pari';
  var daRecupColor = '#f39c12';
  var daRecupIcon = '‚úÖ';
  if (daRecuperare > 0.01) {
    daRecupLabel = 'üí∞ Da Recuperare';
    daRecupColor = '#27ae60';
  } else if (daRecuperare < -0.01) {
    daRecupLabel = 'üí∏ Da Rimborsare';
    daRecupColor = '#e74c3c';
  }
  
  html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card);border-radius:10px;margin-bottom:10px;border-left:4px solid ' + daRecupColor + '">';
  html += '<div>';
  html += '<div style="font-size:0.85em;color:#7f8c8d">' + daRecupLabel + '</div>';
  html += '<div style="font-size:0.75em;color:#95a5a6;margin-top:2px">Splitwise</div>';
  html += '</div>';
  html += '<div style="font-size:1.5em;font-weight:800;color:' + daRecupColor + '">' + (daRecuperare >= 0 ? '+' : '') + formatEuro(Math.abs(daRecuperare)) + '</div>';
  html += '</div>';
  
  // Separatore
  html += '<div style="border-top:2px dashed var(--border);margin:15px 0"></div>';
  
  // Risparmio totale effettivo
  html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;box-shadow:0 4px 12px rgba(102,126,234,0.3)">';
  html += '<div>';
  html += '<div style="font-size:0.95em;color:#fff;opacity:0.9">üíé Risparmio Totale</div>';
  html += '<div style="font-size:0.75em;color:#fff;opacity:0.8;margin-top:2px">Conto + Splitwise</div>';
  html += '</div>';
  html += '<div style="font-size:2em;font-weight:900;color:#fff">' + formatEuro(risparmioTotale) + '</div>';
  html += '</div>';
  
  html += '</div>';
  
  // Confronto con obiettivo (basato su risparmio totale)
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px">';
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:0.85em;color:#7f8c8d;margin-bottom:5px">Obiettivo (15%)</div>';
  html += '<div style="font-size:1.6em;font-weight:800;color:#3498db">' + formatEuro(budgetRisparmi) + '</div>';
  html += '</div>';
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:0.85em;color:#7f8c8d;margin-bottom:5px">Raggiunto</div>';
  html += '<div style="font-size:1.6em;font-weight:800;color:' + (risparmioTotale >= budgetRisparmi ? '#27ae60' : '#e67e22') + '">' + (budgetRisparmi > 0 ? ((risparmioTotale / budgetRisparmi) * 100).toFixed(0) : '0') + '%</div>';
  html += '</div>';
  html += '</div>';
  
  // Stato risparmio
  var differenza = risparmioTotale - budgetRisparmi;
  var icon = 'üìä';
  var messaggio = '';
  var colore = '#7f8c8d';
  
  if (differenza >= 0) {
    icon = '‚úÖ';
    messaggio = 'Ottimo! Hai superato l\'obiettivo di risparmio di ' + formatEuro(differenza);
    colore = '#27ae60';
  } else {
    icon = '‚ö†Ô∏è';
    messaggio = 'Ti mancano ' + formatEuro(Math.abs(differenza)) + ' per raggiungere l\'obiettivo del 15%';
    colore = '#e67e22';
  }
  
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px;margin-bottom:15px">';
  html += '<div style="font-size:1.2em;font-weight:700;margin-bottom:8px">' + icon + ' Stato Risparmio</div>';
  html += '<div style="color:' + colore + ';font-weight:600">' + messaggio + '</div>';
  html += '</div>';
  
  // Distribuzione dettagliata per tipo
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px;margin-bottom:15px">';
  html += '<div style="font-size:1.1em;font-weight:700;margin-bottom:15px">üìä Distribuzione Spese per Tipo</div>';
  
  // Necessit√†
  var percNecessita = budgetNecessita > 0 ? (speseNecessita / budgetNecessita * 100) : 0;
  var colorNecessita = percNecessita > 100 ? '#e74c3c' : (percNecessita > 90 ? '#f39c12' : '#27ae60');
  html += '<div style="margin-bottom:15px">';
  html += '<div style="display:flex;justify-content:space-between;margin-bottom:5px">';
  html += '<span style="font-size:0.9em">üéØ <strong>Necessit√†</strong></span>';
  html += '<span style="font-size:0.9em"><strong>' + formatEuro(speseNecessita) + '</strong> / ' + formatEuro(budgetNecessita) + '</span>';
  html += '</div>';
  html += '<div style="background:#ecf0f1;height:10px;border-radius:5px;overflow:hidden">';
  html += '<div style="background:' + colorNecessita + ';height:100%;width:' + Math.min(percNecessita, 100) + '%;transition:width 0.5s"></div>';
  html += '</div>';
  html += '<div style="font-size:0.8em;color:#7f8c8d;margin-top:3px;text-align:right">' + percNecessita.toFixed(1) + '% del budget</div>';
  html += '</div>';
  
  // Desideri
  var percDesideri = budgetDesideri > 0 ? (speseDesideri / budgetDesideri * 100) : 0;
  var colorDesideri = percDesideri > 100 ? '#e74c3c' : (percDesideri > 90 ? '#f39c12' : '#27ae60');
  html += '<div style="margin-bottom:15px">';
  html += '<div style="display:flex;justify-content:space-between;margin-bottom:5px">';
  html += '<span style="font-size:0.9em">üíé <strong>Desideri</strong></span>';
  html += '<span style="font-size:0.9em"><strong>' + formatEuro(speseDesideri) + '</strong> / ' + formatEuro(budgetDesideri) + '</span>';
  html += '</div>';
  html += '<div style="background:#ecf0f1;height:10px;border-radius:5px;overflow:hidden">';
  html += '<div style="background:' + colorDesideri + ';height:100%;width:' + Math.min(percDesideri, 100) + '%;transition:width 0.5s"></div>';
  html += '</div>';
  html += '<div style="font-size:0.8em;color:#7f8c8d;margin-top:3px;text-align:right">' + percDesideri.toFixed(1) + '% del budget</div>';
  html += '</div>';
  
  html += '</div>';
  
  // Totale uscite
  var totaleUscite = speseNecessita + speseDesideri;
  var percentualeUscite = entrate > 0 ? (totaleUscite / entrate * 100) : 0;
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px">';
  html += '<div style="font-size:1.1em;font-weight:700;margin-bottom:10px">üí∞ Totale Uscite</div>';
  html += '<div style="margin-bottom:10px">';
  html += '<div style="display:flex;justify-content:space-between;margin-bottom:5px">';
  html += '<span style="font-size:0.9em">Speso: <strong>' + formatEuro(totaleUscite) + '</strong></span>';
  html += '<span style="font-size:0.9em"><strong>' + percentualeUscite.toFixed(1) + '%</strong> delle entrate</span>';
  html += '</div>';
  html += '<div style="background:#ecf0f1;height:10px;border-radius:5px;overflow:hidden">';
  html += '<div style="background:var(--expense);height:100%;width:' + Math.min(percentualeUscite, 100) + '%;transition:width 0.5s"></div>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  
  analisiDiv.innerHTML = html;
}

function mostraDettagliRisparmio() {
  playSound('click');
  
  var modal = document.getElementById('modal');
  modal.classList.add('active');
  
  var content = modal.querySelector('.modal-content');
  
  var entrate = 0, uscite = 0;
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'income') entrate += imp;
      else if (t.tipo === 'expense') uscite += imp;
    }
  });
  
  var necessita = entrate * 0.65;  // 65%
  var desideri = entrate * 0.20;   // 20%
  var risparmi = entrate * 0.15;   // 15%
  var saldo = entrate - uscite;
  
  var html = '<div class="modal-header"><h3>üìä Dettagli Risparmio</h3><button class="close-btn" onclick="chiudiModal()">√ó</button></div>';
  
  html += '<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:12px;margin-bottom:15px;text-align:center">';
  html += '<div style="font-size:0.9em;opacity:0.9">Entrate Mensili</div>';
  html += '<div style="font-size:2.5em;font-weight:800;margin:10px 0">' + formatEuro(entrate) + '</div>';
  html += '</div>';
  
  html += '<div style="margin-bottom:15px">';
  html += '<h4 style="margin-bottom:10px">üéØ Necessit√† (65%)</h4>';
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px">';
  html += '<div style="font-size:1.8em;font-weight:800;color:#e67e22">' + formatEuro(necessita) + '</div>';
  html += '<p style="font-size:0.85em;color:#7f8c8d;margin-top:5px">Da destinare a spese essenziali</p>';
  html += '</div></div>';
  
  html += '<div style="margin-bottom:15px">';
  html += '<h4 style="margin-bottom:10px">üíé Desideri (20%)</h4>';
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px">';
  html += '<div style="font-size:1.8em;font-weight:800;color:#9b59b6">' + formatEuro(desideri) + '</div>';
  html += '<p style="font-size:0.85em;color:#7f8c8d;margin-top:5px">Budget per divertimento</p>';
  html += '</div></div>';
  
  html += '<div style="margin-bottom:20px">';
  html += '<h4 style="margin-bottom:10px">üè¶ Risparmi (15%)</h4>';
  html += '<div style="background:var(--bg);padding:15px;border-radius:10px">';
  html += '<div style="font-size:1.8em;font-weight:800;color:#27ae60">' + formatEuro(risparmi) + '</div>';
  html += '<p style="font-size:0.85em;color:#7f8c8d;margin-top:5px">Obiettivo di risparmio</p>';
  html += '</div></div>';
  
  html += '<div style="background:' + (saldo >= risparmi ? '#d5f4e6' : '#fee') + ';padding:15px;border-radius:10px;border-left:4px solid ' + (saldo >= risparmi ? '#27ae60' : '#e74c3c') + '">';
  html += '<div style="font-size:0.9em;font-weight:600;margin-bottom:5px">' + (saldo >= risparmi ? '‚úÖ Obiettivo Raggiunto!' : '‚ö†Ô∏è Sotto Obiettivo') + '</div>';
  html += '<div style="font-size:0.85em">Risparmio attuale: <strong>' + formatEuro(saldo) + '</strong></div>';
  html += '</div>';
  
  html += '<button class="btn" onclick="chiudiModal()" style="margin-top:15px">OK</button>';
  
  content.innerHTML = html;
}

function impostaObiettivo() {
  playSound('click');
  mostraToast('üí° Funzione in sviluppo - Potrai impostare obiettivi personalizzati', 'info');
}

function resetAdvancedSearch() {
  document.getElementById('searchDateFrom').value = '';
  document.getElementById('searchDateTo').value = '';
  document.getElementById('searchAmountMin').value = '';
  document.getElementById('searchAmountMax').value = '';
  document.getElementById('sortOrder').value = 'recenti';
  ordinamentoTransazioni = 'recenti';
  mostraTrans();
  playSound('click');
}

function toggleMostraTutte() {
  mostraTutteTransazioni = document.getElementById('showAllTransactions').checked;
  mostraTrans();
  playSound('click');
  
  if (mostraTutteTransazioni) {
    mostraToast('üìã Visualizzazione: tutte le transazioni dell\'anno', 'info');
  } else {
    mostraToast('üìÖ Visualizzazione: solo transazioni mensili', 'info');
  }
}

function cambiaOrdinamento() {
  ordinamentoTransazioni = document.getElementById('sortOrder').value;
  mostraTrans();
  playSound('click');
  
  var messaggi = {
    'recenti': 'üìÖ Ordinate: pi√π recenti (per data)',
    'ultime-inserite': 'üÜï Ordinate: ultime inserite',
    'vecchie': 'üìÖ Ordinate: pi√π vecchie (per data)',
    'a-z': 'üî§ Ordinate: A ‚Üí Z',
    'z-a': 'üî§ Ordinate: Z ‚Üí A',
    'importo-alto': 'üí∞ Ordinate: importo alto ‚Üí basso',
    'importo-basso': 'üí∞ Ordinate: importo basso ‚Üí alto'
  };
  
  mostraToast(messaggi[ordinamentoTransazioni] || 'Ordinamento modificato', 'info');
}

// ========== PREVISIONI ==========
function calcolaPrevisioni() {
  // Calcola media ultimi 3 mesi BASANDOSI SUL MESE SELEZIONATO
  var ultimi3Mesi = [];
  
  // Usa anno/mese dell'app (annoTabelle), NON la data di oggi
  var annoCorrente = annoTabelle || anno;
  var meseCorrente = mese;
  
  for (var i = 1; i <= 3; i++) {
    var m = meseCorrente - i;
    var y = annoCorrente;
    if (m < 0) {
      m += 12;
      y--;
    }
    
    var speseMese = 0;
    DB.transazioni.forEach(function(t) {
      var d = new Date(t.data);
      if (d.getFullYear() === y && d.getMonth() === m) {
        var imp = parseFloat(t.importo) || 0;
        if (t.tipo === 'expense' && !t.virtualRecovery) {
          // Se condiviso, conta solo la tua met√†
          if (t.condiviso) {
            speseMese += splitAmount(imp);
          } else {
            speseMese += imp;
          }
        } else if (t.tipo === 'partner_payment' && !t.virtualRecovery) {
          // Spese di lei: se condiviso met√†, altrimenti tutto (prestito)
          speseMese += t.condiviso ? splitAmount(imp) : imp;
        }
      }
    });
    
    ultimi3Mesi.push(speseMese);
  }
  
  var mediaSpese = ultimi3Mesi.reduce(function(a, b) { return a + b; }, 0) / 3;
  
  // Calcola trend
  var trend = 0;
  var previsioneSpese = mediaSpese;
  
  if (ultimi3Mesi.length === 3 && ultimi3Mesi[2] > 0) {
    trend = ((ultimi3Mesi[0] - ultimi3Mesi[2]) / ultimi3Mesi[2]) * 100;
    previsioneSpese = mediaSpese * (1 + trend / 100);
  }
  
  // Calcola entrate medie
  var entrateUltimi3 = [];
  for (var i = 1; i <= 3; i++) {
    var m = meseCorrente - i;
    var y = annoCorrente;
    if (m < 0) {
      m += 12;
      y--;
    }
    
    var entrateMese = 0;
    DB.transazioni.forEach(function(t) {
      var d = new Date(t.data);
      if (d.getFullYear() === y && d.getMonth() === m && t.tipo === 'income') {
        entrateMese += parseFloat(t.importo) || 0;
      }
    });
    
    entrateUltimi3.push(entrateMese);
  }
  
  var mediaEntrate = entrateUltimi3.reduce(function(a, b) { return a + b; }, 0) / 3;
  var previsioneSaldo = mediaEntrate - previsioneSpese;
  
  document.getElementById('predictedExpense').textContent = formatEuro(previsioneSpese);
  document.getElementById('predictedBalance').textContent = formatEuro(previsioneSaldo);
  
  var trendIcon = trend > 0 ? 'üìà' : 'üìâ';
  var trendColor = trend > 0 ? '#e74c3c' : '#27ae60';
  document.getElementById('predictionTrend').innerHTML = '<span style="color:' + trendColor + '">' + trendIcon + ' ' + (trend > 0 ? '+' : '') + trend.toFixed(1) + '% rispetto a 3 mesi fa</span>';
  
  var saldoIcon = previsioneSaldo >= 0 ? '‚úÖ' : '‚ö†Ô∏è';
  document.getElementById('predictionNote').textContent = saldoIcon + ' Basato su media ultimi 3 mesi';
}

// ========== CONDIVIDI REPORT ==========
function condividiReport() {
  playSound('click');
  
  var mesiNomi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  
  // Calcola dati del mese
  var ent = 0, usc = 0;
  var catSpese = {};
  
  DB.transazioni.forEach(function(t) {
    var d = new Date(t.data);
    if (d.getFullYear() === anno && d.getMonth() === mese) {
      var imp = parseFloat(t.importo) || 0;
      if (t.tipo === 'income') ent += imp;
      else if (t.tipo === 'expense') {
        usc += imp;
        catSpese[t.categoria] = (catSpese[t.categoria] || 0) + imp;
      }
    }
  });
  
  var saldo = ent - usc;
  var topCat = Object.entries(catSpese).sort(function(a,b) { return b[1] - a[1]; }).slice(0, 5);
  
  // Crea report HTML
  var reportHTML = '<div class="report-preview" style="font-family:Arial,sans-serif;color:#000">';
  reportHTML += '<div class="report-header">';
  reportHTML += '<h2 style="color:#2c3e50;margin:0">üí∞ Report Mensile</h2>';
  reportHTML += '<p style="color:#7f8c8d;margin:5px 0">' + mesiNomi[mese] + ' ' + anno + '</p>';
  reportHTML += '</div>';
  
  reportHTML += '<div class="report-section">';
  reportHTML += '<h3 style="color:#27ae60;margin:0 0 10px 0">üìà Entrate: ‚Ç¨' + ent.toFixed(2) + '</h3>';
  reportHTML += '<h3 style="color:#e67e22;margin:0 0 10px 0">üìâ Uscite: ‚Ç¨' + usc.toFixed(2) + '</h3>';
  reportHTML += '<h3 style="color:#3498db;margin:0">üí∞ Saldo: ‚Ç¨' + saldo.toFixed(2) + '</h3>';
  reportHTML += '</div>';
  
  if (topCat.length > 0) {
    reportHTML += '<div class="report-section">';
    reportHTML += '<h4 style="margin:0 0 10px 0">üî• Top 5 Spese</h4>';
    topCat.forEach(function(item, idx) {
      var percent = usc > 0 ? (item[1] / usc * 100).toFixed(1) : 0;
      reportHTML += '<p style="margin:5px 0">' + (idx + 1) + '. ' + item[0] + ': ‚Ç¨' + item[1].toFixed(2) + ' (' + percent + '%)</p>';
    });
    reportHTML += '</div>';
  }
  
  reportHTML += '<p style="text-align:center;color:#95a5a6;font-size:0.9em;margin-top:20px">Generato da Budget Manager Pro</p>';
  reportHTML += '</div>';
  
  // Mostra modal con report
  var modal = document.getElementById('modal');
  modal.classList.add('active');
  
  var content = modal.querySelector('.modal-content');
  content.innerHTML = '<div class="modal-header"><h3>üì§ Condividi Report</h3><button class="close-btn" onclick="chiudiModal()">√ó</button></div>';
  content.innerHTML += reportHTML;
  content.innerHTML += '<button class="btn" onclick="copiaReportHTML()">üìã Copia Report</button>';
  content.innerHTML += '<button class="btn btn-edit" onclick="scaricaReportPDF()">üì• Scarica PDF</button>';
  content.innerHTML += '<button class="btn btn-danger" onclick="chiudiModal()">Chiudi</button>';
  
  window.currentReport = reportHTML;
}

function copiaReportHTML() {
  var tempDiv = document.createElement('div');
  tempDiv.innerHTML = window.currentReport;
  tempDiv.style.position = 'fixed';
  tempDiv.style.left = '-9999px';
  document.body.appendChild(tempDiv);
  
  var range = document.createRange();
  range.selectNode(tempDiv);
  window.getSelection().removeAllRanges();
  window.getSelection().addRange(range);
  
  try {
    document.execCommand('copy');
    mostraToast('‚úÖ Report copiato negli appunti!', 'success');
    playSound('success');
  } catch (e) {
    mostraToast('‚ùå Errore nella copia', 'danger');
    playSound('error');
  }
  
  document.body.removeChild(tempDiv);
  window.getSelection().removeAllRanges();
}

function scaricaReportPDF() {
  mostraToast('üí° Funzione in sviluppo - Usa "Copia Report" e incolla in un editor', 'info');
  playSound('click');
}

// ========== INIZIALIZZAZIONE ==========
try {
  carica();
  applyTheme();
  aggAnni();
  
  var monthSelect = document.getElementById('month');
  if (monthSelect) {
    monthSelect.value = mese;
  }
  
  aggiorna();
  aggiornaBottoniOggi();
  
  // Controllo blocco PIN all'avvio
  if (biometricEnabled && !isAuthenticated) {
    mostraSchermataBlocco();
  }
  
  if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
      if (DB.theme === 'auto') applyTheme();
    });
  }
  
  // Inizializza gesture mobile
  if ('ontouchstart' in window) {
    initPullToRefresh();
  }
} catch (error) {
  // Mostra errore in modo user-friendly
  var errorMsg = 'Errore inizializzazione: ' + (error.message || 'Sconosciuto');
  if (typeof mostraToast === 'function') {
    mostraToast('‚ùå ' + errorMsg, 'error');
  } else {
    alert(errorMsg);
  }
}

// ========== PWA STANDALONE (funziona senza service worker) ==========
// Service Worker rimosso per compatibilit√† con apertura diretta da File

// Mostra prompt di installazione PWA (se disponibile)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredPrompt = e;
  
  // Mostra un banner per installare l'app
  var installBanner = document.createElement('div');
  installBanner.innerHTML = '<div style="position:fixed;bottom:80px;left:15px;right:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;animation:slideUp 0.3s ease-out">' +
    '<div style="display:flex;justify-content:space-between;align-items:center">' +
    '<div style="flex:1"><strong>üì± Installa l\'app</strong><br><span style="font-size:0.85em;opacity:0.9">Aggiungi Budget Manager alla home screen</span></div>' +
    '<button onclick="installPWA()" style="background:#fff;color:#667eea;border:none;padding:10px 20px;border-radius:8px;font-weight:700;cursor:pointer;margin-left:10px">Installa</button>' +
    '<button onclick="this.closest(\'div\').parentElement.remove()" style="background:rgba(255,255,255,0.2);color:#fff;border:none;padding:10px;border-radius:8px;margin-left:8px;cursor:pointer">‚úï</button>' +
    '</div></div>';
  
  // Mostra solo se non √® gi√† installata
  if (!window.matchMedia('(display-mode: standalone)').matches) {
    document.body.appendChild(installBanner);
    
    // Nascondi automaticamente dopo 10 secondi
    setTimeout(function() {
      if (installBanner.parentElement) {
        installBanner.remove();
      }
    }, 10000);
  }
});

window.installPWA = function() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(function(choiceResult) {
      if (choiceResult.outcome === 'accepted') {
      }
      deferredPrompt = null;
      // Rimuovi il banner
      var banner = document.querySelector('div[style*="position:fixed"]');
      if (banner) banner.remove();
    });
  }
};

// Aggiungi stile per l'animazione del banner
var style = document.createElement('style');
style.textContent = '@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }';
document.head.appendChild(style);

</script>

</body>
</html>